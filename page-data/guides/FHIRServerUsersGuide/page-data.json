{"componentChunkName":"component---src-pages-guides-fhir-server-users-guide-md","path":"/guides/FHIRServerUsersGuide/","result":{"pageContext":{"frontmatter":{"layout":"post","title":"IBM FHIR Server User's Guide","description":"IBM FHIR Server User's Guide","Copyright":"years 2017, 2021","lastupdated":"2021-03-10","permalink":"/FHIRServerUsersGuide/"},"relativePagePath":"/guides/FHIRServerUsersGuide.md","titleType":"append","MdxNode":{"id":"0d54daad-353a-57d5-a166-9ccbc2d5cb2b","children":[],"parent":"79342791-3c05-5523-9827-3eb09ff577fd","internal":{"content":"---\nlayout: post\ntitle:  IBM FHIR Server User's Guide\ndescription: IBM FHIR Server User's Guide\nCopyright: years 2017, 2021\nlastupdated: \"2021-03-10\"\npermalink: /FHIRServerUsersGuide/\n---\n\n- [1 Overview](#1-overview)\n- [2 Installation](#2-installation)\n  * [2.1 Installing a new server](#21-installing-a-new-server)\n  * [2.2 Upgrading an existing server](#22-upgrading-an-existing-server)\n  * [2.3 Docker](#23-docker)\n- [3 Configuration](#3-configuration)\n  * [3.1 Liberty server configuration](#31-liberty-server-configuration)\n  * [3.2 FHIR server configuration](#32-fhir-server-configuration)\n  * [3.3 Persistence layer configuration](#33-persistence-layer-configuration)\n- [4 Customization](#4-customization)\n  * [4.1 Extended operations](#41-extended-operations)\n  * [4.2 Notification Service](#42-notification-service)\n  * [4.3 Persistence interceptors](#43-persistence-interceptors)\n  * [4.4 Resource validation](#44-resource-validation)\n  * [4.5 \"Update/Create\" feature](#45-updatecreate-feature)\n  * [4.6 FHIR client API](#46-fhir-client-api)\n  * [4.7 FHIR command-line interface (fhir-cli)](#47-fhir-command-line-interface-fhir-cli)\n  * [4.8 Using local references within request bundles](#48-using-local-references-within-request-bundles)\n  * [4.9 Multi-tenancy](#49-multi-tenancy)\n  * [4.10 Bulk data operations](#410-bulk-data-operations)\n  * [4.11 Audit logging service](#411-audit-logging-service)\n  * [4.12 FHIR REST API](#412-fhir-rest-api)\n- [5 Appendix](#5-appendix)\n  * [5.1 Configuration properties reference](#51-configuration-properties-reference)\n  * [5.2 Keystores, truststores, and the FHIR server](#52-keystores-truststores-and-the-fhir-server)\n  * [5.3 OpenID Connect and OAuth 2.0](#53-openid-connect-and-oauth-20)\n  * [5.4 Custom HTTP Headers](#54-custom-http-headers)\n- [6 Related topics](#6-related-topics)\n\n# 1 Overview\nThe IBM FHIR Server implements the HL7 FHIR HTTP API and supports the full set of FHIR-defined resource types.\nThis FHIR server is intended to be a common component for providing FHIR capabilities within health services and solutions.\n\n# 2 Installation\n\n## 2.1 Installing a new server\n0.  Prereqs: The IBM FHIR Server requires Java 8 or higher and has been tested with OpenJDK 8, OpenJDK 11, and the IBM SDK, Java Technology Edition, Version 8. To install Java on your system, we recommend downloading and installing OpenJDK 8 from https://adoptopenjdk.net/.\n\n1.  To install the IBM FHIR Server, build or download the `fhir-install` zip installer (e.g. `fhir-server-distribution.zip` or `fhir-install-4.0.0-rc1-20191014-1610`).\nThe Maven build creates the zip package under `fhir-install/target`. Alternatively, releases will be made available from the [Releases tab](https://github.com/ibm/fhir/releases).\n\n2.  Unzip the `.zip` package into a clean directory (referred to as `fhir-installer` here):\n    ```\n        mkdir fhir-installer\n        cd fhir-installer\n        unzip fhir-server-distribution.zip\n    ```\n\n3.  Determine an install location for the OpenLiberty server and the IBM FHIR Server webapp. Example:  `/opt/ibm/fhir-server`\n\n4.  Run the `install.sh/.bat` script to install the server:\n    ```\n        ./fhir-server-dist/install.sh /opt/ibm/fhir-server\n    ```\n    This step installs the OpenLiberty runtime and the IBM FHIR Server web application. The Liberty runtime is installed in a directory called `wlp` within the installation directory that you specify. For example, in the preceding command, the root directory of the Liberty server runtime would be `/opt/ibm/fhir-server/wlp`.\n\n5.  Configure the fhir-server's `server.xml` file as needed by completing the following steps:\n    * Configure the ports that the server listen on. The server is installed with only port 9443 (HTTPS) enabled by default. To change the port numbers, modify the values in the `httpEndpoint` element.\n    * Configure a server keystore and truststore. The IBM FHIR Server is installed with a default keystore file that contains a single self-signed certificate for localhost. For production use, you must create and configure your own keystore and truststore files for the FHIR server deployment (that is, generate your own server certificate or obtain a trusted certificate, and then share the public key certificate with API consumers so that they can insert it into their client-side truststore). The keystore and truststore files are used along with the server's HTTPS endpoint and the FHIR server's client-certificate-based authentication protocol to secure the FHIR server's endpoint. For more information, see [Section 5.2 Keystores, truststores, and the FHIR server](#52-keystores-truststores-and-the-fhir-server).\n    * Configure an appropriate user registry. The FHIR server is installed with a basic user registry that contains a single user named `fhiruser`. For production use, it's best to configure your own user registry. For more information about configuring user registries, see the [OpenLiberty documentation](https://openliberty.io/guides/security-intro.html#configuring-the-user-registry).\n\n    To override the default fhiruser's password, one may set an Environment variable `FHIR_USER_PASSWORD` and for the fhiradmin's password one may set an Environment variable `FHIR_ADMIN_PASSWORD`.\n\n6.  Make sure that your selected database product is running and ready to accept requests as needed:\n    * By default, the FHIR server is installed with the JDBC persistence layer configured to use an Embedded Derby database. When using the `ibmcom/ibm-fhir-server` docker image, set the `BOOTSTRAP_DB` environment variable to `true` in order to bootstrap this database. For any other configuration, note the database host and port and, if necessary, create a user with privileges for deploying the schema.\n\n7.  Create and deploy the IBM FHIR Server database schema as needed:\n    * By default, the FHIR server is installed with the JDBC persistence layer configured to use an Embedded Derby database. When using the `ibmcom/ibm-fhir-server` docker image, set the `BOOTSTRAP_DB` environment variable to `true` in order to bootstrap this database. For any other configuration, use the `fhir-persistence-schema` module to create and deploy the database schema.\n    * The Db2 persistence layer is always tenant-aware, so you must provision a tenant in addition to deploying the schema. Note the tenant name you provisioned and the tenantKey generated by `fhir-persistence-schema` for the next step.\n\n8.  Configure the `fhir-server-config.json`<sup id=\"a1\">[1](#f1)</sup> configuration file as needed:\n    * By default, the FHIR server is installed with the JDBC persistence layer configured to use a single-tenant Embedded Derby database. For more information, see [Section 3.3 Persistence layer configuration](#33-persistence-layer-configuration).\n\n9.  To start and stop the server, use the Liberty server command:\n```\n    <WLP_HOME>/bin/server start fhir-server\n    <WLP_HOME>/bin/server stop fhir-server\n```\n\n9.  After you start the server, you can verify that it's running properly by invoking the `$healthcheck` endpoint like this:\n```\n    curl -k -u '<username>:<password>' 'https://<host>:<port>/fhir-server/api/v4/$healthcheck'\n```\n    where `<username>` is one of the users configured in `server.xml` (default is `fhiruser`).  \n    Use single quotes around the URL to prevent $healthcheck from being evaluated as an environment variable on unix-based operating systems.  \n\n    One should see `All OK` in the response.  The preceding command should produce output similar to the following:\n```\n    {\n    \"resourceType\": \"OperationOutcome\",\n    \"issue\": [\n        {\n            \"severity\": \"information\",\n            \"code\": \"informational\",\n            \"details\": {\n                \"text\": \"All OK\"\n            }\n        }\n    ]\n    }\n```\n\nFor more information about the capabilities of the implementation, see [Conformance](https://ibm.github.io/FHIR/Conformance).\n\n## 2.2 Upgrading an existing server\nThe IBM FHIR Server does not include an upgrade installer. To upgrade a server to the next version, install the new version to a separate location and copy the configuration files from your existing installation (reconciling any configuration-related changes from the new release in the process).\n\nTo manage database updates over time, the IBM FHIR Server uses custom tools from the `fhir-database-utils` project. Through the use of a metadata table, the database utilities can detect the currently installed version of the database schema and apply any new changes that are needed to bring the database to the current level.\n\nComplete the following steps to upgrade the server:\n\n1. Run the fhir-installer on a separate server.\n2. Configure the new server as appropriate (`fhir-server/server.xml` and anything under the `fhir-server/configDropins`, `fhir-server/config`, and `fhir-server/userlib` directories).\n3. Back up your database.  \n4. Run the migration program (see [Section 3.3.1.1 Supported databases](#3311-supported-databases)).  \n5. Disable traffic to the old server and enable traffic to the new server.\n\n## 2.3 Docker\nThe IBM FHIR Server includes a Docker image [ibmcom/ibm-fhir-server](https://hub.docker.com/r/ibmcom/ibm-fhir-server).\n\nNote, logging for the IBM FHIR Server docker image is to stderr and stdout, and is picked up by Logging agents.\n\nThe IBM FHIR Server is configured using Environment variables using:\n\n| Environment Variable | Description |\n|----------------------|-------------|\n|`DISABLED_OPERATIONS`|A comma-separated list of operations which are disabled on the IBM FHIR Server, for example, `validate,import`. Note, do not include the dollar sign `$`|\n\n# 3 Configuration\nThis chapter contains information about the various ways in which the IBM FHIR Server can be configured by users.\n\n## 3.1 Liberty server configuration\nThe IBM FHIR Server is built on the open source [OpenLiberty project](https://openliberty.io/) but also works on the commercial [IBM WebSphere Liberty](https://www.ibm.com/cloud/websphere-liberty). In documentation and elsewhere, we use `Liberty` to refer to either/or.\n\nAs a Liberty application, the IBM FHIR Server is configurable like any other Liberty server. See https://openliberty.io/docs/latest/reference/config/server-configuration-overview.html for more information.\n\nBy default, we include:\n* `server.xml` with core server details like the Liberty features, HTTP properties, application info, and a default user registry\n* `jvm.options` with TLS and heap size settings\n* `server.env` with timezone set to UTC\n* `configDropins` with server.xml dropins sorted into `disabled`, `defaults`, and `overrides`\n\n## 3.1.1 Encoded passwords\nIn the examples within the following sections, you'll see the default password `change-password`. In order to secure your server, these values should be changed.\n\nOptionally, the values can be encoded via the Liberty `securityUtility` command. For example, to encode a string value with the default `{xor}` encoding, run the following command:\n```\n<WLP_HOME>/bin/securityUtility encode stringToEncode\n```\n\nThe output of this command can then be copied and pasted into your `server.xml` or `fhir-server-config.json` file as needed. The `fhir-server-config.json` does not support the securityUtility's `{aes}` encoding at this time, but per the limits to protection through password encryption<sup>[a]</sup>, this encoding does not provide significant additional security beyond `exclusive or` (XOR) encoding.\n\n## 3.2 FHIR server configuration\n\n### 3.2.1 Property names\nConfiguration properties stored within a `fhir-server-config.json` file are structured in a hierarchical manner. Here is an example:\n\n```\n    {\n        \"fhirServer\":{\n            \"core\":{\n                \"defaultPrettyPrint\":false\n            }\n        }\n    }\n```\n\nThroughout this document, we use a path notation to refer to property names. For example, the name of the `defaultPrettyPrint` property in the preceding example would be `fhirServer/core/defaultPrettyPrint`.\n\n### 3.2.2 Tenant-specific configuration properties\nThe IBM FHIR server supports certain multi-tenant features. One such feature is the ability to set certain configuration properties on a per-tenant basis.\n\nIn general, the configuration properties for a particular tenant are stored in the `<WLP_HOME>/usr/servers/fhir-server/config/<tenant-id>/fhir-server-config.json` file, where `<tenant-id>` refers to the tenant's “short name” or tenant id.\n\nThe global configuration is considered to be associated with a tenant named `default`, so those properties are stored in the `<WLP_HOME>/usr/servers/fhir-server/config/default/fhir-server-config.json` file.\n\nSimilarly, tenant-specific search parameters are found at `<WLP_HOME>/usr/servers/fhir-server/config/<tenant-id>/extension-search-parameters.json`, whereas the global/default extension search parameters are at `<WLP_HOME>/usr/servers/fhir-server/config/default/extension-search-parameters.json`.\n\nSearch parameters are handled like a single configuration properly; providing a tenant-specific file will override the global/default extension search parameters as defined at [FHIRSearchConfiguration](https://ibm.github.io/FHIR/guides/FHIRSearchConfiguration).\n\nMore information about multi-tenant support can be found in [Section 4.9 Multi-tenancy](#49-multi-tenancy).\n\n### 3.2.3 Compartment Search Performance\n\nThe IBM FHIR Server supports the ability to compute and store compartment membership values during ingestion. Once stored, these values can help accelerate compartment-related search queries. To use this feature, update the IBM FHIR Server to at least version 4.5.1 and run a reindex operation as described in the [fhir-bucket](https://github.com/IBM/FHIR/tree/main/fhir-bucket) project [README](https://github.com/IBM/FHIR/blob/main/fhir-bucket/README.md). The reindex operation reprocesses the resources stored in the database, computing and storing the new compartment reference values. After the reindex operation has completed, add the `useStoredCompartmentParam` configuration element to the relevant tenant fhir-server-config.json file to allow the search queries to use the pre-computed values:\n\n```\n    {\n        \"fhirServer\": {\n            \"search\": {\n                \"useStoredCompartmentParam\": true\n            }\n        }\n    }\n```\nNote that this parameter only enables or disables the compartment search query optimization feature. The compartment membership values are always computed and stored during ingestion or reindexing, regardless of the setting of this value. After the reindex operation is complete, it is recommended to set `useStoredCompartmentParam` to true. No reindex is required if this value is subsequently set to false.\n\n## 3.3 Persistence layer configuration\nThe IBM FHIR Server allows deployers to select a persistence layer implementation that fits their needs. Currently, the server includes a JDBC persistence layer which supports Apache Derby, IBM Db2, and PostgreSQL.  However, Apache Derby is not recommended for production usage.\n\nBefore you can configure the server to use the JDBC persistence layer implementation, you first need to prepare the database. This step depends on the database product in use and is covered in more detail in [Section 3.3.1.1 Supported databases](#3311-supported-databases).\n\nThe IBM FHIR Server is delivered with a default configuration that is already configured to use the JDBC persistence layer implementation with an Embedded Derby database. This provides the easiest out-of-the-box experience since it requires very little setup.\n\nThe IBM FHIR Server persistence configuration is split between `fhir-server-config.json` and the Liberty `server.xml + configDropins`.\n\nWithin `fhir-server-config.json`, the value of the `fhirServer/persistence/factoryClassname` is used to instantiate a FHIRPersistence object. By default, the server is configured to use the FHIRPersistenceJDBCFactory:\n```\n    {\n        \"fhirServer\": {\n            …\n            \"persistence\": {\n                \"factoryClassname\": \"com.ibm.fhir.persistence.jdbc.FHIRPersistenceJDBCFactory\",\n                …\n            }\n    }\n```\n\n### 3.3.1 The JDBC persistence layer\nWhen the FHIRPersistenceJDBCFactory is in use, the `fhirServer/persistence/datasources` property must specify a mapping from datastore-id values to Liberty datasource definitions. For example, here is the configuration for a datastore with id `default` that is configured for the `jdbc/fhir_default_default` datasource of type `postgresql`:\n```\n{\n    \"fhirServer\":{\n        \"persistence\":{\n            \"factoryClassname\":\"com.ibm.fhir.persistence.jdbc.FHIRPersistenceJDBCFactory\",\n            \"datasources\": {\n                \"default\": {\n                    \"type\": \"postgresql\",\n                    \"currentSchema\": \"fhirdata\",\n                    \"jndiName\": \"jdbc/fhir_default_default\"\n                }\n            }\n        }\n    }\n}\n```\n\nBoth the `type` and the `currentSchema` properties are required.\nThe `type` value must be set to one of the supported JDBC types (currently `db2`, `postgresql`, or `derby`) and it must match the actual database type referenced by the datasource definition. If the type does not match, the behavior is undefined.\nBecause the IBM FHIR Server does not quote the schema name in our generated queries, the `currentSchema` property is effectively case-insensitive.\n\nThe `jndiName` property is optional; it will default to `jdbc/fhir_<tenantId>_<dsId>` where `<tenantId>` and `<dsId>` represent the tenant and datastore ids respectively<sup id=\"a4\">[4](#f4)</sup>.\n\nThe datasource definitions themselves are configured in accordance with the [Liberty documentation on Relational database connections with JDBC](https://openliberty.io/docs/latest/relational-database-connections-JDBC.html). Previous versions of the IBM FHIR Server supported a proxy datasource that allowed for datasource definitions in the fhir-server-config.json, but Liberty JDBC datasource configuration is now the preferred approach due to benefits related to configuring pool sizes, transaction recovery, and monitoring.\n\nFor example, the fhir-server-config snippet from above would have a corresponding Liberty config like this:\n```xml\n<server>\n    <!-- ============================================================== -->\n    <!-- TENANT: default; DSID: default; TYPE: read-write               -->\n    <!-- ============================================================== -->\n    <dataSource id=\"fhirDefaultDefault\" jndiName=\"jdbc/fhir_default_default\" type=\"javax.sql.XADataSource\" statementCacheSize=\"200\" syncQueryTimeoutWithTransactionTimeout=\"true\" validationTimeout=\"30s\">\n        <jdbcDriver javax.sql.XADataSource=\"org.postgresql.xa.PGXADataSource\" libraryRef=\"sharedLibPostgres\"/>\n        <properties.postgresql\n             serverName=\"postgres_postgres_1\"\n             portNumber=\"5432\"\n             databaseName=\"fhirdb\"\n             user=\"fhirserver\"\n             password=\"change-password\"\n             currentSchema=\"fhirdata\"\n         />\n        <connectionManager maxPoolSize=\"200\" minPoolSize=\"40\"/>\n    </dataSource>\n</server>\n```\n\nDatasource elements should not be defined in the main `server.xml` file but instead should be defined in the `configDropins/overrides` directory. See the [Liberty Profile Server configuration guide](https://openliberty.io/docs/latest/reference/config/server-configuration-overview.html) for more details and general guidance on creating modular configurations.\n\nThe IBM FHIR Server is packaged with the following sample datasource definitions at `configDropins/disabled`:\n* datasource-postgresql.xml\n* datasource-db2.xml\n* datasource-derby.xml\n\nThere are 3 libraries defined in the main `server.xml` that reference the required client drivers for each database type:\n* sharedLibDerby\n* sharedLibDb2\n* sharedLibPostgres\n\nWhen a datasource definition is included in a configDropin under `configDropins/overrides`, this file is picked up when the server starts as indicated by the following AUDIT message:\n\n```\n[AUDIT   ] CWWKG0093A: Processing configuration drop-ins resource: <WLP_HOME>/usr/servers/fhir-server/configDropins/overrides/datasource.xml\n```\n\nThe IBM FHIR Server will look up the tenant and datastore id for each request and use the corresponding JNDI name to obtain a connection for the corresponding datasource.\n\n#### 3.3.1.1 Supported databases\n##### Embedded Derby (default)\nIf you are using the `ibmcom/ibm-fhir-server` docker image, you can ask the entrypoint script to create (bootstrap) the database and the schema during startup by setting the `BOOTSTRAP_DB` environment variable to `true`.\n\nThis database bootstrap step is only supported for Embedded Derby and will only bootstrap the default datastore of the default tenant (the default for requests with no tenant or datastore headers).\nReminder:  the Embedded Derby support is designed to support simple getting started scenarios and is not recommended for production use.\n\n```\n<server>\n    <!-- ============================================================== -->\n    <!-- This datasource aligns with the Apache Derby database that is  -->\n    <!-- created by the IBM FHIR Server's DB_BOOTSTRAP process.         -->\n    <!-- ============================================================== -->\n    <dataSource id=\"fhirDefaultDefault\" jndiName=\"jdbc/fhir_default_default\" type=\"javax.sql.XADataSource\" statementCacheSize=\"200\" syncQueryTimeoutWithTransactionTimeout=\"true\" validationTimeout=\"30s\">\n        <jdbcDriver javax.sql.XADataSource=\"org.apache.derby.jdbc.EmbeddedXADataSource\" libraryRef=\"sharedLibDerby\"/>\n        <properties.derby.embedded createDatabase=\"create\" databaseName=\"derby/fhirDB\"/>\n        <connectionManager maxPoolSize=\"50\" minPoolSize=\"10\"/>\n    </dataSource>\n</server>\n```\n\n##### Db2\nIf you configure the FHIR server to use an IBM Db2 database, you must:\n\n1. Create the database if it doesn't already exist.\n\n2. Execute the `fhir-persistence-schema` utility to create the necessary schemas (tables, indices, stored procedures, etc) and tenants.\n\n3. Configure the IBM FHIR Server with the tenantKey generated in step number 2.\n\nAn executable `fhir-persistence-schema` jar can be downloaded from the project's [Releases tab](https://github.com/IBM/FHIR/releases) and documentation can be found at https://github.com/IBM/FHIR/tree/main/fhir-persistence-schema.\n\nFor a detailed guide on configuring IBM Db2 on Cloud for the IBM FHIR Server, see [DB2OnCloudSetup](https://ibm.github.io/FHIR/guides/DB2OnCloudSetup).\n\nSince release 4.3.2 you can use the `search.reopt` query optimizer hint to improve the performance of certain search queries involving multiple search parameters. This optimization is currently only available for Db2. Valid values are \"ALWAYS\" and \"ONCE\". See Db2 documentation for `REOPT` for more details.\n\n##### PostgreSQL\nIf you configure the FHIR server to use a PostgreSQL database, you must:\n\n1. create the database if it doesn't already exist\n\n2. execute the `fhir-persistence-schema` utility with a db-type of `postgresql` to create the necessary schemas (tables, indices, functions, etc)\n\nAn executable `fhir-persistence-schema` jar can be downloaded from the project's [Releases tab](https://github.com/IBM/FHIR/releases) and documentation can be found at https://github.com/IBM/FHIR/tree/main/fhir-persistence-schema.\n\nSince release 4.5.5 you can set the `searchOptimizerOptions/from_collapse_limit` and `searchOptimizerOptions/join_collapse_limit` properties to improve the performance of certain search queries involving multiple search parameters. This optimization is currently only available for PostgreSQL.\n\n##### Other\n\nTo enable the IBM FHIR Server to work with other relational database systems, see\nhttps://ibm.github.io/FHIR/guides/BringYourOwnPersistence#adding-support-for-another-relational-database\n\n\n#### 3.3.1.2 Datastore configuration examples\nTo understand how the configuration properties are defined for one or more datastores, let's start off with a couple of examples.\n\n##### Example 1\nHere is a simple example of a single (default) Derby datastore.\n\n**config/default/fhir-server-config.json**\n```json\n{\n    \"fhirServer\":{\n        …\n        \"persistence\":{\n            \"factoryClassname\":\"com.ibm.fhir.persistence.jdbc.FHIRPersistenceJDBCFactory\",\n            \"datasources\": {\n                \"default\": {\n                    \"type\": \"derby\",\n                    \"currentSchema\": \"APP\"\n                }\n            }\n        }\n    }\n}\n```\n\n**configDropins/overrides/datasource-derby.xml**\n```xml\n<server>\n    <library id=\"fhirSharedLib\">\n        <fileset dir=\"${shared.resource.dir}/lib/derby\" includes=\"*.jar\"/>\n    </library>\n\n    <!-- ============================================================== -->\n    <!-- TENANT: default; DSID: default; TYPE: read-write               -->\n    <!-- ============================================================== -->\n    <dataSource id=\"fhirDefaultDefault\" jndiName=\"jdbc/fhir_default_default\" type=\"javax.sql.XADataSource\" statementCacheSize=\"200\" syncQueryTimeoutWithTransactionTimeout=\"true\" validationTimeout=\"30s\">\n        <jdbcDriver javax.sql.XADataSource=\"org.apache.derby.jdbc.EmbeddedXADataSource\" libraryRef=\"sharedLibDerby\"/>\n        <properties.derby.embedded createDatabase=\"create\" databaseName=\"derby/fhirDB\"/>\n        <connectionManager maxPoolSize=\"50\" minPoolSize=\"10\"/>\n    </dataSource>\n</server>\n```\n\nIn this example, we define an embedded Derby database named `derby/fhirDB` (a location relative to the `<WLP_HOME>/usr/servers/fhir-server` directory). The datastore-id associated with this datastore is `default`, which is the value that is used if no `X-FHIR-DSID` request header is found in the incoming request. So, when only a single database is being used, it's wise to leverage the `default` datastore-id value to allow REST API consumers to avoid having to set the `X-FHIR-DSID` request header on each request.\n\n##### Example 2\nThis example shows a slightly more complex scenario. In this scenario, the `acme` tenant would like to store data in one of two study-specific Db2 databases with datastore-id values `study1` and `study2`.\n\nFurthermore, the REST API consumers associated with Acme applications will be coded to always set the `X-FHIR-TENANT-ID` request header to be `acme` and the `X-FHIR-DSID` request header to the specific datastore-id associated with each request (either `study1` or `study2`). In this case, the following properties would be configured:\n\n**config/acme/fhir-server-config.json**\n```json\n{\n    \"__comment\":\"Acme's FHIR server configuration\",\n    \"fhirServer\":{\n        …\n        \"persistence\":{\n            \"factoryClassname\":\"com.ibm.fhir.persistence.jdbc.FHIRPersistenceJDBCFactory\",\n            \"datasources\": {\n                \"study1\": {\n                    \"tenantKey\": \"<the-tenant-key>\",\n                    \"type\": \"db2\",\n                    \"currentSchema\": \"DB2INST1\"\n                },\n                \"study2\": {\n                    \"tenantKey\": \"<the-tenant-key>\",\n                    \"type\": \"db2\",\n                    \"currentSchema\": \"DB2INST1\"\n                }\n            }\n        }\n    }\n}\n```\n\n**configDropins/overrides/datasources-acme.xml**\n```xml\n<server>\n    <library id=\"fhirSharedLib\">\n        <fileset dir=\"${shared.resource.dir}/lib/db2\" includes=\"*.jar\"/>\n    </library>\n\n    <!-- ============================================================== -->\n    <!-- TENANT: acme; DSID: study1; TYPE: read-write                   -->\n    <!-- ============================================================== -->\n    <dataSource id=\"fhirDefaultDefault\" jndiName=\"jdbc/fhir_acme_study1\" type=\"javax.sql.XADataSource\" statementCacheSize=\"200\" syncQueryTimeoutWithTransactionTimeout=\"true\" validationTimeout=\"30s\">\n        <jdbcDriver javax.sql.XADataSource=\"com.ibm.db2.jcc.DB2XADataSource\" libraryRef=\"sharedLibDb2\"/>\n        <properties.db2.jcc\n            serverName=\"dbserver1\"\n            portNumber=\"50000\"\n            user=\"db2inst1\"\n            password=\"change-password\"\n            databaseName=\"ACMESTUDY1\"\n            currentSchema=\"DB2INST1\"\n            driverType=\"4\"\n         />\n        <connectionManager maxPoolSize=\"200\" minPoolSize=\"40\"/>\n    </dataSource>\n\n    <!-- ============================================================== -->\n    <!-- TENANT: acme; DSID: study2; TYPE: read-write                   -->\n    <!-- ============================================================== -->\n    <dataSource id=\"fhirDefaultDefault\" jndiName=\"jdbc/fhir_acme_study2\" type=\"javax.sql.XADataSource\" statementCacheSize=\"200\" syncQueryTimeoutWithTransactionTimeout=\"true\" validationTimeout=\"30s\">\n        <jdbcDriver javax.sql.XADataSource=\"com.ibm.db2.jcc.DB2XADataSource\" libraryRef=\"sharedLibDb2\"/>\n        <properties.db2.jcc\n            serverName=\"dbserver1\"\n            portNumber=\"50000\"\n            user=\"db2inst1\"\n            password=\"change-password\"\n            databaseName=\"ACMESTUDY2\"\n            currentSchema=\"DB2INST1\"\n            driverType=\"4\"\n         />\n        <connectionManager maxPoolSize=\"200\" minPoolSize=\"40\"/>\n    </dataSource>\n</server>\n```\n\nNote that because this example is using the default FHIR server naming scheme for datasource JNDI names, there is no need to include the 'jndiName' property in the fhir-server-config.json, although you can specify it should you wish to make the mapping clear.\n\nAdditionally, note that each datasource definition in the configDropin gets its own connection pool with properties defined by the 'connectionManager' element.\n\n#### 3.3.1.3 Database Access TransactionManager Timeout\nThe TransactionManager controls the timeout of database queries.  \n\nTo modify the default transaction timeout value, set the environment variable `FHIR_TRANSACTION_MANAGER_TIMEOUT` or enter the value in the server.env file at the root of the WLP fhir-server instance. Example values are `120s` (seconds) or `2m` (minutes).\n\n# 4 Customization\nYou can modify the default server implementation by taking advantage of the IBM FHIR server's extensibility. The following extension points are available:\n * Custom operations framework:  The IBM FHIR Server defines an operations framework that builds on the FHIR OperationDefinition resource in order to extend the FHIR REST API with custom endpoints.\n * Pluggable audit service:  Logging and auditing options including Cloud Auditing Data Federation (CADF) over Apache Kafka.\n * Persistence interceptors:  Intercept requests before and/or after each persistence action.\n * Resource validation:  FHIRPath-based validation of FHIR resources on create or update with the ability to extend the system with custom constraints.\n\n## 4.1 Extended operations\nIn addition to the standard REST API (create, update, search, and so forth), the IBM FHIR Server supports the FHIR operations framework as described in the [FHIR specification]( https://www.hl7.org/fhir/r4/operations.html).\n\n### 4.1.1 Packaged operations\nThe FHIR team provides implementations for the standard `$validate` and `$document` operations, as well as a custom operation named `$healthcheck`, which queries the configured persistence layer to report its health.\n\nNo other extended operations are packaged with the server at this time, but you can extend the server with your own operations.\n\n#### 4.1.1.1 $validate\nThe `$validate` operation checks whether the attached content would be acceptable either generally, or as a create, update, or delete against an existing resource instance or type.\n\nhttps://www.hl7.org/fhir/r4/resource-operations.html#validate\n\n#### 4.1.1.2 $document\nThe `$document` operation generates a fully bundled document from a composition resource.\n\nhttps://www.hl7.org/fhir/r4/composition-operations.html#document\n\n#### 4.1.1.3 $healthcheck\nThe `$healthcheck` operation returns the health of the FHIR server and its datastore. In the default JDBC persistence layer, this operation creates a connection to the configured database and return its status. The operations returns `200 OK` when healthy. Otherwise, it returns an HTTP error code and an `OperationOutcome` with one or more issues.\n\n### 4.1.2 Custom operations\nIn addition to the provided operations, the FHIR server supports user-provided custom operations through a Java Service Provider Interface (SPI).\n\nTo contribute an operation:\n1. Implement each operation as a Java class that extends `com.ibm.fhir.operation.AbstractOperation` from `fhir-operation.jar`. Ensure that your implementation returns an appropriate `OperationDefinition` in its `getDefinition()` method, because the framework validates both the request and response payloads to ensure that they conform to the definition.\n\n2. Create a file named `com.ibm.fhir.operation.FHIROperation` with one or more fully qualified `FHIROperation` classnames and package it in your jar under `META-INF/services/`.\n\n3. Include your jar file under the `<WLP_HOME>/usr/servers/fhir-server/userlib/` directory of your installation.\n\n4. Restart the FHIR server. Changes to custom operations require a server restart, because the server discovers and instantiates operations during server startup only.\n\nAfter you register your operation with the server, it is available via HTTP POST at `[base]/api/1/$<yourCode>`, where `<yourCode>` is the value of your OperationDefinition's [code](https://www.hl7.org/fhir/r4/operationdefinition-definitions.html#OperationDefinition.code).\n\n## 4.2 Notification Service\nThe FHIR server provides a notification service that publishes notifications about persistence events, specifically _create_, _update_, and _delete_ operations. The notification service can be used by other Healthcare components to trigger specific actions that need to occur as resources are being updated in the FHIR server datastore.\n\nThe notification service supports two implementations: WebSocket and Kafka.\n\n### 4.2.1 FHIRNotificationEvent\nThe `FHIRNotificationEvent` class defines the information that is published by the notification service. Each notification event published to the WebSocket or Kafka topic is an instance of `FHIRNotificationEvent`, serialized as a JSON object. This JSON object will have the following fields:\n\nField name     | Type   | Description\n|--------------| -----  | ------------|\n`operationType`| String | The operation associated with the notification event. Valid values are _create_ and _update_.\n`location`     | String | The location URI of the resource associated with the notification event. To retrieve this resource, invoke a GET request using the location URI value as the URL string.\n`lastUpdated`  | String | The date and time of the last update made to the resource associated with the notification event.\n`resourceId`   | String | The logical id of the resource associated with the notification event.\n`resource`     | String | A stringified JSON object which is the resource associated with the notification event.\n\nThe following JSON is an example of a serialized notification event:\n```\n{\n  \"lastUpdated\":\"2016-06-01T10:36:23.232-05:00\",\n  \"location\":\"Observation/3859/_history/1\",\n  \"operationType\":\"create\",\n  \"resourceId\":\"3859\",\n  \"resource\":{ …<contents of resource>… }\n}\n```\n\n### 4.2.2 WebSocket\nThe WebSocket implementation of the notification service will publish notification event messages to a WebSocket. To enable WebSocket notifications, set the `fhirServer/notifications/websocket/enabled` property to `true`, as in the following example:\n\n```\n{\n    \"fhirServer\":{\n        …\n        \"notifications\":{\n            …\n            \"websocket\":{\n                \"enabled\":true\n            }\n        …\n    }\n}\n```\n\nThe WebSocket location URI is `ws://<host>:<port>/fhir-server/api/v4/notification`, where `<host>` and `<port>` represent the host and port of the FHIR server's REST API endpoint. So for example, if the FHIR server endpoint's base URL is `https://localhost:9443/fhir-server/api/v4` then the corresponding location of the WebSocket would be `ws://localhost:9443/fhir-server/api/v4/notification`.\n\n### 4.2.3 Kafka\nThe Kafka implementation of the notification service will publish notification event messages to a Kafka topic. To configure the Kafka notification publisher, configure properties in the `fhir-server-config.json` file as indicatesd in the following example:\n\n```\n{\n    \"fhirServer\":{\n        …\n        \"notifications\":{\n            …\n            \"kafka\":{\n                \"enabled\":true,\n                \"topicName\":\"fhirNotifications\",\n                \"connectionProperties\":{\n                    \"group.id\":\"securing-kafka-group\",\n                    \"bootstrap.servers\":\"localhost:9093\",\n                    \"security.protocol\":\"SSL\",\n                    \"ssl.truststore.location\":\"resources/security/kafka.client.truststore.jks\",\n                    \"ssl.truststore.password\":\"change-password\",\n                    \"ssl.keystore.location\":\"resources/security/kafka.client.keystore.jks\",\n                    \"ssl.keystore.password\":\"change-password\",\n                    \"ssl.key.password\":\"change-password\",\n                    \"ssl.truststore.type\":\"JKS\",\n                    \"ssl.keystore.type\":\"JKS\"\n                }\n            }\n        …\n    }\n}\n```\n\nThe `fhirServer/notifications/kafka/enabled` property is used to enable or disable the Kafka publisher component.\n\nThe `fhirServer/notifications/kafka/topicName` property is used to configure the appropriate topic name to which the notification events should be published.\n\nThe `fhirServer/notifications/kafka/connectionProperties` property group is used to configure the properties necessary to successfully connect to the Kafka server. You can specify an arbitrary `group.id`. The `bootstrap.servers` property is required, but the rest are optional, although if your Kafka server is configured to require an SSL connection and client authentication, then the remaining properties must also be set. For more details about Kafka-related properties, see the Kafka documentation.\n\nIn the `connectionProperties` property group in preceding example, you'll notice that the password-related properties have encoded values. To store a value requiring security (such as a password), you can use Liberty's `securityUtility` command to encode the value. See [Section 3.1 Encoded passwords](#31-encoded-passwords) for details.\n\nBefore you enable Kafka notifications, it's important to understand the topology of the environment in which the FHIR server instance will be running. Your topic name selection should be done in consideration of the topology. If you have multiple instances of the FHIR server clustered together to form a single logical endpoint, then each of those instances should be configured to use the same Kafka topic for notifications. This is so that notification consumers (subscribers) can subscribe to a single topic and receive all the notifications published by each of the FHIR server instances within the cluster.\n\nOn the other hand, if you have two completely independent FHIR server instances, then you should configure each one with its own topic name.\n\n### 4.2.3 NATS\nThe [NATS](http://nats.io) implementation of the notification service publishes notification event messages to a NATS streaming cluster. To configure the NATS notification publisher, configure properties in the `fhir-server-config.json` file as shown in the following example:\n\n```\n{\n    \"fhirServer\":{\n        ...\n        \"notifications\":{\n            ...\n            \"nats\": {\n\t\t        \"enabled\": true,\n\t\t        \"cluster\": \"nats-streaming\",\n\t\t        \"channel\": \"fhirNotifications\",\n\t\t        \"clientId\": \"fhir-server\",\n\t\t        \"servers\": \"nats://nats-node1:4222,nats://nats-node2:4222,nats://nats-node3:4222\",\n\t\t        \"useTLS\": true,\n\t\t        \"truststoreLocation\": \"resources/security/nats.client.truststore.p12\",\n\t\t        \"truststorePassword\": \"change-password\",\n\t\t        \"keystoreLocation\": \"resources/security/nats.client.keystore.p12\",\n\t\t        \"keystorePassword\": \"change-password\"\n    }\n        ...\n    }\n}\n```\n\nSet the `fhirServer/notifications/nats/enabled` property to true and provide the name of your NATS cluster for the value of `fhirServer/notifications/nats/cluster`.  You may leave `fhirServer/notifications/nats/channel` and `fhirServer/notifications/nats/clientId` as defined.  Provide the URL for one or more NATS servers as the value for `fhirServer/notifications/nats/servers`.\n\nTo use TLS to connect to your NATS cluster, set `fhirServer/notifications/nats/useTLS` to true and provide client truststore and keystore locations and passwords as the remaining config values. Ensure that your NATS cluster is configured for TLS client connections.\n\nTo store a value requiring security, such as a password, use Liberty's `securityUtility` command to encode the value. See Section 3.1 Encoded passwords for details.\n\n### 4.2.4 Resource type filtering\nBy default, notification messages are published for all _create_ and _update_ persistence operations. However, the FHIR server allows you to configure a list of resource types for which notification events will be published. To do this, list the resource types for which you want to generate notifications in an array of strings within the  `fhirServer/notifications/common/includeResourceTypes` property in the `fhir-server-config.json` file, as in the following example:\n\n```\n{\n    \"fhirServer\":{\n        …\n        \"notifications\":{\n            …\n            \"common\":{\n                \"includeResourceTypes\":[\n                     \"Observation\",\n                     \"Patient\"\n                ]\n            },\n        …\n    }\n}\n```\n\nWith the `includeResourceTypes`property set as in the preceding example, the FHIR server publishes notification events only for `Patient` and `Observation` resources. If you omit this property or set its value to `[]` (an empty array), then the FHIR server publishes notifications for all resource types.\n\n## 4.3 Persistence interceptors\nThe FHIR server supports a persistence interceptor feature that enables users to add their own logic to the REST API processing flow around persistence events. This could be used to enforce application-specific business rules associated with resources. Interceptor methods can be called immediately before or after _create_ and _update_ persistence operations.\n\n### 4.3.1 FHIRPersistenceInterceptor interface\nA persistence interceptor implementation must implement the `com.ibm.fhir.persistence.interceptor.FHIRPersistenceInterceptor`\ninterface.\n\nEach interceptor method receives a parameter of type `FHIRPersistenceEvent`, which contains context information related to the request being processed at the time that the interceptor method is invoked. It includes the FHIR resource, security information, request URI information, and the collection of HTTP headers associated with the request.\n\nThere are two primary use cases for persistence interceptors:\n\n1.  Enforce certain application-specific governance rules, such as making sure that a patient has signed a consent form prior to allowing his/her data to be stored in the FHIR server's datastore. In this case, the `beforeCreate` or `beforeUpdate` interceptor methods could verify that the patient has a consent agreement on file, and if not then throw a `FHIRPersistenceInterceptorException` to prevent the _create_ or _update_ persistence events from completing normally. The exception thrown by the interceptor method will be propagated back to the FHIR server request processing flow and would result in an `OperationOutcome` being returned in the REST API response, along with a `Bad Request` HTTP status code.\n\n2.  Perform some additional processing steps associated with a _create_ or _update_ persistence event, such as additional audit logging. In this case, the `afterCreate` and `afterUpdate` interceptor methods could add records to an audit log to indicate the request URI that was invoked, the user associated with the invocation request, and so forth.\n\nIn general, the `beforeCreate` and `beforeUpdate` interceptor methods would be useful to perform an enforcement-type action where you would potentially want to prevent the request processing flow from finishing. Conversely, the `afterCreate` and `afterUpdate` interceptor methods would be useful in situations where you need to perform additional steps after the _create_ or _update_ persistence events have been performed.\n\n### 4.3.2 Implementing a persistence interceptor\nTo implement a persistence interceptor, complete the following steps:\n\n1.  Develop a Java class which implements the `FHIRPersistenceInterceptor` interface.\n2.  Store the fully-qualified classname of your interceptor implementation class in a file called :\n\n      `META-INF/services/com.ibm.fhir.persistence.interceptor.FHIRPersistenceInterceptor`\n\n    Here's an example of the file contents:\n\n    `com.ibm.mysolution.MyInterceptor`\n\n3.  Copy your jar to the `<WLP_HOME>/usr/servers/fhir-server/userlib` directory so that it is accessible to the FHIR server via the classpath (the `server.xml` file contains a library element that defines this directory as a shared library).\n\n4.  Re-start the FHIR server.\n\n## 4.4 Resource validation\n\n### 4.4.1 HL7 spec-defined validation support\nThe FHIR specification provides a number of different validation resources including:\n\n1.  XML Schemas\n2.  ISO XML Schematron rules\n3.  Structure Definitions / Profiles for standard resource types, data types and built-in value sets\n\nThe FHIR server validates incoming resources for create and update interactions using the resource definitions and their corresponding FHIRPath constraints. Additionally, the FHIR server provides the following `$validate` operation that API consumers can use to POST resources and get validation feedback:\n `POST <base>/Resource/$validate`\n\n### 4.4.2 User-provided validation\nThe IBM FHIR Server can be extended with custom profile validation. This allows one to apply validation rules on the basis of the `Resource.meta.profile` codes included on the resource instance.\n\nFor example, you can configure a set of FHIRPath Constraints to run for resources that claim conformance to the `http://ibm.com/fhir/profile/partner` profile when you see an input resource like the following:\n```\n{\n    \"resourceType\" : \"Patient\",\n    \"meta\": {\n        \"profile\": [ \"http://ibm.com/fhir/profile/partner\" ]\n    },\n    \"name\" : [ {\n        \"family\" : [ \"Doe\" ],\n        \"given\" : [ \"John\" ]\n    } ],\n    \"telecom\" : [ {\n        \"value\" : \"555-1234\",\n        \"system\": \"phone\",\n        \"use\" : \"home\"\n    } ],\n    \"birthDate\" : \"1950-08-15\"\n}\n```\n\nIt is also possible to configure a set of profiles, one or more of which a resource must claim conformance to and be successfully validated against in order to be persisted to the FHIR server. The FHIR server supports this optional behavior via the `fhirServer/resources/<resourceType>/profiles/atLeastOne` configuration parameter. If this configuration parameter is set to a non-empty list of profiles, then the FHIR server will perform the following validation, returning FAILURE if not successful:\n * Validate that at least one profile in the list is specified in the resource's `meta.profile` element\n * Validate that all profiles specified in the resource's `meta.profile` element are supported by the FHIR server\n * Validate that the resource's data conforms to all profiles specified in the resource's `meta.profile` element\n\nIf a profile in the list specified by the configuration parameter contains a version, for example `http://ibm.com/fhir/profile/partner|1.0`, then a profile of the same name specified in the resource's `meta.profile` element will only be considered a match if it contains exactly the same version. However, if a profile in the list specified by the configuration parameter does not contain a version, for example `http://ibm.com/fhir/profile/partner`, then a profile of the same name specified in the resource's `meta.profile` element will be considered a match whether it contains a version or not.\n\nIf this configuration parameter is not set or is set to an empty list, then the FHIR server will perform its standard validation.\n\nThe IBM FHIR Server pre-packages all conformance resources from the core specification.\n\nSee [Validation Guide - Optional profile support](https://ibm.github.io/FHIR/guides/FHIRValidationGuide#optional-profile-support) for a list of pre-built Implementation Guide resources and how to load them into the IBM FHIR server.\n\nSee [Validation Guide - Making profiles available to the fhir registry](https://ibm.github.io/FHIR/guides/FHIRValidationGuide#making-profiles-available-to-the-fhir-registry-component-fhirregistry) for information about how to extend the server with additional Implementation Guide artifacts.\n\n## 4.5 “Update/Create” feature\nNormally, the _update_ operation is invoked with a FHIR resource which represents a new version of an existing resource. The resource specified in the _update_ operation would contain the same id of that existing resource. If a resource containing a non-existent id were specified in the _update_ invocation, an error would result.\n\nThe FHIR specification defines optional behavior for the _update_ operation where it can create a new resource if a non-existent resource is specified in the invocation. The FHIR server supports this optional behavior via the `fhirServer/persistence/common/updateCreateEnabled` configuration parameter. If this configuration parameter is set to `true` (the default), then the _update_ operation will create a new resource if it is invoked with a resource containing a non-existent id. If the option is set to false, then the optional behavior is disabled and an error would be returned.\n\nThe following example shows the JSON for enabling _update_ operations to create resources:\n```\n{\n    \"fhirServer\":{\n        …\n        \"persistence\":{\n            \"common\":{\n                \"updateCreateEnabled\":true\n            }\n        }\n        …\n    }\n}\n```\n\n## 4.6 FHIR client API\n\n### 4.6.1 Overview\nIn addition to the server, we also offer a Java API for invoking the FHIR REST APIs. The IBM FHIR Client API is based on the JAX-RS 2.0 standard and provides a simple properties-driven client that can be easily configured for a given endpoint, mutual authentication, request/response logging, and more.\n\n### 4.6.2 Maven coordinates\nTo use the FHIR Client from your application, specify the `fhir-client` artifact as a dependency within your `pom.xml` file, as in the following example:\n\n```\n        <dependency>\n            <groupId>com.ibm.fhir</groupId>\n            <artifactId>fhir-client</artifactId>\n            <version>${fhir.client.version}</version>\n        </dependency>\n```\n\n### 4.6.3 Sample usage\nFor examples on how to use the IBM FHIR Client, look for tests like `com.ibm.fhir.client.test.mains.FHIRClientSample` from the `fhir-client` project in git. Additionally, the FHIR Client is heavilly used from our integration tests in `fhir-server-test`.\n\n## 4.7 FHIR command-line interface (fhir-cli)\nThe FHIR command-line interface (fhir-cli for short) is a command that can be used to invoke FHIR REST API operations from the command line. The compressed file for installing the fhir-cli tool is available from [Maven Central](https://repo1.maven.org/maven2/com/ibm/fhir/fhir-cli/).\n\n### 4.7.1 Installing fhir-cli\nBecause the fhir-cli tool is intended to be used by clients that need to access the FHIR server, it has its own installation process separate from the server. To install the fhir-cli tool, complete the following steps:\n\n1.  Obtain the `fhir-cli.zip` file from the FHIR server installation zip or Maven.\n2.  Decompress the `fhir-cli.zip` file into a directory of your choosing, for example:\n\n    ```\n    cd /mydir\n    unzip fhir-cli.zip\n    ```\n\n3.  [Optional] To enable you to run fhir-cli from multiple directories, run the following command to add `fhir-cli` to your `PATH` environment variable.\n    ```\n    export PATH=$PATH:/mydir/fhir-cli\n    ```\n\n### 4.7.2 Configuring fhir-cli\nThe fhir-cli tool requires a properties file containing various configuration properties, such as the base endpoint URL, the username and password for basic authentication, amd so forth. The properties contained in this file are the same properties supported by the FHIR client API. The fhir-cli tool comes with a sample properties file named `fhir-cli.properties` which contains a collection of default property settings.\n\nUsing the sample properties file as a guide, you can create your own properties file to reflect the required endpoint configuration associated with the FHIR server endpoint that you would like to access. In the examples that follow, we'll refer to this file as `my-fhir-cli.properties`, although you can name the file anything you'd like.\n\n### 4.7.3 Running fhir-cli\nThe fhir-cli tool comes with two shell scripts: `fhir-cli` (Linux&reg;) and `fhir-cli.bat` (Windows&trade;). In the examples that follow, we'll use `<fhir-cli-home>` as the location of the fhir-cli tool (that is, the `/mydir/fhir-cli` directory mentioned in preceding section).\n\nThe following examples illustrate how to invoke the fhir-cli tool:\n\n*   Display help text\n```\n$ <fhir-cli-home>/fhir-cli –help\n\nFHIR Client Command Line Interface (fhir-cli)    (c) Copyright IBM Corporation, 2016.\n\nusage: fhir-cli [options]\n\nProvides access to the FHIR Client API via the command line.\n\nOptions:\n   -h,--help                           Display this help text\n   -id,--resourceId <ID>               Use resource identifier <ID> for the operation invocation\n   -o,--output <FILE>                  Write output resource to <FILE> (e.g. searchresults.json)\n   -op,--operation <OPERATION>         The operation to be invoked\n   -p,--properties <FILE>              Use FHIR Client properties contained in <FILE> (e.g.\n                                       fhir-cli.properties)\n   -qp,--queryParameter <NAME=VALUE>   Include query parameter NAME=VALUE with the operation\n                                       invocation (e.g. _count=100).\n   -r,--resource <FILE>                Use FHIR resource contained in <FILE> for operation\n                                       invocation (e.g. patient.json)\n   -t,--type <TYPE>                    Use resource type <TYPE> for the operation invocation (e.g.\n                                       \"Patient\")\n   -v,--verbose                        Display detailed output\n   -vid,--versionId <VID>              Use version # <VID> for the operation invocation\n\nOPERATION should be one of: batch | create | history | metadata | read | search | search-all |\nsearch-post | transaction | update | validate | vread\n```\n*   Invoke the 'metadata' operation\n```\n$ <fhir-cli-home>/fhir-cli --properties my-fhir-cli.properties --operation metadata --output conformance.json\n\nFHIR Client Command Line Interface (fhir-cli)    (c) Copyright IBM Corporation, 2016.\n\nInvoking operation 'metadata'... done! (651ms)\nStatus code: 200\nResponse resource written to file: conformance.json\n```\nNote: in this example the “--output” option is used to specify that the Conformance resource should be saved in file 'conformance.json'.\n*   Perform a _create_ operation\n```\n$ <fhir-cli-home>/fhir-cli --properties my-fhir-cli.properties --operation create --resource newpatient.json\n\nFHIR Client Command Line Interface (fhir-cli)    (c) Copyright IBM Corporation, 2016.\n\nInvoking operation _create_... done! (2719ms)\nStatus code: 201\nLocation URI: http://localhost:9443/fhir-server/api/v4/Patient/26b694ef-cea7-4485-a896-5ac2a1da9f64/_history/1\nETag: W/\"1\"\nLast modified: 2016-09-13T20:51:21.048Z\n```\nNote: In this example, the “--resource” option is used to indicate that the contents of the new resource to be created should be read from file 'newpatient.json'.\n*   Perform a 'read' operation\n```\n$ <fhir-cli-home>/fhir-cli --properties my-fhir-cli.properties --operation read --type Patient --resourceId 26b694ef-cea7-4485-a896-5ac2a1da9f64 -o patient1.json\n\nFHIR Client Command Line Interface (fhir-cli)    (c) Copyright IBM Corporation, 2016.\n\nInvoking operation 'read'... done! (321ms)\nStatus code: 200\nETag: W/\"1\"\nLast modified: 2016-09-13T20:51:21.048Z\nResponse resource written to file: patient1.json\n```\nNote: the “-o” option is used as a shortcut for “--output”\n*   Perform an _update_ operation\n```\n$ <fhir-cli-home>/fhir-cli --properties my-fhir-cli.properties --operation update --resource updatedpatient1.json\nFHIR Client Command Line Interface (fhir-cli)    (c) Copyright IBM Corporation, 2016.\n\nInvoking operation _update_... done! (2707ms)\nStatus code: 200\nLocation URI: http://localhost:9443/fhir-server/api/v4/Patient/26b694ef-cea7-4485-a896-5ac2a1da9f64/_history/2\nETag: W/\"2\"\nLast modified: 2016-09-13T21:11:48.988Z\n```\n*   Perform a 'vread' operation\n```\n$ <fhir-cli-home>/fhir-cli --properties my-fhir-cli.properties --operation vread -t Patient -id 26b694ef-cea7-4485-a896-5ac2a1da9f64 -vid 3 -o patient1v3.json\n\nFHIR Client Command Line Interface (fhir-cli)    (c) Copyright IBM Corporation, 2016.\n\nInvoking operation 'vread'... done! (290ms)\nStatus code: 200\nETag: W/\"3\"\nLast modified: 2016-09-13T21:18:28.412Z\nResponse resource written to file: patient1v3.json\n```\n*   Perform a 'history' operation\n```\n$ <fhir-cli-home>/fhir-cli --properties my-fhir-cli.properties --operation history -t Patient -id 26b694ef-cea7-4485-a896-5ac2a1da9f64 -o patient1history.json\n\nFHIR Client Command Line Interface (fhir-cli)    (c) Copyright IBM Corporation, 2016.\n\nInvoking operation 'history'... done! (414ms)\nStatus code: 200\nResponse resource written to file: patient1history.json\n```\nNote: in this example, the response resource is a Bundle containing the versions of the Patient resource.\n\n\n*   Perform a 'search' operation\n\n```\n$ <fhir-cli-home>/fhir-cli --properties my-fhir-cli.properties --operation search -t Patient -qp name=Doe -o searchresults.json\n\nFHIR Client Command Line Interface (fhir-cli)    (c) Copyright IBM Corporation, 2016.\n\nInvoking operation 'search'... done! (543ms)\nStatus code: 200\nResponse resource written to file: searchresults.json\n```\n\nNote: in this example the `-qp` option (shortcut for `–queryParameter`) is used to specify the search criteria (that is, `name=Doe`). The response resource is a Bundle that is written to the file `searchresults.json`.\n\n*   Perform a 'validate' operation\n\n```\n$ <fhir-cli-home>/fhir-cli --properties my-fhir-cli.properties --operation validate --resource newpatient.json\n\nFHIR Client Command Line Interface (fhir-cli)    (c) Copyright IBM Corporation, 2016.\n\nInvoking operation 'validate'... done! (3182ms)\nStatus code: 200\nResponse resource:\n\n{\n    \"resourceType\" : \"OperationOutcome\",\n    \"id\" : \"allok\",\n    \"text\" : {\n        \"status\" : \"additional\",\n        \"div\" : \"<div xmlns=\\\"http://www.w3.org/1999/xhtml\\\"><p>All OK</p></div>\"\n    },\n    \"issue\" : [ {\n        \"severity\" : \"information\",\n        \"code\" : \"informational\",\n        \"details\" : {\n            \"text\" : \"All OK\"\n        }\n    } ]\n}\n```\n\n## 4.8 Using local references within request bundles\nInter-dependencies between resources are typically defined by one resource containing a field of type `Reference` which contains an _external reference_<sup id=\"a5\">[5](#f5)</sup> to another resource. For example, an `Observation` resource could reference a `Patient` resource via the Observation's `subject` field. The value that is stored in the `Reference-type` field (for example, `subject` in the case of the `Observation` resource) could be an absolute URL, such as `https://fhirserver1:9443/fhir-server/api/v4/Patient/12345`, or a relative URL (for example, `Patient/12345`).\n\nIn order to establish a reference to a resource, you must first know its resource identifier. However, if you are using a request bundle to create both the referenced resource (`Patient` in this example) and the resource which references it (`Observation`), then it is impossible to know the `Patient`resource identifier before the request bundle has been processed (that is, before the new `Patient` resource is created).\n\nThankfully, the HL7 FHIR specification defines a way to express a dependency between two resources within a request bundle by using a _local reference_<sup id=\"a6\">[6](#f6)</sup>. In the following example, a request bundle contains a `POST` request to create a new `Patient` resource, along with a `POST` request to create a new `Observation` resource that references that `Patient`:\n\n#### 4.8.0.1 Example 1: Observation references Patient via local reference\n```\n{\n    \"resourceType\" : \"Bundle\",\n    \"type\" : \"batch\",\n    \"entry\" : [ {\n        \"fullUrl\" : \"urn:uuid:7113a0bb-d9e0-49df-9855-887409388c69\",\n        \"resource\" : {\n            \"resourceType\" : \"Patient\",\n            …\n        },\n        \"request\" : {\n            \"method\" : \"POST\",\n            \"url\" : \"Patient\"\n        }\n    }, {\n        \"resource\" : {\n            \"resourceType\" : \"Observation\",\n            …\n            \"subject\" : {\n                \"reference\" : \"urn:uuid:7113a0bb-d9e0-49df-9855-887409388c69\"\n            },\n            …\n        },\n        \"request\" : {\n            \"method\" : \"POST\",\n            \"url\" : \"Observation\"\n        }\n    } ]\n}\n```\n\nIn order to reference a resource via a local reference, you must first define a local identifier for that resource by specifying the `fullUrl` field within the request entry. To define a local identifier, use a value that starts with `urn:` as in the preceding example. The HL7 FHIR specification highly recommends that the value of the identifier should be a UUID-type value, although the FHIR server does not require the use of a UUID value. You can use any value you like after the `urn:` prefix as long as it is unique within the bundle. For example, you can use urn:Patient_1, urn:ABC, or urn:Foo. Just make sure that no two request entries share the same fullUrl value within the request bundle.\n\nAfter you define a local identifier for the referenced resource, you can then define one or more references to that resource by using the local identifier instead of an external identifier. In the preceding example, you can see that the Observation's `subject.reference` field specifies the Patient's local identifier as specified in the `fullUrl` field of the Patient's request entry.\n\n### 4.8.1 Processing rules\nThe following processing rules apply for the use of local references within a request bundle:\n1.  A local identifier must be defined via a request entry's `fullUrl` field in order for that local identifier to be used in a local reference.\n2.  Local references will only be recognized for local identifiers associated with requst entries with a request method of `POST` or `PUT`.\n3.  `POST` requests will be processed before `PUT` requests.\n4.  There is no order dependency within a request bundle for request entries defining local identifiers, and request entries which reference those local identifiers via local reference. The exception to this rule is for request entries which specify [conditional create](https://www.hl7.org/fhir/http.html#ccreate) or [conditional update](https://www.hl7.org/fhir/http.html#cond-update) requests.\n5.  If a request entry specifying a conditional create or update request defines a local identifier, that request entry must be processed before a request entry which references the local identifier in a local reference.\n\nIn the example in [Section 4.8.0.1](#4801-example-1-observation-references-patient-via-local-reference), you can see that there are two POST requests and the `Patient` request entry appears in the bundle before the `Observation` request entry. However, based on rule 4, it would still be a valid request bundle if the `Observation` request entry appeared before the `Patient` request entry, unless the `Patient` request entry specified a conditional create (rule 5).\n\nIf those entries were reversed, and the `Patient` request entry specified a conditional create, then the FHIR server would return an error when processing the `Observation` request entry, because the `Patient` local identifier would not be defined yet.\n\nThe following examples also satisfy the local reference processing rules:\n\n#### 4.8.1.1 Example 2: Observation (PUT) appears before Patient (POST)\n```\n{\n    \"resourceType\" : \"Bundle\",\n    \"type\" : \"batch\",\n    \"entry\" : [ {\n        \"resource\" : {\n            \"resourceType\" : \"Observation\",\n            \"id\" : \"25b1fe08-7612-45eb-af80-7e15d9806b2b\",\n            …\n            \"subject\" : {\n                    \"reference\" : \"urn:Patient_1\"\n            },\n            …\n        },\n        \"request\" : {\n            \"method\" : \"PUT\",\n            \"url\" : \"Observation/25b1fe08-7612-45eb-af80-7e15d9806b2b\"\n        }\n    }, {\n        \"fullUrl\" : \"urn:Patient_1\",\n        \"resource\" : {\n            \"resourceType\" : \"Patient\",\n            …\n        },\n        \"request\" : {\n            \"method\" : \"POST\",\n            \"url\" : \"Patient\"\n        }\n    } ]\n}\n```\n\nIn Example 2, if the `Patient` request entry was a conditional create request, this would still be a valid request bundle, because `POST` requests are processed before `PUT` requests (rule 3). This means the `Patient` request entry would be processed before the `Observation` request entry, and thus the `Patient` local identifier would be defined when the `Observation` request entry was processed.\n\n#### 4.8.1.2 Example 3: Encounter and Procedure circular references\n```\n{\n    \"resourceType\" : \"Bundle\",\n    \"type\" : \"batch\",\n    \"entry\" : [ {\n        \"fullUrl\" : \"urn:Encounter_1\",\n        \"resource\" : {\n            \"resourceType\" : \"Encounter\",\n            …\n            \"reasonReference\" : [ {\n                    \"reference\" : \"urn:Procedure_1\"\n            } ],\n            …\n        },\n        \"request\" : {\n            \"method\" : \"POST\",\n            \"url\" : \"Encounter\"\n        }\n    }, {\n        \"fullUrl\" : \"urn:Procedure_1\",\n        \"resource\" : {\n            \"resourceType\" : \"Procedure\",\n            …\n            \"encounter\" : {\n                    \"reference\" : \"urn:Encounter_1\"\n            },\n            …\n        },\n        \"request\" : {\n            \"method\" : \"POST\",\n            \"url\" : \"Procedure\"\n        }\n    } ]\n}\n```\n\nWhile processing a request bundle, but before processing individual request entries, the IBM FHIR server detects the use of a local identifier within any `POST` or `PUT` request entry's `fullUrl` field, and establishes a mapping between that local identifier and the corresponding external identifier that results from performing the `POST` or `PUT` operation.\n\nUsing Example 3, the FHIR server detects the use of local identifiers in the `Encounter` request entry (`urn:Encounter_1`) and in the `Procedure` request entry (`urn:Procedure_1`), and establishes a mapping between the local identifiers and the external references to be associated with the new `Encounter` and `Procedure` resources (for example, `Encounter/1cc5d299-d2be-4f93-8745-a121232ffe5b` and `Procedure/22b21fcf-8d00-492d-9de0-e25ddd409eaf`).\n\nThen when the FHIR server processes the POST requests for the `Encounter` and `Procedure` resources, it detects the use of the local references and substitutes the corresponding external references for them before creating the new resources. Here is an example of a response bundle for the request bundle depicted in Example 3 in which we can see that the Encounter's `reasonReference.reference` field now contains a proper external reference to the newly-created `Procedure` resource, and the Procedure's `encounter.reference` field now contains a proper external reference to the newly-created `Encounter` resource:\n\n#### 4.8.1.3 Example 4: Response bundle for Example 3\n```\n{\n    \"resourceType\" : \"Bundle\",\n    \"type\" : \"batch-response\",\n    \"entry\" : [ {\n        \"resource\" : {\n            \"resourceType\" : \"Encounter\",\n            \"id\" : \"1cc5d299-d2be-4f93-8745-a121232ffe5b\",\n            …\n            \"reasonReference\" : [ {\n                    \"reference\" : \"Procedure/22b21fcf-8d00-492d-9de0-e25ddd409eaf\"\n            } ],\n            …\n        },\n        \"response\" : {\n            \"id\" : \"1cc5d299-d2be-4f93-8745-a121232ffe5b\",\n            \"status\" : \"201\",\n            \"location\" : \"Encounter/1cc5d299-d2be-4f93-8745-a121232ffe5b/_history/1\",\n            \"etag\" : \"W/\\\"1\\\"\",\n            \"lastModified\" : \"2017-03-01T20:56:59.540Z\"\n        }\n    }, {\n        \"resource\" : {\n            \"resourceType\" : \"Procedure\",\n            \"id\" : \"22b21fcf-8d00-492d-9de0-e25ddd409eaf\",\n            …\n            \"encounter\" : {\n                \"reference\" : \"Encounter/1cc5d299-d2be-4f93-8745-a121232ffe5b\"\n            },\n            …\n        },\n        \"response\" : {\n            \"id\" : \"22b21fcf-8d00-492d-9de0-e25ddd409eaf\",\n            \"status\" : \"201\",\n            \"location\" : \"Procedure/22b21fcf-8d00-492d-9de0-e25ddd409eaf/_history/1\",\n            \"etag\" : \"W/\\\"1\\\"\",\n            \"lastModified\" : \"2017-03-01T20:56:59.652Z\"\n        }\n    } ]\n}\n```\n\n## 4.9 Multi-tenancy\nThe FHIR server includes features that allow a single instance of the server to simultaneously support multiple tenants. A tenant is defined as a group of one or more FHIR REST API consumers that share a FHIR server configuration along with one or more data stores associated with that configuration. A tenant could be a single application using the FHIR REST API, or it could be a group of applications belonging to a single customer. The main idea behind multi-tenancy is that each tenant can experience its own customized FHIR server runtime behavior and its data can be physically isolated from other tenants' data for increased security and privacy.\n\n### 4.9.1 Specifying the tenant id\nTo support multi-tenancy, the FHIR server must know which tenant an incoming REST API request is intended for. To provide the tenant id to the FHIR server, a REST API consumer must set a request header in each REST API request. The name of this request header is itself configurable by setting the `fhirServer/core/tenantIdHeaderName` configuration property in the FHIR server's global configuration file (located at `$⁠{server.config.dir}/config/default/fhir-server-config.json`). The following example shows the default setting for this configuration parameter:\n```\n\n{\n  \"fhirServer\":{\n      \"core\":{\n            \"tenantIdHeaderName\":\"X-FHIR-TENANT-ID\"\n      },\n      …\n   }\n}\n```\n\nWith this configuration in place, each REST API consumer would need to set the `X-FHIR-TENANT-ID` request header to the appropriate tenant id. Each tenant's tenant id value is assigned by the deployer. It is simply a short name associated with the tenant and must be unique among all tenants supported by a single FHIR server instance. For example, let's suppose Acme Healthcare, Inc. is using the FHIR server and their tenant id has been assigned by the deployer as “acme”. In this case, Acme-related applications would set the following request header in each REST API request: `X-FHIR-TENANT-ID: acme`\n\nAs mentioned earlier, the name of the request header is configurable in the FHIR server's global configuration file. For example, the FHIR server deployer could configure the request header name to be `X-WHCLSF-tenant-id` by setting `tenantIdHeaderName` as shown in the following example:\n```\n{\n   \"fhirServer\":{\n      \"core\":{\n            \"tenantIdHeaderName\":\"X-WHCLSF-tenant-id\"\n      },\n      …\n   }\n}\n```\n\nThis would be useful in an environment where the applications might already be using a similar type of request header. With this configuration in place, the “Acme Healthcare, Inc.” tenant would set the following request header in each REST API request:\n    `X-WHCLSF-tenant-id: acme`\n\n\n### 4.9.2 Configuration properties\nThe FHIR server allows a deployer to configure a subset of the supported configuration properties on a tenant-specific basis.\nFor a complete list of configuration properties supported on a per-tenant basis, see [Section 5.1.3 Property attributes](#513-property-attributes).\n\nWhen the FHIR server needs to retrieve any of the tenant-specific configuration properties, it does so dynamically each time the property value is needed. This means that a deployer can change the value of a tenant-specific property within a tenant's configuration file on disk, and the FHIR server will immediately “see” the new value the next time it tries to retrieve it. For example, suppose the deployer initially defines the `acme` tenant's `fhir-server-config.json` file such that the `fhirServer/core/defaultPrettyPrint` property is set to true.\n\nRequests from the `acme` tenant would result in pretty-printed responses (with newlines and indentation), making it easier for humans to read.\nNow suppose the deployer changes the value of that property to true within the `acme` tenant's `fhir-server-config.json` file.\nA subsequent REST API request would then see the output condensed into a single line with minimal whitespace.\n\n#### 4.9.2.1 Examples\nThis section contains examples of both a global (default) configuration and a tenant-specific configuration.\n\n##### Global configuration (default)\nThe global configuration contains non-tenant specific configuration parameters (configuration parameters that are not resolved or used on a tenant-specific basis), as well as default values for tenant-specific configuration parameters.\n\n`${server.config.dir}/config/default/fhir-server-config.json`\n\n```\n{\n    \"__comment\":\"FHIR server global (default) configuration\",\n    \"fhirServer\":{\n        \"core\":{\n            \"defaultPrettyPrint\":false,\n            \"tenantIdHeaderName\":\"X-FHIR-TENANT-ID\"\n        },\n        \"notifications\":{\n            \"common\":{\n                \"includeResourceTypes\":[\n                    \"QuestionnaireResponse\",\n                    \"CarePlan\",\n                    \"MedicationAdministration\",\n                    \"Device\",\n                    \"DeviceComponent\",\n                    \"DeviceMetric\",\n                    \"MedicationOrder\",\n                    \"Observation\"\n                ]\n            },\n            \"websocket\":{\n                \"enabled\":false\n            },\n            \"kafka\":{\n                \"enabled\":false,\n                \"topicName\":\"fhirNotifications\",\n                \"connectionProperties\":{\n                }\n            }\n        },\n        \"audit\": {\n            \"serviceClassName\" : \"com.ibm.fhir.audit.impl.NopService\",\n            \"serviceProperties\" : {\n            }\n        },\n        \"persistence\":{\n            \"factoryClassname\":\"com.ibm.fhir.persistence.jdbc.FHIRPersistenceJDBCFactory\",\n            \"common\":{\n                \"__comment\":\"Configuration properties common to all persistence layer implementations\",\n                \"updateCreateEnabled\":true\n            },\n            \"jdbc\":{\n                \"__comment\":\"Configuration properties for the JDBC persistence implementation\",\n            },\n        …\n        }\n    …\n    }\n```\n\n##### Acme Healthcare, Inc. (acme)\nThe Acme Healthcare, Inc tenant configuration overrides the `fhirServer/core/defaultPrettyPrint` property so that the development\nteam can more easilly read the messages.\n\n`${server.config.dir}/config/acme/fhir-server-config.json`\n\n```\n{\n    \"__comment\":\"FHIR server configuration for tenant: Acme Healthcare, Inc.\",\n    \"fhirServer\":{\n        \"core\":{\n            \"defaultPrettyPrint\":true\n        }\n    }\n}\n```\n\nIt is also possible to configure the persistence properties for a specific tenant, for example to set an alternate\ndatabase hostname or database schema name.\n\n## 4.10 Bulk data operations\nThe IBM FHIR Server implements bulk data export according to the [HL7 FHIR BulkDataAccess IG: STU1](http://hl7.org/fhir/uv/bulkdata/STU1/export/index.html), and bulk data import is implemented according to the [Proposal for $import Operation](https://github.com/smart-on-fhir/bulk-import/blob/master/import.md).\n\nThere are 2 modules involved:\n\n- fhir-operation-bulkdata\n- fhir-bulkdata-webapp   \n\nThe *fhir-operation-bulkdata* module implements the REST APIs for bulk data export, import and status as FHIR Operations.  There are five operations:\n\n| Operation | Path |\n|-----|-----|\n| ExportOperation| system `$export` |\n| PatientExportOperation| Patient `Patient/$export` |\n| GroupExportOperation| Group `Group/[id]/$export` |\n| ImportOperation | import resources using the system endpoint, `$import` |\n| StatusOperation | polling status for import and export `$bulkdata-status` |\n\nEach operation queues a job with the Open Liberty JavaBatch framework. Each job instance unit-of-work is executed as a job with the *fhir-bulkdata-webapp* module. There are 5 JavaBatch jobs defined in the *fhir-bulkdata-webapp* module for the above 3 export operations and 1 import operation:\n\n| Java Batch Job | Operation |\n|-----|-----|\n| FhirBulkExportChunkJob| `$export` |\n| FhirBulkExportFastJob| `$export` |\n| FhirBulkExportPatientChunkJob| `Patient/$export` |\n| FhirBulkExportGroupChunkJob| `Group/[id]/$export` |\n| FhirBulkImportChunkJob | `$import` |\n\nThe *fhir-bulkdata-webapp* module is a wrapper for the whole BulkData web application, which is the build artifact - fhir-bulkdata-webapp.war. This web archive is copied to the `apps/` directory of the liberty server. The feature is configured using the `configDropins/default/bulkdata.xml`, such as:\n\n```xml\n<webApplication id=\"fhir-bulkdata-webapp\" location=\"fhir-bulkdata-webapp.war\" name=\"fhir-bulkdata-webapp\">\n    <classloader privateLibraryRef=\"configResources,fhirUserLib\"/>\n    <application-bnd>\n        <security-role id=\"users\" name=\"FHIRUsers\">\n            <group id=\"bulkUsersGroup\" name=\"FHIRUsers\"/>\n        </security-role>\n    </application-bnd>\n</webApplication>\n```\n\nThe Bulk Data web application writes the exported FHIR resources to an IBM Cloud Object Storage (COS), any Amazon S3-Compatible bucket (e.g, Amazon S3, minIO etc), or directory as configured in the per-tenant server configuration under `fhirServer/bulkdata`. The following is an example configuration for bulkdata; please refer to section 5 for the detailed description of these properties:\n\n``` json\n\"bulkdata\": {\n    \"enabled\": true,\n    \"core\": {\n        \"api\": {\n            \"url\": \"https://localhost:9443/ibm/api/batch\",\n            \"user\": \"fhiradmin\",\n            \"password\": \"change-password\",\n            \"truststore\": \"resources/security/fhirTrustStore.p12\",\n            \"truststorePassword\": \"change-password\"\n        },\n        \"cos\" : {\n            \"useServerTruststore\": true\n        },\n        \"pageSize\": 100,\n        \"batchIdEncryptionKey\": \"example-password\",\n        \"maxPartitions\": 3,\n        \"maxInputs\": 5\n    },\n    \"storageProviders\": {\n        \"default\" : {\n            \"type\": \"file\",\n            \"fileBase\": \"${WLP_OUTPUT_DIR}/fhir-server/output\",\n            \"exportPublic\": true,\n            \"disableOperationOutcomes\": true,\n            \"duplicationCheck\": false,\n            \"validateResources\": false\n        },\n        \"minio\" : {\n            \"type\": \"aws-s3\",\n            \"bucketName\": \"fhirbulkdata\",\n            \"location\": \"us\",\n            \"endpointInternal\": \"https://minio:9000\",\n            \"endpointExternal\": \"https://localhost:9000\",\n            \"auth\" : {\n                \"type\": \"hmac\",\n                \"accessKeyId\": \"example\",\n                \"secretAccessKey\": \"example-password\"\n            },\n            \"enableParquet\": false,\n            \"disableBaseUrlValidation\": true,\n            \"exportPublic\": true,\n            \"disableOperationOutcomes\": true,\n            \"duplicationCheck\": false,\n            \"validateResources\": false,\n            \"create\": false,\n            \"presigned\": true\n        }\n    }\n}\n```\n\nEach tenant's configuration may define multiple storageProviders. The default is assumed, unless specified with the `X-FHIR-BULKDATA-PROVIDER` and `X-FHIR-BULKDATA-PROVIDER-OUTCOME`. Each tenant's configuration may mix the different providers, however each provider is only of a single type. For instance, `minio` is `aws-s3` and `default` is `file`. Note, type `http` is only applicable to `$import` operations. Export is only supported with s3 and file.\n\nTo use Amazon S3 bucket for exporting, please set `accessKeyId` to S3 access key, and set `secretAccessKey` to the S3 secret key, and the auth type to `hmac`.\n\nBasic system exports to S3 without typeFilters use a streamlined implementation which bypasses the IBM FHIR Server Search API for direct access to the data enabling better throughput. The `fhirServer/bulkdata/core/systemExportImpl` property can be used to disable the streamlined system export implementation. To use the legacy implementation based on IBM FHIR Server search, set the value to \"legacy\". The new system export implementation is used by default for any export not using typeFilters. Exports using typeFilters use FHIR Search, and cannot use the streamlined export.\n\nTo import using the `$import` operation with `https`, one must additionally configure the `fhirServer/bulkdata/validBaseUrls`. For example, if one stores bulk data at `https://test-url1.cos.ibm.com/bucket1/test.ndjson` and `https://test-url2.cos.ibm.com/bucket2/test2.ndjson` you must specify both baseUrls in the configuration:\n\n```json\n    \"validBaseUrls\": [\n        \"https://test-url1.cos.ibm.com/bucket1\",\n        \"https://test-url2.cos.ibm.com/bucket2\"\n    ]\n```\n\nThese base urls are not checked when using cloud object store and bulk-import. If you need to disable the validBaseUrls feature you may add `fhirServer/bulkdata/storageProviders/(source)/disableBaseUrlValidation` as `true`.\n\nFor Bulk Data import, the `fhirServer/bulkdata/core/maxInputs` is used to configure a maximum number of inputs supported by the instance. The default number is 5. There is a hard character limit on the total input type and url must be under 4096 characters, as such the configuration may be tuned for each url scheme.\n\nNote: When `$import` is executed, if a resource to import includes a `Resource.id` then this id is honored (via create-on-update). If `Resource.id` is not valued, the server will perform a create and assign a new `Resource.id` for this resource.\n\nFollowing is the beautified response of sample polling location request after the export is finished:\n\n```json\n{\n\"transactionTime\": \"2020/01/20 16:53:41.160 -0500\",\n\"request\": \"https://myserver/fhir-server/api/v4/$export?_type=Patient\",\n\"requiresAccessToken\": false,\n\"output\" : [\n  { \"type\" : \"AllergyIntolerance\",\n      \"url\": \"https://s3.us-south.cloud-object-storage.appdomain.cloud/fhir-bulkimexport-connectathon/6SfXzbGvYl1nTjGbf5qeqJDFNjyljiGdKxXEJb4yJn8=/AllergyIntolerance_1.ndjson\",\n    \"count\": 20},\n  { \"type\" : \"AllergyIntolerance\",\n      \"url\": \"https://s3.us-south.cloud-object-storage.appdomain.cloud/fhir-bulkimexport-connectathon/6SfXzbGvYl1nTjGbf5qeqJDFNjyljiGdKxXEJb4yJn8=/AllergyIntolerance_2.ndjson\",\n    \"count\": 8},\n  { \"type\" : \"Observation\",\n      \"url\": \"https://s3.us-south.cloud-object-storage.appdomain.cloud/fhir-bulkimexport-connectathon/6SfXzbGvYl1nTjGbf5qeqJDFNjyljiGdKxXEJb4yJn8=/Observation_1.ndjson\",\n    \"count\": 234},\n  { \"type\" : \"Observation\",\n      \"url\": \"https://s3.us-south.cloud-object-storage.appdomain.cloud/fhir-bulkimexport-connectathon/6SfXzbGvYl1nTjGbf5qeqJDFNjyljiGdKxXEJb4yJn8=/Observation_2.ndjson\",\n    \"count\": 81}]\n}\n```\n\nFor the Import Operation, the polled status includes an indication of `$import` and the location of the OperationOutcome NDJSON files and the corresponding failure and success counts.\n\nFor S3 exports, the bulk data feature may use presigned urls.  To enable presigned urls, the authentication type must be `hmac` and `fhirServer/bulkdata/storageProviders/(source)/presigned` must be `true`.  The urls become:\n\n```\nhttps://s3.appdomain.cloud/fhir-example/Patient_1.ndjson?X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Credential=fcEXbf9cc1ac49e99eEX77%2F20210228%2Fus%2Fs3%2Faws4_request&X-Amz-Date=20210EXT160538Z&X-Amz-Expires=86400&X-Amz-SignedHeaders=host&X-Amz-Signature=5ecfc207546b9737fd38d4f0EXEX1c58f4f82976338a44c\n```\n\nThe presigned URL is valid for 86400 seconds (1 day).\n\nNote, the deletion of an a job is split into two phases, ACCEPTED (202) response and DELETED (204).  202 is returned until the operation is stopped or removed, and then 204.\n\nBy default, the exported `ndjson` file is configured with public access automatically and with 2 hours expiration time, the randomly generated secret in the path is used to protect the file. Please note that IBM COS does not support expiration time for each single COS object, so please configure retention policy (e.g, 1 day) for the bucket if IBM COS is used. For both Amazon S3 and IBM COS, please remember that public access should never be configured to the bucket itself.\n\nNote: `fhirServer/bulkdata/storageProviders/(source)/exportPublic` can be set to \"false\" to disable public access. Also, *minio* doesn't support object level ACL, so access token is always needed to download the exported `ndjson` files.\n\nJavaBatch feature must be enabled in `server.xml` as following on the Liberty server:\n\n```xml\n<featureManager>\n    ...\n    <feature>batchManagement-1.0</feature>\n    ...\n</featureManager>\n```\n\nThe JavaBatch user is configured in `bulkdata.xml` and the `fhir-server-config.json`:\n\n```xml\n<authorization-roles id=\"com.ibm.ws.batch\">\n\t<security-role name=\"batchAdmin\">\n\t\t<user name=\"fhiradmin\"/>\n\t</security-role>\n\t<security-role name=\"batchSubmitter\">\n\t\t<user name=\"fhiruser\"/>\n\t</security-role>\n\t<security-role name=\"batchMonitor\">\n\t\t<user name=\"fhiradmin\"/>\n\t\t<user name=\"fhiruser\"/>\n\t</security-role>\n</authorization-roles>\n```\n\nNote: The batch-user referenced in the `fhir-server-config.json` must have a role of at least batchSubmitter.\n\nBy default, in-memory Derby database is used for persistence of the JavaBatch Jobs as configured in `fhir-server/configDropins/defaults/bulkdata.xml`. This database is destroyed on the restart of the IBM FHIR Server, and does not support load balancing.\n\nTo support IBM Db2 on IBM Cloud, copy `fhir-server/configDropins/disabled/db2-cloud/bulkdata.xml` to `fhir-server/configDropins/defaults/bulkdata.xml` replacing the existing bulkdata.xml. One can configure the Datasource by setting the following environment variables:\n\n| Variable          | Default     | Description                                                    |\n|-------------------|-------------|----------------------------------------------------------------|\n| BATCH_DB_HOSTNAME | `blank`     | The hostname of the db2 instance                               |\n| BATCH_DB_NAME     | BLUDB       | The database name                                              |\n| BATCH_DB_SCHEMA   | FHIR_JBATCH | The Schema Name configured to support the Java Batch framework |\n| BATCH_DB_PORT     | 50001       | The port configured to support the database                    |\n| BATCH_DB_APIKEY   | `blank`     | The API Key for the Db2 Cloud database                         |\n\nInstruction is also provided in 'Configuring a Liberty Datasource with API Key' section of the DB2OnCloudSetup guide to configure DB2 service in IBM Clouds as JavaBatch persistence store. The JavaBatch schema is created using the `fhir-persistence-schema` command line interface jar.\n\nTo support IBM Db2 with a user-name and password , copy `fhir-server/configDropins/disabled/db2/bulkdata.xml` to `fhir-server/configDropins/defaults/bulkdata.xml` replacing the existing bulkdata.xml. One can configure the Datasource by setting the following environment variables:\n\n| Variable          | Default         | Description                                                    |\n|-------------------|-----------------|----------------------------------------------------------------|\n| BATCH_DB_HOSTNAME | `blank`         | The hostname of the db2 instance                               |\n| BATCH_DB_NAME     | FHIRDB          | The database name                                              |\n| BATCH_DB_SCHEMA   | FHIR_JBATCH     | The Schema Name configured to support the Java Batch framework |\n| BATCH_DB_PORT     | 50000           | The port configured to support the database                    |\n| BATCH_DB_USER     | db2inst1        | The user for the Db2 database                                  |\n| BATCH_DB_PASSWORD | `blank`         | The password for the Db2 database                              |\n| BATCH_DB_SSL      | true            | The ssl connection is either true or false                     |\n\nIf one wants to support Postgres with a user-name and password , one should copy `fhir-server/configDropins/disabled/postgres/bulkdata.xml` to `fhir-server/configDropins/defaults/bulkdata.xml` replacing the existing bulkdata.xml. One can configure the Datasource by setting the following environment variables:\n\n| Variable               | Default         | Description                                                    |\n|------------------------|-----------------|----------------------------------------------------------------|\n| BATCH_DB_HOSTNAME      | `blank`         | The hostname of the postgres instance                          |\n| BATCH_DB_NAME          | FHIRDB          | The database name                                              |\n| BATCH_DB_SCHEMA        | FHIR_JBATCH     | The Schema Name configured to support the Java Batch framework |\n| BATCH_DB_PORT          | 5432            | The port configured to support the database                    |\n| BATCH_DB_USER          | fhirserver      | The user for the postgres database                             |\n| BATCH_DB_PASSWORD      | `blank`         | The password for the postgres database                         |\n| BATCH_DB_SSL           | true            | The ssl connection is either true or false                     |\n| BATCH_DB_SSL_CERT_PATH | false           | The ssl connection is either true or false                     |\n\nNote: If you use PostgreSQL database as IBM FHIR Server data store or the JavaBatch job repository, please enable `max_prepared_transactions` in postgresql.conf, otherwise the import/export JavaBatch jobs fail.\n\nFor more information about Liberty JavaBatch configuration, please refer to [IBM WebSphere Liberty Java Batch White paper](https://www-03.ibm.com/support/techdocs/atsmastr.nsf/webindex/wp102544).\n\n### 4.10.1 Integration Testing\nTo integration test, there are tests in `ExportOperationTest.java` in `fhir-server-test` module with server integration test cases for system, patient and group export. Further, there are tests in `ImportOperationTest.java` in `fhir-server-test` module. These tests rely on the `fhir-server-config-db2.json` which specifies two storageProviders.\n\n### 4.10.2 Export to Parquet\nVersion 4.4 of the IBM FHIR Server introduced experimental support for exporting to Parquet format (as an alternative to the default NDJSON export). However, due to the size of the dependencies needed to make this work, this feature is disabled by default.\n\nTo enable export to parquet, an administrator must:\n1. make Apache Spark (version 3.0) and the IBM Stocator adapter (version 1.1) available to the fhir-bulkdata-webapp by dropping the necessary jar files under `fhir-server/userlib` directory; and\n2. set the `/fhirServer/bulkdata/storageProviders/(source)/enableParquet` config property to `true`\n\nAn alternative way to accomplish the first part of this is to change the scope of these dependencies from the fhir-bulkdata-webapp pom.xml and rebuild the webapp to include them.\n\n### 4.10.3 Job Logs\nBecause the bulk import and export operations are built on Liberty's java batch implementation, users may need to check the [Liberty batch job logs](https://www.ibm.com/support/knowledgecenter/SSEQTP_liberty/com.ibm.websphere.wlp.doc/ae/rwlp_batch_view_joblog.html) for detailed step information / troubleshooting.\n\nIn a standard installation, these logs will be at `wlp/usr/servers/fhir-server/logs/joblogs`.\nIn the `ibmcom/ibm-fhir-server` docker image, these logs will be at `/logs/joblogs`.\n\nNote, if you are using the default derby, the logs are overwritten upon restart of the server. You should use Db2 or Postgres for production purposes.\n\n## 4.11 Audit logging service\nThe Audit logging service pushes FHIR server audit events for FHIR operations in [Cloud Auditing Data Federation (CADF)](https://www.dmtf.org/standards/cadf) standard format to a Kafka backend, such as *IBM Cloud Event Streams service*.\n\nThere is early support for the [FHIR Standard: AuditEvent format](https://www.hl7.org/fhir/auditevent.html).\n\n### 4.11.1 CADF audit log entry\n\nEach FHIR interaction triggers a CADF audit log entry to be logged. The mapping of FHIR interaction to CADF action is as follows:\n\n| FHIR Interaction                                    | CADF Action |\n|-----------------------------------------------------|-------------|\n|`history,metadata,read,search,validate,version read` |   read      |\n|`create`                                             |   create    |\n|`update`                                             |   update    |\n|`delete`                                             |   delete    |\n|`bundle,custom operation,patch`                      |   unknown   |\n\nThe following table describes the JSON fields of the CADF audit log entries logged by the FHIR server:\n\n| CADF Audit Log Entry Field                           | Description |\n|------------------------------------------------------|-------------|\n|`action`                                              |Action that created the audit event. Possible values are \"read\", \"update\", \"create\", \"delete\", and \"unknown\".|\n|`eventTime`                                           |Audit event creation timestamp.|\n|`eventType`                                           |Audit event type. Value is always \"activity\".|\n|`id`                                                  |Globally unique identifier for the audit event.|\n|`outcome`                                             |Action outcome. Possible values are \"success\", \"failure\", \"unknown\", and \"pending\".|\n|`typeURI`                                             |TypeURI property of the CADF event entity. Value is always \"http://schemas.dmtf.org/cloud/audit/1.0/event\".|\n|`attachments`                                         |Note: Contains FHIR server-specific audit event data.|\n|`attachments/contentType`                             |FHIR server-specific audit event data content type. Value is always \"application/json\".|\n|`attachments/content`                                 |Note: Contents of this field (with its subfields) is encoded as Base64.\n|`attachments/content/request_unique_id`               |Globally unique identifier for the FHIR server request.|\n|`attachments/content/action`                          |FHIR action type. Possible values are \"C\" (create), \"U\" (update), \"R\" (read), \"D\" (delete), \"P\" (patch), and \"O\" (custom operation).|\n|`attachments/content/operation_name`                  |FHIR custom operation name.|\n|`attachments/content/start_time`                      |FHIR request start time.|\n|`attachments/content/end_time`                        |FHIR request end time.|\n|`attachments/content/api_parameters/request`          |FHIR request URL.|\n|`attachments/content/api_parameters/request_status`   |FHIR request HTTP status (e.g. 200).|\n|`attachments/content/data/resource_type`              |Resource type of FHIR resource that was created, updated, or deleted.|\n|`attachments/content/data/id`                         |Resource ID of FHIR resource that was created, updated, or deleted.|\n|`attachments/content/data/version`                    |Updated version of FHIR resource that was created, updated, or deleted.|\n|`attachments/content/batch/resources_read`            |FHIR resource count retrieved on a search request.|\n|`attachments/content/event_type`                      |FHIR event type. Possible values are \"fhir-create\", \"fhir-update\", \"fhir-patch\", \"fhir-delete\", \"fhir-read\", \"fhir-version-read\", \"fhir-history\", \"fhir-search\", \"fhir-bundle\", \"fhir-validate\", \"fhir-metadata\", and \"fhir-operation\".|\n|`attachments/content/description`                     |FHIR event type description. Possible values are \"FHIR Create request\", \"FHIR Update request\", \"FHIR Patch request\", \"FHIR Delete request\", \"FHIR Read request\", \"FHIR VersionRead request\", \"FHIR History request\", \"FHIR Search request\", \"FHIR Bundle request\", \"FHIR Validate request\", \"FHIR Metadata request\", and \"FHIR Operation request\".|\n|`attachments/content/client_cert_cn`                  |Value is determined by \"IBM-App-cli-CN\" HTTP header of the FHIR request.|\n|`attachments/content/client_cert_issuer_ou`           |Value is determined by \"IBM-App-iss-OU\" HTTP header of the FHIR request.|\n|`attachments/content/location`                        |IP address and hostname of the source of the FHIR request.|\n|`initiator/id`                                        |Value is always \"TENANT_ID@fhir-server\", where TENANT_ID is replaced with the tenant ID.|\n|`initiator/typeURI`                                   |Value is always \"compute/machine\".|\n|`initiator/host`                                      |IP address of FHIR server localhost.|\n|`initiator/credential/token`                          |Value is always \"user-AUTH_USER\", where AUTH_USER is replaced with the name of the authenticated user.|\n|`initiator/geolocation/city`                          |Value determined by \"fhirServer/audit/serviceProperties/geoCity\" configuration property.|\n|`initiator/geolocation/state`                         |Value determined by \"fhirServer/audit/serviceProperties/geoState\" configuration property.|\n|`initiator/geolocation/region`                        |Value determined by \"fhirServer/audit/serviceProperties/geoCounty\" configuration property.|\n|`observer/id`                                         |Value is always \"fhir-server\".|\n|`observer/typeURI`                                    |Value is always \"compute/node\".|\n|`observer/name`                                       |Value is always \"Fhir Audit\".|\n|`observer/geolocation/city`                           |Value is determined by \"fhirServer/audit/serviceProperties/geoCity\" configuration property.|\n|`observer/geolocation/state`                          |Value is determined by \"fhirServer/audit/serviceProperties/geoState\" configuration property.|\n|`observer/geolocation/region`                         |Value is determined by \"fhirServer/audit/serviceProperties/geoCounty\" configuration property.|\n\n### 4.11.2 Enable audit logging service\nPlease refer to the property names that start with `fhirServer/audit/` in [5.1 Configuration properties reference](#51-configuration-properties-reference) for how to enable and configure the CADF audit logging service.\n\n### 4.11.3 Configuration of audit logging service\n\nThere are two types of configuration for the Audit Logging Service. The first type is using the environment variable, and the second is the configuration driven from the fhir-server-config.json.\n\nFor example, the following uses the 'config' in order to config the Kafka publisher as part of the audit logging service.\n\n```\n\"audit\": {\n    \"serviceClassName\" : \"com.ibm.fhir.audit.impl.KafkaService\",\n    \"serviceProperties\" : {\n        \"load\": \"config\",\n    }\n```\n\nOr, you could load from an environment, note, this is the default behavior.\n\n```\n\"audit\": {\n    \"serviceClassName\" : \"com.ibm.fhir.audit.impl.KafkaService\",\n    \"serviceProperties\" : {\n        \"load\": \"environment\",\n    }\n```\n\n#### 4.11.3.1 Environment Variable Configuration of audit logging service\n\nThe audit logging service gets the event streams service credential from environment variable EVENT_STREAMS_AUDIT_BINDING with values like this:\n\n```\n    {\n  \"api_key\": \"xxxxxxxxxxxxxxxx_xxxxx_xxxxxxxxxxxxxxxxxxx\",\n  \"apikey\": \"xxxxxxxxxxxxxxxx_xxxxx_xxxxxxxxxxxxxxxxxxx\",\n   …\n  \"kafka_brokers_sasl\": [\n    \"broker-1-0server:9093\",\n    \"broker-2-0server:9093\",\n    \"broker-5-0server:9093\",\n    \"broker-4-0server:9093\",\n    \"broker-3-0server:9093\",\n    \"broker-0-0server:9093\"\n  ],\n   …\n}\n```\n\nIf you are using the IBM EventStreams on IBM Cloud, the service credential can be generated automatically when you run:\n\n```\n    ibmcloud ks cluster-service-bind --cluster <cluster_name_or_ID> --namespace <namespace> --service <event_streams_service_instance_name> …\n```\n\nto bind your event streams service instance to your Kubernetes cluster.\n\nAnd then in the YAML file for your Kubernetes deployment, specify the environment variable EVENT_STREAMS_AUDIT_BINDING that references the binding key of the generated secret(binding-<event_streams_service_instance_name>) as following:\n\n```\n            - name: EVENT_STREAMS_AUDIT_BINDING\n                valueFrom:\n                  secretKeyRef:\n                    key: binding\n                    name: binding-<event_streams_service_instance_name>\n```\n\nPlease refer to https://cloud.ibm.com/docs/containers?topic=containers-service-binding for detailed instructions if needed.\n\n#### 4.11.3.2 fhir-server-config.json Configuration of audit logging service\n\n```\n\"audit\": {\n    \"serviceClassName\" : \"com.ibm.fhir.audit.impl.KafkaService\",\n    \"serviceProperties\" : {\n        \"load\": \"config\",\n        \"mapper\": \"cadf\",\n        \"auditTopic\": \"FHIR_AUDIT\",\n        \"geoCity\": \"Dallas\",\n        \"geoState\": \"TX\",\n        \"geoCounty\": \"US\",\n        \"kafka\" : {\n            \"sasl.jaas.config\": \"********\",\n            \"bootstrap.servers\": \"********\",\n            \"sasl.mechanism\": \"PLAIN\",\n            \"security.protocol\": \"SASL_SSL\",\n            \"ssl.protocol\": \"TLSv1.2\",\n            \"ssl.enabled.protocols\": \"TLSv1.2\",\n            \"ssl.endpoint.identification.algorithm\": \"HTTPS\"\n        },\n        \"kafkaServers\": \"********\",\n        \"kafkaApiKey\": \"********\"\n    }\n```\n\nThe service can map to the CADF format or the FHIR AuditEvent resource format by declaring a mapper type - 'cadf' or 'auditevent'.\n\n- *CADF* Example\n```\n{\n    \"action\": \"create\",\n    \"eventTime\": \"2020-12-10 16:49:22.307\",\n    \"eventType\": \"activity\",\n    \"id\": \"c62ee8f8-be77-49d0-aad0-c0bf52a05fdf\",\n    \"outcome\": \"success\",\n    \"typeURI\": \"http://schemas.dmtf.org/cloud/audit/1.0/event\",\n    \"tags\": [\n    ],\n    \"target\": {\n        \"id\": \"176629076d7-ef3e8608-cd07-4c20-8823-ddfe46237052\",\n        \"typeURI\": \"data/database\",\n        \"addresses\": [\n            {\n                \"url\": \"https://test.io:443/fhir-server/api/v4/Patient\",\n                \"name\": \"\",\n                \"port\": \"\"\n            }\n        ],\n        \"geolocation\": {\n            \"city\": \"Hamil\",\n            \"state\": \"TEXAS\",\n            \"region\": \"USA\",\n            \"annotations\": [\n            ]\n        },\n        \"addresses\": [\n            {\n                \"url\": \"https://test.io:443/fhir-server/api/v4/Patient\",\n                \"name\": \"\",\n                \"port\": \"\"\n            }\n        ]\n    },\n    \"attachments\": [\n        {\n            \"contentType\": \"application/json\",\n            \"content\": \"rO0ABXQCUQp7CiAgICAicmVxdWVzdF91bmlxdWVfaWQiOiAiYzYyZWU4ZjgtYmU3Ny00OWQwLWFhZDAtYzBiZjUyYTA1ZmRmIiwKICAgICJhY3Rpb24iOiAiQyIsCiAgICAic3RhcnRfdGltZSI6ICIyMDIwLTEyLTEwIDE2OjQ5OjIyLjE2OCIsCiAgICAiZW5kX3RpbWUiOiAiMjAyMC0xMi0xMCAxNjo0OToyMi4zMDciLAogICAgImFwaV9wYXJhbWV0ZXJzIjogewogICAgICAgICJyZXF1ZXN0IjogImh0dHBzOi8vbG9jYWxob3N0Ojk0NDMvZmhpci1zZXJ2ZXIvYXBpL3Y0L1ZlcmlmaWNhdGlvblJlc3VsdCIsCiAgICAgICAgInJlcXVlc3Rfc3RhdHVzIjogMjAxCiAgICB9LAogICAgImRhdGEiOiB7CiAgICAgICAgInJlc291cmNlX3R5cGUiOiAiVmVyaWZpY2F0aW9uUmVzdWx0IiwKICAgICAgICAiaWQiOiAiMTc2NGQ4ZWEzMGEtYzUxOGMxOWItMWM0Zi00Yjc0LThhMDMtNGM5NjA0YmZkYjZlIiwKICAgICAgICAidmVyc2lvbl9pZCI6ICIxIgogICAgfSwKICAgICJldmVudF90eXBlIjogImZoaXItY3JlYXRlIiwKICAgICJkZXNjcmlwdGlvbiI6ICJGSElSIENyZWF0ZSByZXF1ZXN0IiwKICAgICJsb2NhdGlvbiI6ICIxMjcuMC4wLjEvbG9jYWxob3N0Igp9\"\n        }\n    ],\n    \"initiator\": {\n        \"id\": \"default@fhir-server\",\n        \"typeURI\": \"compute/machine\",\n        \"host\": \"192.168.86.20\",\n        \"credential\": {\n            \"token\": \"user-fhiruser\"\n        },\n        \"geolocation\": {\n            \"city\": \"Dallas\",\n            \"state\": \"TX\",\n            \"region\": \"US\",\n            \"annotations\": [\n            ]\n        }\n    },\n    \"observer\": {\n        \"id\": \"fhir-server\",\n        \"typeURI\": \"compute/node\",\n        \"name\": \"IBM FHIR Server - Audit\",\n        \"geolocation\": {\n            \"city\": \"Dallas\",\n            \"state\": \"TX\",\n            \"region\": \"US\",\n            \"annotations\": [\n            ]\n        }\n    }\n}\n```\n\n- *AuditEvent* Example\n\n```\n{\n    \"resourceType\": \"AuditEvent\",\n    \"type\": {\n        \"system\": \"http://terminology.hl7.org/CodeSystem/audit-event-type\",\n        \"code\": \"rest\",\n        \"display\": \"Restful Operation\"\n    },\n    \"subtype\": [\n        {\n            \"system\": \"http://hl7.org/fhir/restful-interaction\",\n            \"code\": \"search\",\n            \"display\": \"search\"\n        }\n    ],\n    \"action\": \"E\",\n    \"period\": {\n        \"start\": \"2020-12-10T16:38:14.466Z\",\n        \"end\": \"2020-12-10T16:38:14.631Z\"\n    },\n    \"recorded\": \"2020-12-10T11:38:14.632173-05:00\",\n    \"outcome\": \"0\",\n    \"outcomeDesc\": \"success\",\n    \"purposeOfEvent\": [\n        {\n            \"coding\": [\n                {\n                    \"system\": \"http://terminology.hl7.org/CodeSystem/v3-ActReason\",\n                    \"code\": \"PurposeOfUse\",\n                    \"display\": \"PurposeOfUse\"\n                }\n            ]\n        }\n    ],\n    \"agent\": [\n        {\n            \"role\": [\n                {\n                    \"coding\": [\n                        {\n                            \"system\": \"http://terminology.hl7.org/CodeSystem/extra-security-role-type\",\n                            \"code\": \"datacollector\",\n                            \"display\": \"datacollector\"\n                        }\n                    ]\n                }\n            ],\n            \"name\": \"fhir-server\",\n            \"requestor\": true,\n            \"network\": {\n                \"address\": \"internal-ip\",\n                \"type\": \"1\"\n            }\n        }\n    ],\n    \"source\": {\n        \"site\": \"127.0.0.1/localhost\",\n        \"observer\": {\n            \"reference\": \"fhir-server\"\n        },\n        \"type\": [\n            {\n                \"system\": \"http://terminology.hl7.org/CodeSystem/security-source-type\",\n                \"code\": \"4\",\n                \"display\": \"Application Server\"\n            }\n        ]\n    },\n    \"entity\": [\n        {\n            \"securityLabel\": [\n                {\n                    \"system\": \"http://terminology.hl7.org/CodeSystem/v3-Confidentiality\",\n                    \"code\": \"N\",\n                    \"display\": \"normal\"\n                }\n            ],\n            \"description\": \"FHIR Search request\",\n            \"query\": \"MTI3LjAuMC4xL2xvY2FsaG9zdC97X3RhZz1baHR0cDovL2libS5jb20vZmhpci90YWd8dGFnMixodHRwOi8vaWJtLmNvbS9maGlyL3RhZ3x0YWddLCBfY291bnQ9WzEwMDBdLCBfcGFnZT1bMV19\",\n            \"detail\": [\n                {\n                    \"type\": \"FHIR Context\",\n                    \"valueBase64Binary\": \"CnsKICAgICJyZXF1ZXN0X3VuaXF1ZV9pZCI6ICIzMmJmMDNhNS1kNmQ1LTQ2MTEtYmFjYS0wNjdkMzcwMDYyMzUiLAogICAgImFjdGlvbiI6ICJSIiwKICAgICJzdGFydF90aW1lIjogIjIwMjAtMTItMTAgMTY6Mzg6MTQuNDY2IiwKICAgICJlbmRfdGltZSI6ICIyMDIwLTEyLTEwIDE2OjM4OjE0LjYzMSIsCiAgICAiYXBpX3BhcmFtZXRlcnMiOiB7CiAgICAgICAgInJlcXVlc3QiOiAiaHR0cHM6Ly9sb2NhbGhvc3Q6OTQ0My9maGlyLXNlcnZlci9hcGkvdjQvX3NlYXJjaD9fdGFnPWh0dHAlM0ElMkYlMkZpYm0uY29tJTJGZmhpciUyRnRhZyU3Q3RhZzIlMkNodHRwJTNBJTJGJTJGaWJtLmNvbSUyRmZoaXIlMkZ0YWclN0N0YWcmX2NvdW50PTEwMDAmX3BhZ2U9MSIsCiAgICAgICAgInJlcXVlc3Rfc3RhdHVzIjogMjAwCiAgICB9LAogICAgInF1ZXJ5IjogIntfdGFnPVtodHRwOi8vaWJtLmNvbS9maGlyL3RhZ3x0YWcyLGh0dHA6Ly9pYm0uY29tL2ZoaXIvdGFnfHRhZ10sIF9jb3VudD1bMTAwMF0sIF9wYWdlPVsxXX0iLAogICAgImJhdGNoIjogewogICAgICAgICJyZXNvdXJjZXNfcmVhZCI6IDIKICAgIH0sCiAgICAiZXZlbnRfdHlwZSI6ICJmaGlyLXNlYXJjaCIsCiAgICAiZGVzY3JpcHRpb24iOiAiRkhJUiBTZWFyY2ggcmVxdWVzdCIsCiAgICAibG9jYXRpb24iOiAiMTI3LjAuMC4xL2xvY2FsaG9zdCIKfQ==\"\n                }\n            ]\n        }\n    ]\n}\n```\n\n### 4.11.4 Query CADF events in COS\n\n[Watson Studio stream flow](https://cloud.ibm.com/docs/tutorials?topic=solution-tutorials-big-data-log-analytics#create-a-streams-flow-source) can be created to push those FHIR Audit CADF events from the Event Streams service to a COS bucket (e.g. fhir-audit-dev) in CSV format. Another option is to configure Event Streams (Kafka) S3 connect to push those CADF events to a COS bucket (e.g. fhir-audit-dev) but in raw CADF json format.\n\nA service instance of the [IBM Cloud SQL Query](https://www.ibm.com/cloud/blog/analyzing-data-with-ibm-cloud-sql-query) service can be created to allow you to query those CADF audit events in COS with SQL queries. Before running an SQL query, it's recommended to first create a COS bucket to store your query results, otherwise the query results will be stored in a bucket which is automatically created by the SQL query service.\n\nSample queries for CSV records expanded from the JSON CADF events:\n\n```\nselect * from cos://us-south/fhir-audit-dev where EVENTTIME BETWEEN \"2019-06-07\" and \"2019-06-08\" and action=\"unknown\" into cos://us-south/fhir-audit-dev-res stored as csv\n\nselect action, count(*) from cos://us-south/fhir-audit-dev where EVENTTIME BETWEEN \"2019-06-05\" and \"2019-06-06\" group by action into cos://us-south/fhir-audit-dev-res stored as csv\n\nselect * from cos://us-south/fhir-audit-dev where EVENTTIME BETWEEN \"2019-06-05\" and \"2019-06-06\" and action=\"create\" and initiator_id=\"default@fhir-server\" into cos://us-south/fhir-audit-dev-res stored as csv\n\nselect * from cos://us-south/fhir-audit-dev where EVENTTIME BETWEEN \"2019-06-05\" and \"2019-06-06\" and ATTACHMENTS_CONTENT LIKE '%fhir-read%' into cos://us-south/fhir-audit-dev-res stored as csv\n```\n\nSample queries for the raw JSON CADF events:\n\n```\nselect * from cos://us-south/fhir-audit-dev0 stored as json where EVENTTIME BETWEEN \"2019-06-01\" and \"2019-06-08\" and action=\"unknown\" into cos://us-south/fhir-audit-dev0-res stored as json\n\nselect action, count(*) from cos://us-south/fhir-audit-dev0 stored as json where EVENTTIME BETWEEN \"2019-06-01\" and \"2019-06-06\" group by action into cos://us-south/fhir-audit-dev0-res stored as csv\n\nselect * from cos://us-south/fhir-audit-dev0 stored as json where EVENTTIME BETWEEN \"2019-06-01\" and \"2019-06-06\" and action=\"create\" and initiator.id=\"default@fhir-server\" into cos://us-south/fhir-audit-dev-res stored as json\n\nselect * from cos://us-south/fhir-audit-dev0 stored as json where EVENTTIME BETWEEN \"2019-06-01\" and \"2019-06-06\" and ATTACHMENTS[0].CONTENT LIKE '%fhir-read%' into cos://us-south/fhir-audit-dev-res stored as json\n\n```\n\n## 4.12 FHIR REST API\nBy default, the IBM FHIR Server allows the following RESTful interactions associated with the FHIR REST API: `create`, `read`, `vread`, `history`, `search`, `update`, `patch`, `delete`. However, it is possible to configure which of these interactions are allowed on a per resource basis through a set of interaction rules specified via the `fhirServer/resources/<resourceType>/interactions` property in `fhir-server-config.json`. The following snippet shows the general form for specifying interaction rules:\n\n```\n\"resources\": {\n    \"open\": true,\n    \"Condition\": {\n        \"interactions\": [\"create\", \"read\", \"vread\", \"history\", \"search\", \"update\", \"patch\", \"delete\"]\n    },\n    \"Observation\": {\n        \"interactions\": [\"create\", \"read\", \"vread\", \"history\", \"delete\"]\n    },\n    \"Patient\": {\n        \"interactions\": [\"read\", \"vread\", \"history\", \"search\"]\n    },\n    \"Procedure\": {\n        \"interactions\": [\"create\", \"read\", \"vread\", \"history\", \"delete\"]\n    }\n}\n```\n\nThe `fhirServer/resources/<resourceType>/interactions` property is a JSON array of strings that represent the RESTful interactions allowed for the given resource type. If an interaction is not in the list of strings specified for a resource type, that interaction will not be allowed for that resource type. In the example above, the following interactions are allowed for the `Observation` resource type: [`create`, `read`, `vread`, `history`, `delete`]. This means a user will not be able to search for `Observation` resources because the `search` interaction is not specified in the list of allowed interactions.\n\nOmitting the `fhirServer/resources/<resourceType>/interactions` property is equivalent to allowing all interactions for a given resource type. An empty array, `[]`, can be used to indicate that no interactions are allowed. Additionally, to define the set of interactions allowed for resource types which are not specifically configured in the `fhirServer/resources` property group, or for resource types which are configured, but which do not specify the `fhirServer/resources/<resourceType>/interactions` property, the base type of `Resource` may be specified:\n\n```\n\"resources\": {\n    \"open\": true,\n    \"Condition\": {\n        \"interactions\": [\"create\", \"read\", \"vread\", \"history\", \"search\", \"update\", \"delete\"]\n    },\n    \"Observation\": {\n        \"interactions\": [\"create\", \"read\", \"vread\", \"history\", \"delete\"]\n    },\n    \"Patient\": {\n        \"interactions\": [\"read\", \"vread\", \"history\", \"search\"]\n    },\n    \"Procedure\": {\n    },\n    \"Resource\": {\n        \"interactions\": [\"create\", \"read\", \"vread\", \"history\", \"search\", \"update\", \"patch\", \"delete\"]\n    }\n}\n```\n\nIn the example above, for any resource type which is not specifically configured, such as `Encounter`, or for any resource type which is configured but does not specify the `fhirServer/resources/<resourceType>/interactions` property, such as `Procedure`, all of the interactions listed for the `Resource` resource type will be allowed.\n\nOne final consideration when configuring interactions is the `fhirServer/resources/open` property. If this property is specified and its value is set to `false`, then no interactions will be allowed for resource types which are not specifically listed in the `fhirServer/resources` property group. Assume the following configuration:\n\n```\n\"resources\": {\n    \"open\": false,\n    \"Condition\": {\n        \"interactions\": [\"create\", \"read\", \"vread\", \"history\", \"search\", \"update\", \"delete\"]\n    },\n    \"Observation\": {\n        \"interactions\": [\"create\", \"read\", \"vread\", \"history\", \"delete\"]\n    },\n    \"Patient\": {\n        \"interactions\": [\"read\", \"vread\", \"history\", \"search\"]\n    }\n}\n```\n\nIn this case, since the `fhirServer/resources/open` property is set to `false`, only the resource types listed (`Condition`, `Observation`, `Patient`) are allowed to be interacted with via the FHIR REST API. For example, a `create` request of a `Procedure` resource will fail since that resource type is not specified.\n\nWhole-system search and whole-system history are special cases. Since no resource type is specified on a whole-system request, validation will be done against the `Resource` resource type. In the above configuration example, a whole-system search request such as `GET [base]?_lastUpdated=gt2020-01-01` will fail because the `Resource` resource type is not specified. If the configuration were to have the `fhirServer/resources/open` property set to `true`, or if the `Resource` resource type were specified in the `fhirServer/resources` property group, then the whole-system search request would be allowed, assuming the `search` interaction was valid for the `Resource` resource type.\n\nIn addition to interaction configuration, the `fhirServer/resources` property group also provides the ability to configure search parameter filtering and profile validation. See [Search configuration](https://ibm.github.io/FHIR/guides/FHIRSearchConfiguration#12-filtering) and [Resource validation](#44-resource-validation) respectively for details.\n\n## 4.12.1 Using the IBM FHIR Server behind a proxy\nIt is possible to run the IBM FHIR Server behind a reverse proxy such as Kubernetes Ingress or an API Gateway.\n\nBecause the FHIR API relies on links and references between resources (both absolute and relative), operators must ensure that the IBM FHIR Server is configured appropriately for the front-end URL being used by the FHIR clients.\n\nThis can be accomplished by configuring the `fhirServer/core/originalRequestUriHeaderName` property in the default fhir-server-config.json. When this parameter is configured, the IBM FHIR Server will use the value of the corresponding header to set the \"originalRequestUri\" for the scope of the request.\n\nFor example, consider a FHIR Server that is listening at https://fhir:9443/fhir-server/api/v4 and is configured with an  originalRequestUriHeaderName of `X-FHIR-FORWARDED-URL`. If this server is proxied by a server at https://example.com/fhir, then the proxy must set the `X-FHIR-FORWARDED-URL` header to the value of the front-end request URL (e.g. https://example.com/fhir/Patient/abc-123).\n\nThe originalRequestUriHeader is expected to contain the full path of the original request. Values with no scheme (e.g. `https://`) will be handled like relative URLs, but full URL values (including scheme, hostname, optional port, and path) are recommended. Query string values can be included in the header value but will be ignored by the server; the server will use the query string of the actual request to process the request.\n\n# 5 Appendix\n\n## 5.1 Configuration properties reference\nThis section contains reference information about each of the configuration properties supported by the FHIR server.\n\n### 5.1.1 Property descriptions\n| Property Name                 | Type | Description     |\n|-------------------------------|------|-----------------|\n|`fhirServer/core/defaultPrettyPrint`|boolean|A boolean flag which indicates whether \"Pretty Printing\" should be used by default. Applies to both XML and JSON.|\n|`fhirServer/core/tenantIdHeaderName`|string|The name of the request header that will be used to specify the tenant-id for each incoming FHIR REST API request. For headers with semicolon-delimited parts, setting a header name like `<headerName>:<partName>` will select the value from the part of header `<headerName>`'s value with a name of `<partName>` (e.g. setting `X-Test:part1` would select `someValue` from the header `X-Test: part1=someValue;part2=someOtherValue`).|\n|`fhirServer/core/dataSourceIdHeaderName`|string|The name of the request header that will be used to specify the datastore-id for each incoming FHIR REST API request. For headers with semicolon-delimited parts, setting a header name like `<headerName>:<partName>` will select the value from the part of header `<headerName>`'s value with a name of `<partName>` (e.g. setting `X-Test:part1` would select `someValue` from the header `X-Test: part1=someValue;part2=someOtherValue`).|\n|`fhirServer/core/originalRequestUriHeaderName`|string|The name of the request header that will be used to indicate the original, end-user-facing, request URI for a given request. This optional config parameter is provided for cases where the server is deployed behind a reverse proxy that overwrites the host and/or path portions of the original request.|\n|`fhirServer/core/defaultHandling`|string|The default handling preference of the server (*strict* or *lenient*) which determines how the server handles unrecognized search parameters and resource elements.|\n|`fhirServer/core/allowClientHandlingPref`|boolean|Indicates whether the client is allowed to override the server default handling preference using the `Prefer:handling` header value part.|\n|`fhirServer/core/checkReferenceTypes`|boolean|Indicates whether reference type checking is performed by the server during parsing / deserialization.|\n|`fhirServer/core/serverRegistryResourceProviderEnabled`|boolean|Indicates whether the server registry resource provider should be used by the FHIR registry component to access definitional resources through the persistence layer.|\n|`fhirServer/core/conditionalDeleteMaxNumber`|integer|The max number of matches supported in conditional delete. |\n|`fhirServer/core/capabilityStatementCacheTimeout`|integer|The number of minutes that a tenant's CapabilityStatement is cached for the metadata endpoint. |\n|`fhirServer/core/extendedCodeableConceptValidation`|boolean|A boolean flag which indicates whether extended validation is performed by the server during object construction for code, Coding, CodeableConcept, Quantity, Uri, and String elements which have required bindings to value sets.|\n|`fhirServer/core/disabledOperations`|string|A comma-separated list of operations which are not allowed to run on the IBM FHIR Server, for example, `validate,import`. Note, do not include the dollar sign `$`|\n|`fhirServer/term/graphTermServiceProvider/enabled`|boolean|Indicates whether the graph term service provider should be used by the FHIR term service to access code system content|\n|`fhirServer/term/graphTermServiceProvider/timeLimit`|integer|Graph traversal time limit (in milliseconds)|\n|`fhirServer/term/graphTermServiceProvider/configuration`|object (name/value pairs)|A JSON object that contains the name/value pairs used to configure the graph database behind the graph term service provider see: [https://docs.janusgraph.org/basics/configuration-reference/](https://docs.janusgraph.org/basics/configuration-reference/)|\n|`fhirServer/resources/open`|boolean|Whether resources that are not explicitly listed in the configuration should be supported by the FHIR Server REST layer. When open is set to `false`, only the resources listed in fhir-server-config.json are supported.|\n|`fhirServer/resources/Resource/interactions`|string list|A list of strings that represent the RESTful interactions (create, read, vread, update, patch, delete, history, and/or search) supported for resource types. Omitting this property is equivalent to supporting all FHIR interactions for the supported resources. An empty list, `[]`, can be used to indicate that no REST methods are supported. This property can be overridden for specific resource types via the `fhirServer/resources/<resourceType>/interactions` property.|\n|`fhirServer/resources/Resource/searchParameters`|object|The set of search parameters to support for all supported resource types. Omitting this property is equivalent to supporting all search parameters in the server's registry that apply to resource type \"Resource\" (all resources). An empty object, `{}`, can be used to indicate that no global search parameters are supported.|\n|`fhirServer/resources/Resource/searchParameters/<code>`|string|The URL of the search parameter definition to use for the search parameter `<code>`. Individual resource types may override this value via `fhirServer/resources/<resourceType>/searchParameters/<code>`|\n|`fhirServer/resources/Resource/searchIncludes`|string list|A comma-separated list of \\_include values supported for all resource types. Individual resource types may override this value via `fhirServer/resources/<resourceType>/searchIncludes`. Omitting this property is equivalent to supporting all \\_include values for the supported resources. An empty list, `[]`, can be used to indicate that no \\_include values are supported.|\n|`fhirServer/resources/Resource/searchRevIncludes`|string list|A comma-separated list of \\_revinclude values supported for all resource types. Individual resource types may override this value via `fhirServer/resources/<resourceType>/searchRevIncludes`. Omitting this property is equivalent to supporting all \\_revinclude values for the supported resources. An empty list, `[]`, can be used to indicate that no \\_revinclude values are supported.|\n|`fhirServer/resources/Resource/searchParameterCombinations`|string list|A comma-separated list of search parameter combinations supported for all resource types. Each search parameter combination is a string, where a plus sign, `+`, separates the search parameters that can be used in combination. To indicate that searching without any search parameters is allowed, an empty string must be included in the list. Including an asterisk, `*`, in the list indicates support of any search parameter combination. Individual resource types may override this value via `fhirServer/resources/<resourceType>/searchParameterCombinations`. Omitting this property is equivalent to supporting any search parameter combination.|\n|`fhirServer/resources/Resource/profiles/atLeastOne`|string list|A comma-separated list of profiles, at least one of which must be specified in a resource's `meta.profile` element and successfully validated against in order for a resource to be persisted to the FHIR server. Individual resource types may override this value via `fhirServer/resources/<resourceType>/profiles/atLeastOne`. Omitting this property or specifying an empty list is equivalent to not requiring any profile assertions for a resource.|\n|`fhirServer/resources/<resourceType>/interactions`|string list|A list of strings that represent the RESTful interactions (create, read, vread, update, patch, delete, history, and/or search) to support for this resource type. For resources without the property, the value of `fhirServer/resources/Resource/interactions` is used.|\n|`fhirServer/resources/<resourceType>/searchParameters`|object|The set of search parameters to support for this resource type. Global search parameters defined on the `Resource` resource can be overridden on a per-resourceType basis.|\n|`fhirServer/resources/<resourceType>/searchParameters/<code>`|string|The URL of the search parameter definition to use for the search parameter `<code>` on resources of type `<resourceType>`.|\n|`fhirServer/resources/<resourceType>/searchIncludes`|string list|A comma-separated list of \\_include values supported for this resource type. An empty list, `[]`, can be used to indicate that no \\_include values are supported. For resources without the property, the value of `fhirServer/resources/Resource/searchIncludes` is used.|\n|`fhirServer/resources/<resourceType>/searchRevIncludes`|string list|A comma-separated list of \\_revinclude values supported for this resource type. An empty list, `[]`, can be used to indicate that no \\_revinclude values are supported. For resources without the property, the value of `fhirServer/resources/Resource/searchRevIncludes` is used.|\n|`fhirServer/resources/<resourceType>/searchParameterCombinations`|string list|A comma-separated list of search parameter combinations supported for this resource type. Each search parameter combination is a string, where a plus sign, `+`, separates the search parameters that can be used in combination. To indicate that searching without any search parameters is allowed, an empty string must be included in the list. Including an asterisk, `*`, in the list indicates support of any search parameter combination. For resources without the property, the value of `fhirServer/resources/Resource/searchParameterCombinations` is used.|\n|`fhirServer/resources/<resourceType>/profiles/atLeastOne`|string list|A comma-separated list of profiles, at least one of which must be specified in a resource's `meta.profile` element and be successfully validated against in order for a resource of this type to be persisted to the FHIR server. If this property is not specified, or if an empty list is specified, the value of `fhirServer/resources/Resource/profiles/atLeastOne` will be used.|\n|`fhirServer/notifications/common/includeResourceTypes`|string list|A comma-separated list of resource types for which notification event messages should be published.|\n|`fhirServer/notifications/websocket/enabled`|boolean|A boolean flag which indicates whether or not websocket notifications are enabled.|\n|`fhirServer/notifications/kafka/enabled`|boolean|A boolean flag which indicates whether or not kafka notifications are enabled.|\n|`fhirServer/notifications/kafka/topicName`|string|The name of the topic to which kafka notification event messages should be published.|\n|`fhirServer/notifications/kafka/connectionProperties`|property list|A group of connection properties used to configure the KafkaProducer. These properties are used as-is when instantiating the KafkaProducer used by the FHIR server for publishing notification event messages.|\n|`fhirServer/notifications/nats/enabled`|boolean|A boolean flag which indicates whether or not NATS notifications are enabled.|\n|`fhirServer/notifications/nats/cluster`|string|The name of the NATS streaming cluster to which to connect.|\n|`fhirServer/notifications/nats/channel`|string|The name of the NATS channel on which NATS notification event messages are to be published.|\n|`fhirServer/notifications/nats/clientId`|string|The name to use for the connections to the NATS streaming cluster.|\n|`fhirServer/notifications/nats/servers`|string|The URL of one or more NATS servers in the NATS streaming cluster.|\n|`fhirServer/notifications/nats/useTLS`|boolean|A boolean flag which indicates whether or not to use TLS for connections to the NATS streaming cluster.|\n|`fhirServer/notifications/nats/truststoreLocation`|string|The file location of the truststore to use for TLS.|\n|`fhirServer/notifications/nats/truststorePassword`|string|The password for the truststore.|\n|`fhirServer/notifications/nats/keystoreLocation`|string|The file location of the keystore to use for TLS.|\n|`fhirServer/notifications/nats/keystorePassword`|string|The password for the keystore.|\n|`fhirServer/persistence/factoryClassname`|string|The name of the factory class to use for creating instances of the persistence layer implementation.|\n|`fhirServer/persistence/common/updateCreateEnabled`|boolean|A boolean flag which indicates whether or not the 'update/create' feature should be enabled in the selected persistence layer.|\n|`fhirServer/persistence/datasources`|map|A map containing datasource definitions. See [Section 3.3.1 The JDBC persistence layer](#331-the-jdbc-persistence-layer) for more information.|\n|`fhirServer/persistence/datasources/<datasourceId>/type`|string|`derby` or `db2` or `postgresql`|\n|`fhirServer/persistence/datasources/<datasourceId>/searchOptimizerOptions/from_collapse_limit`|int| For PostgreSQL, sets the from_collapse_limit query optimizer parameter to improve search performance. If not set, the IBM FHIR Server uses a value of 12. To use the database default (8), explicitly set this value to null. |\n|`fhirServer/persistence/datasources/<datasourceId>/searchOptimizerOptions/join_collapse_limit`|int| For PostgreSQL, sets the join_collapse_limit query optimizer parameter to improve search performance. If not set, the IBM FHIR Server uses a value of 12. To use the database default (8), explicitly set this value to null. |\n|`fhirServer/security/cors`|boolean|Used to convey to clients whether cors is supported or not; actual cors support is configured separately in the Liberty server.xml configuration|\n|`fhirServer/security/basic/enabled`|boolean|Whether or not the server is enabled for HTTP Basic authentication|\n|`fhirServer/security/certificates/enabled`|boolean|Whether or not the server is enabled for Certificate-based client authentication|\n|`fhirServer/security/oauth/enabled`|boolean|Whether or not the server is enabled for OAuth-based authentication/authorization|\n|`fhirServer/security/oauth/regUrl`|string|The registration URL associated with the OAuth 2.0 authentication/authorization support.|\n|`fhirServer/security/oauth/authUrl`|string|The authorization URL associated with the OAuth 2.0 authentication/authorization support.|\n|`fhirServer/security/oauth/tokenUrl`|string|The token URL associated with the OAuth 2.0 authentication/authorization support.|\n|`fhirServer/security/oauth/manageUrl`|string|The URL where an end-user can view which applications currently have access to data and can make adjustments to these access rights.|\n|`fhirServer/security/oauth/introspectUrl`|string|The URL of the server’s introspection endpoint that can be used to validate a token.|\n|`fhirServer/security/oauth/revokeUrl`|string|The URL to the server’s endpoint that can be used to revoke a token.|\n|`fhirServer/security/oauth/smart/enabled`|boolean|Whether or not the server is enabled for OAuth-based authentication/authorization|\n|`fhirServer/security/oauth/smart/scopes`|array|The list of SMART scopes to advertise in the `.well-known/smart-configuration endpoint|\n|`fhirServer/security/oauth/smart/capabilities`|array|The list of SMART capabilities to advertise in the `.well-known/smart-configuration endpoint|\n|`fhirServer/audit/serviceClassName`|string|The audit service to use. Currently, com.ibm.fhir.audit.impl.NopService to indicate the logger service is disabled, and com.ibm.fhir.audit.impl.KafkaService to indicate using Kafka as a destination.|\n|`fhirServer/audit/serviceProperties/auditTopic`|string|The kafka topic to use for CADF audit logging service|\n|`fhirServer/audit/serviceProperties/geoCity`|string|The Geo City configured for audit logging service.|\n|`fhirServer/audit/serviceProperties/geoState`|string|The Geo State configured for audit logging service.|\n|`fhirServer/audit/serviceProperties/geoCounty`|string|The Geo Country configured for audit logging service.|\n|`fhirServer/audit/serviceProperties/kafkaServers`|string|The CSV list of Kafka brokers.|\n|`fhirServer/audit/serviceProperties/kafkaApiKey`|string|The apikey for the JAAS configuration.|\n|`fhirServer/audit/serviceProperties/mapper`|string|The AuditEventLog mapper that determines the output format - valid types are 'cadf' and 'auditevent'. 'auditevent' refers to the FHIR Resource AuditEvent, and 'cadf' refers to the Cloud logging standard.|\n|`fhirServer/audit/serviceProperties/load`|string|The location that the configuration is loaded from 'environment' or 'config'.|\n|`fhirServer/audit/serviceProperties/kafka`|object|A set of name value pairs used as part of the 'config' for publishing to the kafka service. These should only be Kafka properties.|\n|`fhirServer/audit/hostname`|string|A string used to identify the Hostname, useful in containerized environments|\n|`fhirServer/audit/ip`|string|A string used to identify the IP address, useful to identify only one IP|\n|`fhirServer/search/useBoundingRadius`|boolean|True, the bounding area is a Radius, else the bounding area is a box.|\n|`fhirServer/search/useStoredCompartmentParam`|boolean|False, Compute and store parameter to accelerate compartment searches. Requires reindex using at least IBM FHIR Server version 4.5.1 before this feature is enabled |\n|`fhirServer/bulkdata/enabled`| string|Enabling the BulkData operations |\n|`fhirServer/bulkdata/core/api/url`|string|The URL to access the FHIR server hosting the batch web application |\n|`fhirServer/bulkdata/core/api/user`|string|User for submitting JavaBatch job |\n|`fhirServer/bulkdata/core/api/password`|string|Password for above batch user |\n|`fhirServer/bulkdata/core/api/truststore`|string|Trust store for JavaBatch job submission |\n|`fhirServer/bulkdata/core/api/truststorePassword`|string|Password for above trust store |\n|`fhirServer/bulkdata/core/api/trustAll`|boolean|Indicates calls to the local API should skip hostname verification|\n|`fhirServer/bulkdata/core/cos/partUploadTriggerSizeMB`|number|The size, in megabytes, at which to write a \"part\" for multi-part uploads. The S3 API requires parts to be between 5 and 5000 MB and does not allow more than 10,000 parts per object. |\n|`fhirServer/bulkdata/core/cos/objectSizeThresholdMB`|number|The size, in megabytes, at which to finish writing a given object. Use `0` to indicate that all resources of a given type should be written to a single object, but be aware that S3 objects can have a maximum of 10,000 parts and a maximum size of 5,000,000 MB (5 TB). |\n|`fhirServer/bulkdata/core/cos/objectResourceCountThreshold`|number|The number of resources at which to finish writing a given object. The actual number of resources written to a single object may be slightly above this number, dependent on the configured page size. Use `0` to indicate that there is no limit to the number of resources to be written to a single object.|\n|`fhirServer/bulkdata/core/cos/requestTimeout`|number|The request timeout in second for the COS client|\n|`fhirServer/bulkdata/core/cos/socketTimeout`|number|The socket timeout in second for the COS client|\n|`fhirServer/bulkdata/core/cos/useServerTruststore`|boolean|If the COS Client should use the IBM FHIR Server's TrustStore to access S3/IBMCOS service |\n|`fhirServer/bulkdata/core/cos/presignedExpiry`|number|The time in seconds of the presigned download URL; must be using HMAC auth|\n|`fhirServer/bulkdata/core/file/writeTriggerSizeMB`|number|The size, in megabytes, at which to write the buffer to file.|\n|`fhirServer/bulkdata/core/file/sizeThresholdMB`|number|The size, in megabytes, at which to finish writing a given file. Use `0` to indicate that all resources of a given type should be written to a single file.|\n|`fhirServer/bulkdata/core/file/resourceCountThreshold`|number|The number of resources at which to finish writing a given file. The actual number of resources written to a single file may be slightly above this number, dependent on the configured page size. Use `0` to indicate that there is no limit to the number of resources to be written to a single file.|\n|`fhirServer/bulkdata/core/batchIdEncryptionKey`|string|Encoding key for JavaBatch job id |\n|`fhirServer/bulkdata/core/pageSize`|number|The search page size for patient/group export and the legacy export, the default value is 1000 |\n|`fhirServer/bulkdata/core/maxPartitions`|number| The maximum number of simultaneous partitions that are processed per Export and Import |\n|`fhirServer/bulkdata/core/maxInputs`|number| The number of inputs allowed for $import |\n|`fhirServer/bulkdata/core/iamEndpoint`|string| Override the system's IAM endpoint |\n|`fhirServer/bulkdata/core/maxChunkReadTime`|string| Max time in milliseconds to read during a bulkdata export without type filters. The time should be three quarters of the transactionManager timeout (often the FHIR_TRANSACTION_MANAGER_TIMEOUT value). Note, this value is a string representation of a long value.|\n|`fhirServer/bulkdata/storageProviders/<source>/type`|string|The type of storageProvider aws-s3, ibm-cos, file, https |\n|`fhirServer/bulkdata/storageProviders/<source>/bucketName`|string| Object store bucket name |\n|`fhirServer/bulkdata/storageProviders/<source>/location`|string|Object store location |\n|`fhirServer/bulkdata/storageProviders/<source>/endpointInternal`|string|Object store end point url used to read/write from COS |\n|`fhirServer/bulkdata/storageProviders/<source>/endpointExternal`|string|Object store end point url used in the constructed download URLs|\n|`fhirServer/bulkdata/storageProviders/<source>/fileBase`|string| The absolute path of the output directory |\n|`fhirServer/bulkdata/storageProviders/<source>/validBaseUrls`|list|The list of supported urls which are approved for the fhir server to access|\n|`fhirServer/bulkdata/storageProviders/<source>/disableBaseUrlValidation`|boolean|Disables the URL checking feature, allowing all URLs to be imported|\n|`fhirServer/bulkdata/storageProviders/<source>/exportPublic`|boolean|Whether or not the server is configured to support export to parquet; to properly enable it the administrator must first make spark and stocator available to the fhir-bulkdata-webapp (e.g through the shared lib at `wlp/user/shared/resources/lib`)|\n|`fhirServer/bulkdata/storageProviders/<source>/enableParquet`|boolean|If give public read only access to the exported files|\n|`fhirServer/bulkdata/storageProviders/<source>/disableOperationOutcomes`|boolean|Disables the base url validation, allowing all URLs to be imported|\n|`fhirServer/bulkdata/storageProviders/<source>/duplicationCheck`|boolean|Enables duplication check on import|\n|`fhirServer/bulkdata/storageProviders/<source>/validateResources`|boolean|Enables the validation of imported resources|\n|`fhirServer/bulkdata/storageProviders/<source>/presigned`|boolean|When an hmac auth type is used, presigns the URLs of an export|\n|`fhirServer/bulkdata/storageProviders/<source>/create`|boolean|Enables the creation of buckets|\n|`fhirServer/bulkdata/storageProviders/<source>/auth/type`|string|A type of hmac, iam, or basic|\n|`fhirServer/bulkdata/storageProviders/<source>/accessKeyId`|string|For HMAC, API key for accessing COS |\n|`fhirServer/bulkdata/storageProviders/<source>/secretAccessKey`|string|For HMAC, secret key for accessing COS |\n|`fhirServer/bulkdata/storageProviders/<source>/iamApiKey`|string|For IAM, API key for accessing IBM COS |\n|`fhirServer/bulkdata/storageProviders/<source>/iamResourceInstanceId`|string|For IAM, secret key for accessing IBM COS |\n|`fhirServer/bulkdata/storageProviders/<source>/user`|string|For basic, user COS |\n|`fhirServer/bulkdata/storageProviders/<source>/secretAccessKey`|string|For basic, password for accessing COS |\n\n\n### 5.1.2 Default property values\n| Property Name                 | Default value   |\n|-------------------------------| ----------------|\n|`fhirServer/core/defaultPrettyPrint`|false|\n|`fhirServer/core/tenantIdHeaderName`|X-FHIR-TENANT-ID|\n|`fhirServer/core/dataSourceIdHeaderName`|X-FHIR-DSID|\n|`fhirServer/core/originalRequestUriHeaderName`|null|\n|`fhirServer/core/defaultHandling`|strict|\n|`fhirServer/core/allowClientHandlingPref`|true|\n|`fhirServer/core/checkReferenceTypes`|true|\n|`fhirServer/core/serverRegistryResourceProviderEnabled`|false|\n|`fhirServer/core/conditionalDeleteMaxNumber`|10|\n|`fhirServer/core/capabilityStatementCacheTimeout`|60|\n|`fhirServer/core/extendedCodeableConceptValidation`|true|\n|`fhirServer/term/graphTermServiceProvider/enabled`|false|\n|`fhirServer/term/graphTermServiceProvider/timeLimit`|90000|\n|`fhirServer/resources/open`|true|\n|`fhirServer/resources/Resource/interactions`|null (all interactions supported)|\n|`fhirServer/resources/Resource/searchParameters`|null (all global search parameters supported)|\n|`fhirServer/resources/Resource/searchIncludes`|null (all \\_include values supported)|\n|`fhirServer/resources/Resource/searchRevIncludes`|null (all \\_revinclude values supported)|\n|`fhirServer/resources/Resource/searchParameterCombinations`|null (all search parameter combinations supported)|\n|`fhirServer/resources/Resource/profiles/atLeastOne`|null (no resource profile assertions required)|\n|`fhirServer/resources/<resourceType>/interactions`|null (inherits from `fhirServer/resources/Resource/interactions`)|\n|`fhirServer/resources/<resourceType>/searchParameters`|null (all type-specific search parameters supported)|\n|`fhirServer/resources/<resourceType>/searchParameters/<code>`|null|\n|`fhirServer/resources/<resourceType>/searchIncludes`|null (inherits from `fhirServer/resources/Resource/searchIncludes`)|\n|`fhirServer/resources/<resourceType>/searchRevIncludes`|null (inherits from `fhirServer/resources/Resource/searchRevIncludes`)|\n|`fhirServer/resources/<resourceType>/searchParameterCombinations`|null (inherits from `fhirServer/resources/Resource/searchParameterCombinations`)|\n|`fhirServer/resources/<resourceType>/profiles/atLeastOne`|null (inherits from `fhirServer/resources/Resource/profiles/atLeastOne`)|\n|`fhirServer/notifications/common/includeResourceTypes`|`[\"*\"]`|\n|`fhirServer/notifications/websocket/enabled`|false|\n|`fhirServer/notifications/kafka/enabled`|false|\n|`fhirServer/notifications/kafka/topicName`|fhirNotifications|\n|`fhirServer/notifications/kafka/connectionProperties`|`{}`|\n|`fhirServer/notifications/nats/enabled`|false|\n|`fhirServer/notifications/nats/cluster`|nats-streaming|\n|`fhirServer/notifications/nats/channel`|fhirNotifications|\n|`fhirServer/notifications/nats/clientId`|fhir-server|\n|`fhirServer/notifications/nats/servers`||\n|`fhirServer/notifications/nats/useTLS`|true|\n|`fhirServer/notifications/nats/truststoreLocation`||\n|`fhirServer/notifications/nats/truststorePassword`||\n|`fhirServer/notifications/nats/keystoreLocation`||\n|`fhirServer/notifications/nats/keystorePassword`||\n|`fhirServer/persistence/factoryClassname`|com.ibm.fhir.persistence.jdbc.FHIRPersistenceJDBCFactory|\n|`fhirServer/persistence/common/updateCreateEnabled`|true|\n|`fhirServer/persistence/datasources`|embedded Derby database: derby/fhirDB|\n|`fhirServer/persistence/datasources/<datasourceId>/type`|derby|\n|`fhirServer/persistence/datasources/<datasourceId>/searchOptimizerOptions/from_collapse_limit`|16|\n|`fhirServer/persistence/datasources/<datasourceId>/searchOptimizerOptions/join_collapse_limit`|16|\n|`fhirServer/security/cors`|boolean|true|\n|`fhirServer/security/basic/enabled`|boolean|false|\n|`fhirServer/security/certificates/enabled`|boolean|false|\n|`fhirServer/security/oauth/enabled`|boolean|false|\n|`fhirServer/security/oauth/regUrl`|\"\"|\n|`fhirServer/security/oauth/authUrl`|\"\"|\n|`fhirServer/security/oauth/tokenUrl`|\"\"|\n|`fhirServer/security/oauth/manageUrl`|\"\"|\n|`fhirServer/security/oauth/introspectUrl`|\"\"|\n|`fhirServer/security/oauth/revokeUrl`|\"\"|\n|`fhirServer/security/oauth/smart/enabled`|boolean|false|\n|`fhirServer/security/oauth/smart/scopes`|array|null|\n|`fhirServer/security/oauth/smart/capabilities`|array|null|\n|`fhirServer/audit/serviceClassName`|\"\"|\n|`fhirServer/audit/serviceProperties/auditTopic`|FHIR_AUDIT|\n|`fhirServer/audit/serviceProperties/geoCity`|UnknownCity|\n|`fhirServer/audit/serviceProperties/geoState`|UnknownState|\n|`fhirServer/audit/serviceProperties/geoCounty`|UnknownCountry|\n|`fhirServer/audit/serviceProperties/mapper`|cadf|\n|`fhirServer/audit/serviceProperties/load`|environment|\n|`fhirServer/bulkdata/isExportPublic`|true|\n|`fhirServer/bulkdata/validBaseUrlsDisabled`|false|\n|`fhirServer/bulkdata/cosFileMaxResources`|200000|\n|`fhirServer/bulkdata/cosFileMaxSize`|209715200|\n|`fhirServer/bulkdata/patientExportPageSize`|200|\n|`fhirServer/bulkdata/useFhirServerTrustStore`|false|\n|`fhirServer/bulkdata/enableParquet`|false|\n|`fhirServer/bulkdata/ignoreImportOutcomes`|false|\n|`fhirServer/bulkdata/enabled`|true |\n|`fhirServer/bulkdata/core/api/trustAll`|false|\n|`fhirServer/bulkdata/core/cos/partUploadTriggerSizeMB`|10 |\n|`fhirServer/bulkdata/core/cos/objectSizeThresholdMB`|200 |\n|`fhirServer/bulkdata/core/cos/objectResourceCountThreshold`|200000|\n|`fhirServer/bulkdata/core/cos/requestTimeout`|120|\n|`fhirServer/bulkdata/core/cos/socketTimeout`|120|\n|`fhirServer/bulkdata/core/cos/useServerTruststore`|false|\n|`fhirServer/bulkdata/core/cos/presignedExpiry`|86400|\n|`fhirServer/bulkdata/core/pageSize`|1000|\n|`fhirServer/bulkdata/core/maxPartitions`|5|\n|`fhirServer/bulkdata/core/maxInputs`|5|\n|`fhirServer/bulkdata/core/iamEndpoint`|https://iam.cloud.ibm.com/oidc/token|\n|`fhirServer/bulkdata/core/maxChunkReadTime`|90000|\n|`fhirServer/bulkdata/storageProviders/<source>/disableBaseUrlValidation`|false|\n|`fhirServer/bulkdata/storageProviders/<source>/exportPublic`|false|\n|`fhirServer/bulkdata/storageProviders/<source>/enableParquet`|false|\n|`fhirServer/bulkdata/storageProviders/<source>/disableOperationOutcomes`|false|\n|`fhirServer/bulkdata/storageProviders/<source>/duplicationCheck`|false|\n|`fhirServer/bulkdata/storageProviders/<source>/validateResources`|false|\n|`fhirServer/bulkdata/storageProviders/<source>/presigned`|false|\n|`fhirServer/bulkdata/storageProviders/<source>/create`|false|\n\n### 5.1.3 Property attributes\nDepending on the context of their use, config properties can be:\n* tenant-specific or global\n* dynamic or static\n\nThe following table tracks which properties can be set on a tenant-specific basis\nand which properties are loaded dynamically.\nIf you change a properties that has an `N` in the `Dynamic?` column, it means you\nmust restart the server for that change to take effect.\n\n| Property Name                 | Tenant-specific? | Dynamic? |\n|-------------------------------|------------------|----------|\n|`fhirServer/core/defaultPrettyPrint`|Y|Y|\n|`fhirServer/core/tenantIdHeaderName`|N|N|\n|`fhirServer/core/dataSourceIdHeaderName`|N|N|\n|`fhirServer/core/originalRequestUriHeaderName`|N|N|\n|`fhirServer/core/defaultHandling`|Y|Y|\n|`fhirServer/core/allowClientHandlingPref`|Y|Y|\n|`fhirServer/core/checkReferenceTypes`|N|N|\n|`fhirServer/core/serverRegistryResourceProviderEnabled`|N|N|\n|`fhirServer/core/conditionalDeleteMaxNumber`|Y|Y|\n|`fhirServer/core/capabilityStatementCacheTimeout`|Y|Y|\n|`fhirServer/core/extendedCodeableConceptValidation`|N|N|\n|`fhirServer/core/disabledOperations`|N|N|\n|`fhirServer/term/graphTermServiceProvider/enabled`|N|N|\n|`fhirServer/term/graphTermServiceProvider/timeLimit`|N|N|\n|`fhirServer/term/graphTermServiceProvider/configuration`|N|N|\n|`fhirServer/resources/open`|Y|Y|\n|`fhirServer/resources/Resource/interactions`|Y|Y|\n|`fhirServer/resources/Resource/searchParameters`|Y|Y|\n|`fhirServer/resources/Resource/searchParameters/<code>`|Y|Y|\n|`fhirServer/resources/Resource/searchIncludes`|Y|Y|\n|`fhirServer/resources/Resource/searchRevIncludes`|Y|Y|\n|`fhirServer/resources/Resource/searchParameterCombinations`|Y|Y|\n|`fhirServer/resources/Resource/profiles/atLeastOne`|Y|Y|\n|`fhirServer/resources/<resourceType>/interactions`|Y|Y|\n|`fhirServer/resources/<resourceType>/searchParameters`|Y|Y|\n|`fhirServer/resources/<resourceType>/searchParameters/<code>`|Y|Y|\n|`fhirServer/resources/<resourceType>/searchIncludes`|Y|Y|\n|`fhirServer/resources/<resourceType>/searchRevIncludes`|Y|Y|\n|`fhirServer/resources/<resourceType>/searchParameterCombinations`|Y|Y|\n|`fhirServer/resources/<resourceType>/profiles/atLeastOne`|Y|Y|\n|`fhirServer/notifications/common/includeResourceTypes`|N|N|\n|`fhirServer/notifications/websocket/enabled`|N|N|\n|`fhirServer/notifications/kafka/enabled`|N|N|\n|`fhirServer/notifications/kafka/topicName`|N|N|\n|`fhirServer/notifications/kafka/connectionProperties`|N|N|\n|`fhirServer/notifications/nats/enabled`|N|N|\n|`fhirServer/notifications/nats/cluster`|N|N|\n|`fhirServer/notifications/nats/channel`|N|N|\n|`fhirServer/notifications/nats/clientId`|N|N|\n|`fhirServer/notifications/nats/servers`|N|N|\n|`fhirServer/notifications/nats/useTLS`|N|N|\n|`fhirServer/notifications/nats/truststoreLocation`|N|N|\n|`fhirServer/notifications/nats/truststorePassword`|N|N|\n|`fhirServer/notifications/nats/keystoreLocation`|N|N|\n|`fhirServer/notifications/nats/keystorePassword`|N|N|\n|`fhirServer/persistence/factoryClassname`|N|N|\n|`fhirServer/persistence/common/updateCreateEnabled`|N|N|\n|`fhirServer/persistence/datasources`|Y|N|\n|`fhirServer/persistence/datasources/<datasourceId>/type`|Y|N|\n|`fhirServer/persistence/datasources/<datasourceId>/searchOptimizerOptions/from_collapse_limit`|Y|Y|\n|`fhirServer/persistence/datasources/<datasourceId>/searchOptimizerOptions/join_collapse_limit`|Y|Y|\n|`fhirServer/security/cors`|Y|Y|\n|`fhirServer/security/basic/enabled`|Y|Y|\n|`fhirServer/security/certificates/enabled`|Y|Y|\n|`fhirServer/security/oauth/enabled`|Y|Y|\n|`fhirServer/security/oauth/regUrl`|Y|Y|\n|`fhirServer/security/oauth/authUrl`|Y|Y|\n|`fhirServer/security/oauth/tokenUrl`|Y|Y|\n|`fhirServer/security/oauth/manageUrl`|Y|Y|\n|`fhirServer/security/oauth/introspectUrl`|Y|Y|\n|`fhirServer/security/oauth/revokeUrl`|Y|Y|\n|`fhirServer/security/oauth/smart/enabled`|Y|Y|\n|`fhirServer/security/oauth/smart/scopes`|Y|Y|\n|`fhirServer/security/oauth/smart/capabilities`|Y|Y|\n|`fhirServer/audit/serviceClassName`|N|N|\n|`fhirServer/audit/serviceProperties/auditTopic`|N|N|\n|`fhirServer/audit/serviceProperties/geoCity`|N|N|\n|`fhirServer/audit/serviceProperties/geoState`|N|N|\n|`fhirServer/audit/serviceProperties/geoCounty`|N|N|\n|`fhirServer/audit/serviceProperties/mapper`|N|N|\n|`fhirServer/audit/serviceProperties/load`|N|N|\n|`fhirServer/audit/hostname`|N|N|\n|`fhirServer/audit/ip`|N|N|\n|`fhirServer/bulkdata/enabled`|Y|Y|\n|`fhirServer/bulkdata/core/api/url`|Y|Y|\n|`fhirServer/bulkdata/core/api/user`|Y|Y|\n|`fhirServer/bulkdata/core/api/password`|Y|Y|\n|`fhirServer/bulkdata/core/api/truststore`|Y|Y|\n|`fhirServer/bulkdata/core/api/truststorePassword`|Y|Y|\n|`fhirServer/bulkdata/core/api/trustAll`|Y|Y|\n|`fhirServer/bulkdata/core/cos/partUploadTriggerSizeMB`|N|N|\n|`fhirServer/bulkdata/core/cos/objectSizeThresholdMB`|N|N|\n|`fhirServer/bulkdata/core/cos/objectResourceCountThreshold`|N|N|\n|`fhirServer/bulkdata/core/cos/requestTimeout`|N|N|\n|`fhirServer/bulkdata/core/cos/socketTimeout`|N|N|\n|`fhirServer/bulkdata/core/cos/useServerTruststore`|Y|Y|\n|`fhirServer/bulkdata/core/cos/presignedExpiry`|Y|Y|\n|`fhirServer/bulkdata/core/batchIdEncryptionKey`|Y|N|\n|`fhirServer/bulkdata/core/pageSize`|Y|Y|\n|`fhirServer/bulkdata/core/maxPartitions`|Y|Y|\n|`fhirServer/bulkdata/core/maxInputs`|Y|Y|\n|`fhirServer/bulkdata/core/iamEndpoint`|N|N|\n|`fhirServer/bulkdata/core/fastTxTimeout`|N|N|\n|`fhirServer/bulkdata/storageProviders/<source>/type`|Y|Y|\n|`fhirServer/bulkdata/storageProviders/<source>/bucketName`|Y|Y|\n|`fhirServer/bulkdata/storageProviders/<source>/location`|Y|Y|\n|`fhirServer/bulkdata/storageProviders/<source>/endpointInternal`|Y|Y|\n|`fhirServer/bulkdata/storageProviders/<source>/endpointExternal`|Y|Y|\n|`fhirServer/bulkdata/storageProviders/<source>/fileBase`|Y|Y|\n|`fhirServer/bulkdata/storageProviders/<source>/validBaseUrls`|Y|Y|\n|`fhirServer/bulkdata/storageProviders/<source>/disableBaseUrlValidation`|Y|Y|\n|`fhirServer/bulkdata/storageProviders/<source>/exportPublic`|Y|Y|\n|`fhirServer/bulkdata/storageProviders/<source>/enableParquet`|Y|Y|\n|`fhirServer/bulkdata/storageProviders/<source>/disableOperationOutcomes`|Y|Y|\n|`fhirServer/bulkdata/storageProviders/<source>/duplicationCheck`|Y|Y|\n|`fhirServer/bulkdata/storageProviders/<source>/validateResources`|Y|Y|\n|`fhirServer/bulkdata/storageProviders/<source>/presigned`|Y|Y|\n|`fhirServer/bulkdata/storageProviders/<source>/create`|Y|Y|\n|`fhirServer/bulkdata/storageProviders/<source>/auth/type`|Y|Y|\n|`fhirServer/bulkdata/storageProviders/<source>/accessKeyId`|Y|Y|\n|`fhirServer/bulkdata/storageProviders/<source>/secretAccessKey`|Y|Y|\n|`fhirServer/bulkdata/storageProviders/<source>/iamApiKey`|Y|Y|\n|`fhirServer/bulkdata/storageProviders/<source>/iamResourceInstanceId`|Y|Y|\n|`fhirServer/bulkdata/storageProviders/<source>/user`|Y|Y|\n|`fhirServer/bulkdata/storageProviders/<source>/secretAccessKey`|Y|Y|\n\n## 5.2 Keystores, truststores, and the IBM FHIR server\n\n### 5.2.1 Background\nAs stated earlier, the FHIR server is installed with a default configuration in `server.xml` which includes the definition of a keystore (`fhirKeyStore.p12`) and a truststore (`fhirTrustStore.p12`)<sup id=\"a7\">[7](#f7)</sup>. These files are provided only as examples and while they may suffice in a test environment, the FHIR server deployer should generate a new keystore and truststore for any installations where security is a concern. Review the information in the following topics to learn how to configure a secure keystore and truststore.\n\n### 5.2.2 WebApp security\nBy default, the FHIR server REST API is only available via HTTPS on port 9443 and is protected by HTTP basic authentication.\nAlternatively, the server can use OpenID Connect and OAuth 2.0 via a Bearer Token as described in [Section 5.2.4 Oauth 2.0](#524-oauth-20).\nIn addition, the FHIR server web application can be secured via client certificate-based authentication.\n\nHere are some notes related to these authentication schemes:\n*   Basic authentication is a very simple authentication scheme and should only be used over HTTPS because the username and password are essentially transmitted in plain text.\n*   OAuth 2.0 authentication can only be used in conjunction with an HTTPS endpoint because the OAuth authorization steps rely on SSL handshake negotiations.\n*   Client certificate-based authentication can only be used in conjunction with an HTTPS endpoint since it involves SSL handshake negotiations. The main value of client authentication is that the server is able to securely authenticate the client through the use of certificates.\n\n### 5.2.3 Configuring mutual TLS authentication\nTo properly configure the FHIR server's keystore and truststore files, perform the following steps.\n\n### 5.2.3.1 Configure the keyStores\n1.  Create a new self-signed server certificate<sup id=\"a8\">[8](#f8)</sup> and store it in a new keystore file located in the `<WLP_HOME>/usr/servers/fhir-server/resources/security` directory.\n\n    In these instructions, we'll call this file `serverKeystore.jks`, although you can name your server keystore file anything you choose. We'll use the `keytool`<sup id=\"a9\">[9](#f9)</sup> command for all keystore- and truststore-related steps, although there are several ways to perform these actions.\n\n    The following command will generate a new self-signed certificate and store it in `serverKeystore.jks`:\n\n    ```\n    keytool -keystore serverKeystore.jks -storepass change-password -genkey\n        -alias default -keyalg RSA -keypass change-password\n    ```\n\n2.  Export the server certificate so that it can be imported into the client's truststore:\n\n    ```\n    keytool -keystore serverKeystore.jks -storepass change-password -export\n        -alias default -file server-public-key.cer\n    ```\n\n3.  Create the client's certificate and store it in `clientKeystore.jks`:\n\n    ```\n    keytool -keystore clientKeystore.jks -storepass change-password -genkey\n        -alias client-auth -keyalg RSA -keypass change-password\n    ```\n\n    Note: `keytool` will prompt you for the various components of the distinguished name (DN) associated with the certificate (similar to Step 1). The value that you specify for the common name (CN) component of the DN must match a username in the basic user registry<sup id=\"a10\">[10](#f10)</sup> configured within the `server.xml` file. This step is crucial for the client certificate-based authentication to work properly. The whole point of this authentication scheme is for the client to transmit its identity to the server via the client certificate, and the client's username must be contained in that certificate (the CN component of the DN) so that the FHIR server can properly authenticate the client.\n\n4.  Export the client's certificate so that it can be imported into the server's truststore:\n\n    ```\n    keytool -keystore clientKeystore.jks -storepass change-password -export -alias client-auth -file client-public-key.cer\n    ```\n\n5.  Import the server's public key certificate into the client's truststore:\n\n    ```\n    keytool -keystore clientTruststore.jks -storepass change-password -import -file server-public-key.cer\n    ```\n\n6.  Import the client's public key certificate into the server's truststore:\n\n    ```\n    keytool -keystore serverTruststore.jks -storepass change-password -import -file client-public-key.cer\n    ```\n\nAt this point, you should have a client keystore that contains a client certificate whose Distinguished Name's Common Name component is set to the username. You should also have a client truststore which contains the server's public key certificate. Essentially, the server and client both have a keystore that contains their own private and public key certificate and they both have a truststore which contains the public key certificate of their counterpart.\n\n### 5.2.3.1 Configure the server\nCopy the server keystore (`serverKeystore.jks`) and truststore (`serverTruststore.jks`) files to the appropriate directory (`<WLP_HOME>/usr/servers/fhir-server/resources/security`). Then configure the `server.xml` file correctly to reference your new keystore and truststore files.\n\n### 5.2.3.2 Configure the client\nThe precise steps required to configure certificate-based authentication for a client application depend on the specific REST API client framework, but these are the general rules:\n\n*   If the client is using the FHIR server's HTTPS endpoint, then the client's truststore should be configured with the certificate of the FHIR server<sup id=\"a11\">[11](#f11)</sup>.\n*   If the client is using basic authentication, then it must send an appropriate Authorization request header containing the username and password information in the HTTP request.\n*   If the client is using client certificate-based Authentication, then the client keystore must be configured with a certificate that is trusted by the FHIR server<sup id=\"a12\">[12](#f12)</sup>.\n*   If the client is using OAuth 2.0 Authentication, then the client keystore must be configured with the REST API client framework. In addition, it must send an appropriate Authorization request header containing the Bearer token in the HTTP request.\n\n## 5.3 OpenID Connect and OAuth 2.0\nThe FHIR specification recommends the use of OpenID Connect and OAuth 2.0.\nThe IBM FHIR Server supports these via either:\n* An external Authorization Server and/or Identity Provider like [IBM Cloud App ID](https://www.ibm.com/cloud/app-id) or [Keycloak](https://www.keycloak.org)\n* Liberty's own OpenID Connect and OAuth 2.0 support\n\nThe following sections focus on the latter and are adapted from the [WebSphere Liberty Knowledge Center](https://www.ibm.com/support/knowledgecenter/SSD28V_liberty/com.ibm.websphere.wlp.core.doc/ae/twlp_config_oidc_pc_examp_beginner.html), but the steps apply to OpenLiberty as well.\n\n### 5.3.1 Configure Liberty as the OpenID Connect Provider\nLiberty can be configured to act as an OpenID Connect Provider via the [openidConnectServer-1.0 feature](https://openliberty.io/docs/ref/feature/#openidConnectServer-1.0.html). To enable this feature without modifying the default `server.xml`, move the `oidcProvider.xml` config snippet on the installed FHIR Server from `<WLP_HOME>/usr/servers/fhir-server/configDropins/disabled/` to `<WLP_HOME>/usr/servers/fhir-server/configDropins/defaults/` and modify as desired.\n\nA copy of this snippet is provided here for illustrative purposes:\n```xml\n<featureManager>\n    <feature>openidConnectServer-1.0</feature>\n</featureManager>\n\n<openidConnectProvider id=\"oidc-provider\"\n    oauthProviderRef=\"oauth2-provider\"\n    keyStoreRef=\"defaultKeyStore\"\n    signatureAlgorithm=\"RS256\" />\n\n<oauth-roles>\n    <authenticated>\n        <special-subject type=\"ALL_AUTHENTICATED_USERS\" />\n    </authenticated>\n    <clientManager>\n        <group name=\"clientAdministrator\" />\n    </clientManager>\n</oauth-roles>\n\n<oauthProvider id=\"oauth2-provider\" oauthOnly=\"false\" allowPublicClients=\"true\" jwtAccessToken=\"true\">\n    <grantType>authorization_code</grantType>\n    <databaseStore dataSourceRef=\"OAuthDataSource\" schema=\"FHIR_OAUTH\" />\n</oauthProvider>\n\n<dataSource id=\"OAuthDataSource\" jndiName=\"jdbc/OAuth2DB\">\n    <properties.derby.embedded createDatabase=\"create\" databaseName=\"derby/oauth2db\" />\n    <jdbcDriver libraryRef=\"sharedLibDerby\" />\n</dataSource>\n```\n\n### 5.3.1.1 oidcProvider.xml snippet details\nOpenID Connect is built on OAuth 2.0 and so the `oidcProvider.xml` snippet configures Liberty as an OAuth 2.0 provider as described at [Defining OAuth](https://www.ibm.com/support/knowledgecenter/SSEQTP_liberty/com.ibm.websphere.wlp.doc/ae/twlp_oauth_defining.html).\n\nLiberty supports the registration of clients through either a localStore in the server.xml or a databaseStore in a configured dataSource.\nTo support \"dynamic client registration\", the snippet configures an oauthProvider databaseStore and a clientManager oauth-role for managing the OAuth 2.0 clients.\n\nAdditionally, the `fhir-persistence-schema` project (which is also used to deploy the main IBM FHIR Server schema) creates the tables required by this Liberty feature by default (as described at [OAuth Databases](https://www.ibm.com/support/knowledgecenter/SSD28V_liberty/com.ibm.websphere.wlp.core.doc/ae/twlp_oauth_dbs.html)).\n\nFinally, the `openidConnectProvider` element is specified with a default signatureAlgorithm of RS256 and a reference to the defaultKeyStore which must contain a private key that can be used for signing.\n\n### 5.3.1.2 Register a client\nNow that the server is configured as an OAuth 2.0 provider, clients can self-register by invoking the https://[host]:9443/oauth2/endpoint/oauth2-provider/registration endpoint.\n\nFor example, for a server running on localhost:\n```sh\ncurl -u 'fhiruser:change-password' 'https://localhost:9443/oauth2/endpoint/oauth2-provider/registration' \\\n--header 'Content-Type: application/json' \\\n--data-raw '{\n   \"token_endpoint_auth_method\":\"client_secret_basic\",\n   \"scope\":\"launch launch/patient offline_access openid profile user/*.* patient/*.*\",\n   \"grant_types\":[\n      \"authorization_code\",\n      \"client_credentials\",\n      \"implicit\",\n      \"refresh_token\",\n      \"urn:ietf:params:oauth:grant-type:jwt-bearer\"\n   ],\n   \"response_types\":[\n      \"code\",\n      \"token\",\n      \"id_token token\"\n   ],\n   \"application_type\":\"web\",\n   \"subject_type\":\"public\",\n   \"post_logout_redirect_uris\":[\n      \"http://localhost:4567/inferno/oauth2/static/redirect\"\n   ],\n   \"preauthorized_scope\":\"launch launch/patient offline_access openid profile user/*.* patient/*.*\",\n   \"introspect_tokens\":true,\n   \"trusted_uri_prefixes\":[\n      \"https://server.example.com:9000/trusted/\"\n   ],\n   \"redirect_uris\":[\n      \"http://localhost:4567/inferno/oauth2/static/redirect\"\n   ]\n}'\n```\n\nFor more information on Liberty's support for client registration, see https://www.ibm.com/support/knowledgecenter/SSEQTP_liberty/com.ibm.websphere.wlp.doc/ae/twlp_client_registration.html.\n\n### 5.3.1.3 Request an access token\nAfter you've registered a client, invoke the authorization endpoint with the client_id assigned to your client in order to obtain an authorization code that can be exchanged for an access token.\nFor a server running on localhost, the auth URL is `https://localhost:9443/oidc/endpoint/oidc-provider/authorize`.\n\nThe provider endpoint will present an HTML login form and you must enter a valid username/password from Liberty's configured user registry (e.g. `fhiruser`/`change-password`).\nThis will redirect you to the configured redirect uri for your client, passing it a code that can be exchanged for an access token at the token endpoint.\nFor a server running on localhost, the token URL is `https://localhost:9443/oidc/endpoint/oidc-provider/token`.\n\n### 5.3.2 Configure Liberty to be an Oauth 2.0 Protected Resource Server\nLiberty can be configured to act as an OAuth 2.0 Protected Resource Server via the [openidConnectClient-1.0 feature](https://openliberty.io/docs/ref/feature/#openidConnectClient-1.0.html). To enable this feature without modifying the default `server.xml`, move the `oauthResourceServer.xml` config snippet on the installed FHIR Server from `<WLP_HOME>/usr/servers/fhir-server/configDropins/disabled/` to `<WLP_HOME>/usr/servers/fhir-server/configDropins/defaults/` and modify as desired.\n\nA copy of this snippet is provided here for illustrative purposes:\n```xml\n<featureManager>\n    <feature>openidConnectClient-1.0</feature>\n</featureManager>\n\n<!-- Liberty acts as an OAuth 2.0 protected resource server when inboundPropagation=”required” -->\n<openidConnectClient id=\"RS\" inboundPropagation=\"required\"\n    trustStoreRef=\"defaultTrustStore\"\n    trustAliasName=\"libertyop\"\n    issuerIdentifier=\"https://localhost:9443/oauth2/endpoint/oauth2-provider,https://host.docker.internal:9443/oauth2/endpoint/oauth2-provider\"\n    validationEndpointUrl=\"https://localhost:9443/oauth2/endpoint/oauth2-provider/introspect\"\n    signatureAlgorithm=\"RS256\"\n    authFilterRef=\"filter\"/>\n\n<authFilter id=\"filter\">\n    <requestUrl urlPattern=\"/fhir-server\"/>\n</authFilter>\n```\n\n### 5.3.2.1 oauthResourceServer.xml snippet details\nBy default, the server is configured with a defaultTrustStore that includes a copy of the server's signed certificate with alias `libertyop` (\"op\" for OpenID Connect Provider).\n\nThe server is configured to accept tokens with an issuerIdentifier that has a hostname of either localhost or host.docker.internal so that we can test it from the [Inferno test tool's](https://github.com/onc-healthit/inferno) docker-compose environment.\n\nThe signatureAlgorithm must match the signature used by the OAuth provider and the authFilter is required when the server is also acting as both an OAuth Resource Server *and* an OAuth/OpenId Connect provider so that the OAuth endpoints themselves can be accessed to grant the access tokens needed for accessing the rest of the server endpoints.\n\n### 5.3.2.2 Configuring the trustStore\nIf you are using Liberty as both the openIdConnect server and the openIdConnect client and you have modified the defaultKeyStore to use a different key, you can configure the corresponding trustStore based on the following keytool commands:\n\n1. Export the OAuth 2.0 provider's certificate from the configured keystore via one of the following commands:\n* `keytool -exportcert -keystore key.p12 -storepass Password -alias default -file libertyOP.cer`\n* `keytool -exportcert -keystore key.jks -storepass Password -alias default -file libertyOP.cer`\n\n2. Import the certificate into the server's trustStore. Assuming you use the same keystore for both, then use of these:\n* `keytool -importcert -keystore key.p12 -storepass Password -alias libertyop -file libertyOP.cer -noprompt`\n* `keytool -importcert -keystore key.jks -storepass Password -alias libertyop -file libertyOP.cer -noprompt`\n\n### 5.3.3 Advertise the OAuth endpoints via fhir-server-config\nTo configure the FHIR Server to advertise the OpenID Connect and OAuth 2.0 endpoints of the providers, provide values for at least the following properties in the default fhir-server-config.json file:\n* `fhirServer/security/oauth/authUrl`\n* `fhirServer/security/oauth/tokenUrl`\n\nWhen the Liberty server is the OpenID Connect / OAuth 2.0 provider, use a placeholder of `<host>` in the property values to have the server automatically replace this text with the hostname used by requestors (see `fhirServer/core/originalRequestUriHeaderName`).\n\nThese values will be used to populate the corresponding entries in both the server capability statement (`GET [base]/metadata`) and the smart-configuration (`GET [base]/.well-known/smart-configuration`).\n\nFor example, the following excerpt from a CapabilityStatement shows sample OAuth-related URLs (register, authorize, and token) values in the `valueUri` elements.\n```\n…\n\"rest\": [\n    {\n      \"mode\": \"server\",\n      \"security\": {\n        \"extension\": [\n          {\n            \"url\": \"http://fhir-registry.smarthealthit.org/StructureDefinition/oauth-uris\"\n            \"extension\": [\n              {\n                \"url\": \"register\",\n                \"valueUri\": \"https://localhost:9443/oauth2/endpoint/oauth2-provider/registration\"\n              },\n              {\n                \"url\": \"authorize\",\n                \"valueUri\": \"https://localhost:9443/oauth2/endpoint/oauth2-provider/authorize\"\n              },\n              {\n                \"url\": \"token\",\n                \"valueUri\": \"https://localhost:9443/oauth2/endpoint/oauth2-provider/token\"\n              }\n            ]\n          }\n        ],\n…\n```\n\nSMART on FHIR applications should use the `.well-known/smart-configuration` endpoint to determine the OAuth URLs to use for authorization,\nbut the entries in the Capability Statement are needed for backwards compatibility.\n\n## 5.4 Custom HTTP Headers\nIBM FHIR Server Supports the following custom HTTP Headers:\n\n| Header Name      | Description                |\n|------------------|----------------------------|\n|`X-FHIR-TENANT-ID`|Specifies which tenant config should be used for the request. Default is `default`. The header name can be overridden via config property `fhirServer/core/tenantIdHeaderName`.|\n|`X-FHIR-DSID`|Specifies which datastore config should be used for the request. Default is `default`. The header name can be overridden via config property `fhirServer/core/dataSourceIdHeaderName`.|\n|`X-FHIR-FORWARDED-URL`|The original (user-facing) request URL; used for constructing absolute URLs within the server response. Only enabled when explicitly configured in the default fhir-server-config.json. If either the config property or the header itself is missing, the server will use the actual request URL. The header name can be overridden via config property `fhirServer/core/originalRequestUriHeaderName`.|\n\n# 6 Related topics\nFor more information about topics related to configuring a FHIR server, see the following documentation:\n*   [IBM Java 8 Keytool documentation](https://www.ibm.com/support/knowledgecenter/SSYKE2_8.0.0/com.ibm.java.security.component.80.doc/security-component/keytoolDocs/keytool_overview.html)\n*   [WebSphere Liberty documentation: Configuring your web application and server for client certificate authentication](https://www.ibm.com/support/knowledgecenter/SSEQTP_liberty/com.ibm.websphere.wlp.doc/ae/twlp_sec_clientcert.html)\n*   [Java EE 7 Tutorial, Chapter 50](https://docs.oracle.com/javaee/7/tutorial/security-advanced002.htm#GLIEN)\n*   [WebSphere Liberty documentation: Defining an OAuth Service Provider](https://www.ibm.com/support/knowledgecenter/SSEQTP_liberty/com.ibm.websphere.wlp.doc/ae/twlp_oauth_defining.html)\n*   [WebSphere Liberty documentation: Configuring an Open ID Connect Client in liberty](https://www.ibm.com/support/knowledgecenter/SSEQTP_liberty/com.ibm.websphere.wlp.doc/ae/twlp_config_oidc_rp.html)\n\n<hr/>\n\n- <b name=\"f1\">1</b>\n\n    The fhir-server-config.json file contains configuration information associated with the FHIR server. The global configuration is located in `WLP_HOME/wlp/usr/servers/fhir-server/config/default/fhir-server-config.json`, with tenant-specific configuration contained in `config/TENANT_ID/fhir-server-config.json`. [↩](#a1)\n\n- <b name=\"f2\">2</b>\n\n    When running database-related commands (e.g. createDB.sh, liquibase, etc.) you'll need to make sure that the Db2-related executables are in your PATH, and also that you are logged in as a user that has the necessary authority to create the database and/or create the schema.  Normally, if you log in as the Db2 administrative user (typically \"db2inst1\") then you should be fine. [↩](#a2)\n\n- <b id=\"f3\">3</b>\n\n    The names of these request headers are configurable within the FHIR server's fhir-server-config.json file.  For more information, see [Section 5.1 Configuration properties reference](#51-configuration-properties-reference). [↩](#a3)\n\n- <b id=\"f4\">4</b>\n\n    For more information on multi-tenant support, including multi-tenant configuration properties, jump to [Section 4.9 Multi-Tenancy](#49-multi-tenancy). [↩](#a4)\n\n- <b id=\"f5\">5</b>\n\n    An external reference is a reference to a resource which is meaningful outside a particular request bundle.  The value typically includes the resource type and the resource identifier, and could  be an absolute or relative URL. Examples:  `https://fhirserver1:9443/fhir-server/api/v4/Patient/12345`, `Patient/12345`, etc. [↩](#a5)\n\n- <b id=\"f6\">6</b>\n\n    A local reference is a reference used within a request bundle that refers to another resource within the same request bundle and is meaningful only within that request bundle. A local reference starts with `urn:`. [↩](#a6)\n\n- <b id=\"f7\">7</b>\n\n    Keystore and truststore files have the same basic structure. They both provide a secure means for storing certificates. Typically, we think of a keystore as a file that contains certificates that consist of a private/public key pair, whereas a truststore contains certificates that consist of a public key or trusted certificates. [↩](#a7)\n\n- <b id=\"f8\">8</b>\n\n    While the instructions here show examples of creating self-signed certificates, in reality the FHIR Server deployer will likely need to use certificates that have been signed by a Certificate Authority (CA) such as Verisign, etc. [↩](#a8)\n\n- <b id=\"f9\">9</b>\n\n    The _keytool_ command is provided as part of the Java 8 JRE.  The command can be found in $JAVA_HOME/jre/bin. [↩](#a9)\n\n- <b id=\"f10\">10</b> These instructions assume the use of a basic user registry in the server.xml file.  If you are instead using an LDAP registry, then the entire DN associated with the client certificate must match the DN of a user in the LDAP registry. [↩](#a10)\n\n- <b id=\"f11\">11</b>\n\n    For the JAX-RS 2.0 Client API, you would call the ClientBuilder.truststore() method. [↩](#a11)\n\n- <b id=\"f12\">12</b>\n\n    For the JAX-RS 2.0 Client API, you would call the ClientBuilder.keystore() method. [↩](#a12)\n\n[a]:https://www.ibm.com/support/knowledgecenter/en/SSD28V_9.0.0/com.ibm.websphere.wlp.core.doc/ae/cwlp_pwd_encrypt.html\n\n<hr/>\n\nFHIR&reg; is the registered trademark of HL7 and is used with the permission of HL7.\n","type":"Mdx","contentDigest":"64aaf37f45e333260a74b490eb0b830f","counter":133,"owner":"gatsby-plugin-mdx","fieldOwners":{"slug":"gatsby-plugin-slug"}},"frontmatter":{"title":"IBM FHIR Server User's Guide","layout":"post","description":"IBM FHIR Server User's Guide","Copyright":"years 2017, 2021","lastupdated":"2021-03-10","permalink":"/FHIRServerUsersGuide/"},"exports":{},"rawBody":"---\nlayout: post\ntitle:  IBM FHIR Server User's Guide\ndescription: IBM FHIR Server User's Guide\nCopyright: years 2017, 2021\nlastupdated: \"2021-03-10\"\npermalink: /FHIRServerUsersGuide/\n---\n\n- [1 Overview](#1-overview)\n- [2 Installation](#2-installation)\n  * [2.1 Installing a new server](#21-installing-a-new-server)\n  * [2.2 Upgrading an existing server](#22-upgrading-an-existing-server)\n  * [2.3 Docker](#23-docker)\n- [3 Configuration](#3-configuration)\n  * [3.1 Liberty server configuration](#31-liberty-server-configuration)\n  * [3.2 FHIR server configuration](#32-fhir-server-configuration)\n  * [3.3 Persistence layer configuration](#33-persistence-layer-configuration)\n- [4 Customization](#4-customization)\n  * [4.1 Extended operations](#41-extended-operations)\n  * [4.2 Notification Service](#42-notification-service)\n  * [4.3 Persistence interceptors](#43-persistence-interceptors)\n  * [4.4 Resource validation](#44-resource-validation)\n  * [4.5 \"Update/Create\" feature](#45-updatecreate-feature)\n  * [4.6 FHIR client API](#46-fhir-client-api)\n  * [4.7 FHIR command-line interface (fhir-cli)](#47-fhir-command-line-interface-fhir-cli)\n  * [4.8 Using local references within request bundles](#48-using-local-references-within-request-bundles)\n  * [4.9 Multi-tenancy](#49-multi-tenancy)\n  * [4.10 Bulk data operations](#410-bulk-data-operations)\n  * [4.11 Audit logging service](#411-audit-logging-service)\n  * [4.12 FHIR REST API](#412-fhir-rest-api)\n- [5 Appendix](#5-appendix)\n  * [5.1 Configuration properties reference](#51-configuration-properties-reference)\n  * [5.2 Keystores, truststores, and the FHIR server](#52-keystores-truststores-and-the-fhir-server)\n  * [5.3 OpenID Connect and OAuth 2.0](#53-openid-connect-and-oauth-20)\n  * [5.4 Custom HTTP Headers](#54-custom-http-headers)\n- [6 Related topics](#6-related-topics)\n\n# 1 Overview\nThe IBM FHIR Server implements the HL7 FHIR HTTP API and supports the full set of FHIR-defined resource types.\nThis FHIR server is intended to be a common component for providing FHIR capabilities within health services and solutions.\n\n# 2 Installation\n\n## 2.1 Installing a new server\n0.  Prereqs: The IBM FHIR Server requires Java 8 or higher and has been tested with OpenJDK 8, OpenJDK 11, and the IBM SDK, Java Technology Edition, Version 8. To install Java on your system, we recommend downloading and installing OpenJDK 8 from https://adoptopenjdk.net/.\n\n1.  To install the IBM FHIR Server, build or download the `fhir-install` zip installer (e.g. `fhir-server-distribution.zip` or `fhir-install-4.0.0-rc1-20191014-1610`).\nThe Maven build creates the zip package under `fhir-install/target`. Alternatively, releases will be made available from the [Releases tab](https://github.com/ibm/fhir/releases).\n\n2.  Unzip the `.zip` package into a clean directory (referred to as `fhir-installer` here):\n    ```\n        mkdir fhir-installer\n        cd fhir-installer\n        unzip fhir-server-distribution.zip\n    ```\n\n3.  Determine an install location for the OpenLiberty server and the IBM FHIR Server webapp. Example:  `/opt/ibm/fhir-server`\n\n4.  Run the `install.sh/.bat` script to install the server:\n    ```\n        ./fhir-server-dist/install.sh /opt/ibm/fhir-server\n    ```\n    This step installs the OpenLiberty runtime and the IBM FHIR Server web application. The Liberty runtime is installed in a directory called `wlp` within the installation directory that you specify. For example, in the preceding command, the root directory of the Liberty server runtime would be `/opt/ibm/fhir-server/wlp`.\n\n5.  Configure the fhir-server's `server.xml` file as needed by completing the following steps:\n    * Configure the ports that the server listen on. The server is installed with only port 9443 (HTTPS) enabled by default. To change the port numbers, modify the values in the `httpEndpoint` element.\n    * Configure a server keystore and truststore. The IBM FHIR Server is installed with a default keystore file that contains a single self-signed certificate for localhost. For production use, you must create and configure your own keystore and truststore files for the FHIR server deployment (that is, generate your own server certificate or obtain a trusted certificate, and then share the public key certificate with API consumers so that they can insert it into their client-side truststore). The keystore and truststore files are used along with the server's HTTPS endpoint and the FHIR server's client-certificate-based authentication protocol to secure the FHIR server's endpoint. For more information, see [Section 5.2 Keystores, truststores, and the FHIR server](#52-keystores-truststores-and-the-fhir-server).\n    * Configure an appropriate user registry. The FHIR server is installed with a basic user registry that contains a single user named `fhiruser`. For production use, it's best to configure your own user registry. For more information about configuring user registries, see the [OpenLiberty documentation](https://openliberty.io/guides/security-intro.html#configuring-the-user-registry).\n\n    To override the default fhiruser's password, one may set an Environment variable `FHIR_USER_PASSWORD` and for the fhiradmin's password one may set an Environment variable `FHIR_ADMIN_PASSWORD`.\n\n6.  Make sure that your selected database product is running and ready to accept requests as needed:\n    * By default, the FHIR server is installed with the JDBC persistence layer configured to use an Embedded Derby database. When using the `ibmcom/ibm-fhir-server` docker image, set the `BOOTSTRAP_DB` environment variable to `true` in order to bootstrap this database. For any other configuration, note the database host and port and, if necessary, create a user with privileges for deploying the schema.\n\n7.  Create and deploy the IBM FHIR Server database schema as needed:\n    * By default, the FHIR server is installed with the JDBC persistence layer configured to use an Embedded Derby database. When using the `ibmcom/ibm-fhir-server` docker image, set the `BOOTSTRAP_DB` environment variable to `true` in order to bootstrap this database. For any other configuration, use the `fhir-persistence-schema` module to create and deploy the database schema.\n    * The Db2 persistence layer is always tenant-aware, so you must provision a tenant in addition to deploying the schema. Note the tenant name you provisioned and the tenantKey generated by `fhir-persistence-schema` for the next step.\n\n8.  Configure the `fhir-server-config.json`<sup id=\"a1\">[1](#f1)</sup> configuration file as needed:\n    * By default, the FHIR server is installed with the JDBC persistence layer configured to use a single-tenant Embedded Derby database. For more information, see [Section 3.3 Persistence layer configuration](#33-persistence-layer-configuration).\n\n9.  To start and stop the server, use the Liberty server command:\n```\n    <WLP_HOME>/bin/server start fhir-server\n    <WLP_HOME>/bin/server stop fhir-server\n```\n\n9.  After you start the server, you can verify that it's running properly by invoking the `$healthcheck` endpoint like this:\n```\n    curl -k -u '<username>:<password>' 'https://<host>:<port>/fhir-server/api/v4/$healthcheck'\n```\n    where `<username>` is one of the users configured in `server.xml` (default is `fhiruser`).  \n    Use single quotes around the URL to prevent $healthcheck from being evaluated as an environment variable on unix-based operating systems.  \n\n    One should see `All OK` in the response.  The preceding command should produce output similar to the following:\n```\n    {\n    \"resourceType\": \"OperationOutcome\",\n    \"issue\": [\n        {\n            \"severity\": \"information\",\n            \"code\": \"informational\",\n            \"details\": {\n                \"text\": \"All OK\"\n            }\n        }\n    ]\n    }\n```\n\nFor more information about the capabilities of the implementation, see [Conformance](https://ibm.github.io/FHIR/Conformance).\n\n## 2.2 Upgrading an existing server\nThe IBM FHIR Server does not include an upgrade installer. To upgrade a server to the next version, install the new version to a separate location and copy the configuration files from your existing installation (reconciling any configuration-related changes from the new release in the process).\n\nTo manage database updates over time, the IBM FHIR Server uses custom tools from the `fhir-database-utils` project. Through the use of a metadata table, the database utilities can detect the currently installed version of the database schema and apply any new changes that are needed to bring the database to the current level.\n\nComplete the following steps to upgrade the server:\n\n1. Run the fhir-installer on a separate server.\n2. Configure the new server as appropriate (`fhir-server/server.xml` and anything under the `fhir-server/configDropins`, `fhir-server/config`, and `fhir-server/userlib` directories).\n3. Back up your database.  \n4. Run the migration program (see [Section 3.3.1.1 Supported databases](#3311-supported-databases)).  \n5. Disable traffic to the old server and enable traffic to the new server.\n\n## 2.3 Docker\nThe IBM FHIR Server includes a Docker image [ibmcom/ibm-fhir-server](https://hub.docker.com/r/ibmcom/ibm-fhir-server).\n\nNote, logging for the IBM FHIR Server docker image is to stderr and stdout, and is picked up by Logging agents.\n\nThe IBM FHIR Server is configured using Environment variables using:\n\n| Environment Variable | Description |\n|----------------------|-------------|\n|`DISABLED_OPERATIONS`|A comma-separated list of operations which are disabled on the IBM FHIR Server, for example, `validate,import`. Note, do not include the dollar sign `$`|\n\n# 3 Configuration\nThis chapter contains information about the various ways in which the IBM FHIR Server can be configured by users.\n\n## 3.1 Liberty server configuration\nThe IBM FHIR Server is built on the open source [OpenLiberty project](https://openliberty.io/) but also works on the commercial [IBM WebSphere Liberty](https://www.ibm.com/cloud/websphere-liberty). In documentation and elsewhere, we use `Liberty` to refer to either/or.\n\nAs a Liberty application, the IBM FHIR Server is configurable like any other Liberty server. See https://openliberty.io/docs/latest/reference/config/server-configuration-overview.html for more information.\n\nBy default, we include:\n* `server.xml` with core server details like the Liberty features, HTTP properties, application info, and a default user registry\n* `jvm.options` with TLS and heap size settings\n* `server.env` with timezone set to UTC\n* `configDropins` with server.xml dropins sorted into `disabled`, `defaults`, and `overrides`\n\n## 3.1.1 Encoded passwords\nIn the examples within the following sections, you'll see the default password `change-password`. In order to secure your server, these values should be changed.\n\nOptionally, the values can be encoded via the Liberty `securityUtility` command. For example, to encode a string value with the default `{xor}` encoding, run the following command:\n```\n<WLP_HOME>/bin/securityUtility encode stringToEncode\n```\n\nThe output of this command can then be copied and pasted into your `server.xml` or `fhir-server-config.json` file as needed. The `fhir-server-config.json` does not support the securityUtility's `{aes}` encoding at this time, but per the limits to protection through password encryption<sup>[a]</sup>, this encoding does not provide significant additional security beyond `exclusive or` (XOR) encoding.\n\n## 3.2 FHIR server configuration\n\n### 3.2.1 Property names\nConfiguration properties stored within a `fhir-server-config.json` file are structured in a hierarchical manner. Here is an example:\n\n```\n    {\n        \"fhirServer\":{\n            \"core\":{\n                \"defaultPrettyPrint\":false\n            }\n        }\n    }\n```\n\nThroughout this document, we use a path notation to refer to property names. For example, the name of the `defaultPrettyPrint` property in the preceding example would be `fhirServer/core/defaultPrettyPrint`.\n\n### 3.2.2 Tenant-specific configuration properties\nThe IBM FHIR server supports certain multi-tenant features. One such feature is the ability to set certain configuration properties on a per-tenant basis.\n\nIn general, the configuration properties for a particular tenant are stored in the `<WLP_HOME>/usr/servers/fhir-server/config/<tenant-id>/fhir-server-config.json` file, where `<tenant-id>` refers to the tenant's “short name” or tenant id.\n\nThe global configuration is considered to be associated with a tenant named `default`, so those properties are stored in the `<WLP_HOME>/usr/servers/fhir-server/config/default/fhir-server-config.json` file.\n\nSimilarly, tenant-specific search parameters are found at `<WLP_HOME>/usr/servers/fhir-server/config/<tenant-id>/extension-search-parameters.json`, whereas the global/default extension search parameters are at `<WLP_HOME>/usr/servers/fhir-server/config/default/extension-search-parameters.json`.\n\nSearch parameters are handled like a single configuration properly; providing a tenant-specific file will override the global/default extension search parameters as defined at [FHIRSearchConfiguration](https://ibm.github.io/FHIR/guides/FHIRSearchConfiguration).\n\nMore information about multi-tenant support can be found in [Section 4.9 Multi-tenancy](#49-multi-tenancy).\n\n### 3.2.3 Compartment Search Performance\n\nThe IBM FHIR Server supports the ability to compute and store compartment membership values during ingestion. Once stored, these values can help accelerate compartment-related search queries. To use this feature, update the IBM FHIR Server to at least version 4.5.1 and run a reindex operation as described in the [fhir-bucket](https://github.com/IBM/FHIR/tree/main/fhir-bucket) project [README](https://github.com/IBM/FHIR/blob/main/fhir-bucket/README.md). The reindex operation reprocesses the resources stored in the database, computing and storing the new compartment reference values. After the reindex operation has completed, add the `useStoredCompartmentParam` configuration element to the relevant tenant fhir-server-config.json file to allow the search queries to use the pre-computed values:\n\n```\n    {\n        \"fhirServer\": {\n            \"search\": {\n                \"useStoredCompartmentParam\": true\n            }\n        }\n    }\n```\nNote that this parameter only enables or disables the compartment search query optimization feature. The compartment membership values are always computed and stored during ingestion or reindexing, regardless of the setting of this value. After the reindex operation is complete, it is recommended to set `useStoredCompartmentParam` to true. No reindex is required if this value is subsequently set to false.\n\n## 3.3 Persistence layer configuration\nThe IBM FHIR Server allows deployers to select a persistence layer implementation that fits their needs. Currently, the server includes a JDBC persistence layer which supports Apache Derby, IBM Db2, and PostgreSQL.  However, Apache Derby is not recommended for production usage.\n\nBefore you can configure the server to use the JDBC persistence layer implementation, you first need to prepare the database. This step depends on the database product in use and is covered in more detail in [Section 3.3.1.1 Supported databases](#3311-supported-databases).\n\nThe IBM FHIR Server is delivered with a default configuration that is already configured to use the JDBC persistence layer implementation with an Embedded Derby database. This provides the easiest out-of-the-box experience since it requires very little setup.\n\nThe IBM FHIR Server persistence configuration is split between `fhir-server-config.json` and the Liberty `server.xml + configDropins`.\n\nWithin `fhir-server-config.json`, the value of the `fhirServer/persistence/factoryClassname` is used to instantiate a FHIRPersistence object. By default, the server is configured to use the FHIRPersistenceJDBCFactory:\n```\n    {\n        \"fhirServer\": {\n            …\n            \"persistence\": {\n                \"factoryClassname\": \"com.ibm.fhir.persistence.jdbc.FHIRPersistenceJDBCFactory\",\n                …\n            }\n    }\n```\n\n### 3.3.1 The JDBC persistence layer\nWhen the FHIRPersistenceJDBCFactory is in use, the `fhirServer/persistence/datasources` property must specify a mapping from datastore-id values to Liberty datasource definitions. For example, here is the configuration for a datastore with id `default` that is configured for the `jdbc/fhir_default_default` datasource of type `postgresql`:\n```\n{\n    \"fhirServer\":{\n        \"persistence\":{\n            \"factoryClassname\":\"com.ibm.fhir.persistence.jdbc.FHIRPersistenceJDBCFactory\",\n            \"datasources\": {\n                \"default\": {\n                    \"type\": \"postgresql\",\n                    \"currentSchema\": \"fhirdata\",\n                    \"jndiName\": \"jdbc/fhir_default_default\"\n                }\n            }\n        }\n    }\n}\n```\n\nBoth the `type` and the `currentSchema` properties are required.\nThe `type` value must be set to one of the supported JDBC types (currently `db2`, `postgresql`, or `derby`) and it must match the actual database type referenced by the datasource definition. If the type does not match, the behavior is undefined.\nBecause the IBM FHIR Server does not quote the schema name in our generated queries, the `currentSchema` property is effectively case-insensitive.\n\nThe `jndiName` property is optional; it will default to `jdbc/fhir_<tenantId>_<dsId>` where `<tenantId>` and `<dsId>` represent the tenant and datastore ids respectively<sup id=\"a4\">[4](#f4)</sup>.\n\nThe datasource definitions themselves are configured in accordance with the [Liberty documentation on Relational database connections with JDBC](https://openliberty.io/docs/latest/relational-database-connections-JDBC.html). Previous versions of the IBM FHIR Server supported a proxy datasource that allowed for datasource definitions in the fhir-server-config.json, but Liberty JDBC datasource configuration is now the preferred approach due to benefits related to configuring pool sizes, transaction recovery, and monitoring.\n\nFor example, the fhir-server-config snippet from above would have a corresponding Liberty config like this:\n```xml\n<server>\n    <!-- ============================================================== -->\n    <!-- TENANT: default; DSID: default; TYPE: read-write               -->\n    <!-- ============================================================== -->\n    <dataSource id=\"fhirDefaultDefault\" jndiName=\"jdbc/fhir_default_default\" type=\"javax.sql.XADataSource\" statementCacheSize=\"200\" syncQueryTimeoutWithTransactionTimeout=\"true\" validationTimeout=\"30s\">\n        <jdbcDriver javax.sql.XADataSource=\"org.postgresql.xa.PGXADataSource\" libraryRef=\"sharedLibPostgres\"/>\n        <properties.postgresql\n             serverName=\"postgres_postgres_1\"\n             portNumber=\"5432\"\n             databaseName=\"fhirdb\"\n             user=\"fhirserver\"\n             password=\"change-password\"\n             currentSchema=\"fhirdata\"\n         />\n        <connectionManager maxPoolSize=\"200\" minPoolSize=\"40\"/>\n    </dataSource>\n</server>\n```\n\nDatasource elements should not be defined in the main `server.xml` file but instead should be defined in the `configDropins/overrides` directory. See the [Liberty Profile Server configuration guide](https://openliberty.io/docs/latest/reference/config/server-configuration-overview.html) for more details and general guidance on creating modular configurations.\n\nThe IBM FHIR Server is packaged with the following sample datasource definitions at `configDropins/disabled`:\n* datasource-postgresql.xml\n* datasource-db2.xml\n* datasource-derby.xml\n\nThere are 3 libraries defined in the main `server.xml` that reference the required client drivers for each database type:\n* sharedLibDerby\n* sharedLibDb2\n* sharedLibPostgres\n\nWhen a datasource definition is included in a configDropin under `configDropins/overrides`, this file is picked up when the server starts as indicated by the following AUDIT message:\n\n```\n[AUDIT   ] CWWKG0093A: Processing configuration drop-ins resource: <WLP_HOME>/usr/servers/fhir-server/configDropins/overrides/datasource.xml\n```\n\nThe IBM FHIR Server will look up the tenant and datastore id for each request and use the corresponding JNDI name to obtain a connection for the corresponding datasource.\n\n#### 3.3.1.1 Supported databases\n##### Embedded Derby (default)\nIf you are using the `ibmcom/ibm-fhir-server` docker image, you can ask the entrypoint script to create (bootstrap) the database and the schema during startup by setting the `BOOTSTRAP_DB` environment variable to `true`.\n\nThis database bootstrap step is only supported for Embedded Derby and will only bootstrap the default datastore of the default tenant (the default for requests with no tenant or datastore headers).\nReminder:  the Embedded Derby support is designed to support simple getting started scenarios and is not recommended for production use.\n\n```\n<server>\n    <!-- ============================================================== -->\n    <!-- This datasource aligns with the Apache Derby database that is  -->\n    <!-- created by the IBM FHIR Server's DB_BOOTSTRAP process.         -->\n    <!-- ============================================================== -->\n    <dataSource id=\"fhirDefaultDefault\" jndiName=\"jdbc/fhir_default_default\" type=\"javax.sql.XADataSource\" statementCacheSize=\"200\" syncQueryTimeoutWithTransactionTimeout=\"true\" validationTimeout=\"30s\">\n        <jdbcDriver javax.sql.XADataSource=\"org.apache.derby.jdbc.EmbeddedXADataSource\" libraryRef=\"sharedLibDerby\"/>\n        <properties.derby.embedded createDatabase=\"create\" databaseName=\"derby/fhirDB\"/>\n        <connectionManager maxPoolSize=\"50\" minPoolSize=\"10\"/>\n    </dataSource>\n</server>\n```\n\n##### Db2\nIf you configure the FHIR server to use an IBM Db2 database, you must:\n\n1. Create the database if it doesn't already exist.\n\n2. Execute the `fhir-persistence-schema` utility to create the necessary schemas (tables, indices, stored procedures, etc) and tenants.\n\n3. Configure the IBM FHIR Server with the tenantKey generated in step number 2.\n\nAn executable `fhir-persistence-schema` jar can be downloaded from the project's [Releases tab](https://github.com/IBM/FHIR/releases) and documentation can be found at https://github.com/IBM/FHIR/tree/main/fhir-persistence-schema.\n\nFor a detailed guide on configuring IBM Db2 on Cloud for the IBM FHIR Server, see [DB2OnCloudSetup](https://ibm.github.io/FHIR/guides/DB2OnCloudSetup).\n\nSince release 4.3.2 you can use the `search.reopt` query optimizer hint to improve the performance of certain search queries involving multiple search parameters. This optimization is currently only available for Db2. Valid values are \"ALWAYS\" and \"ONCE\". See Db2 documentation for `REOPT` for more details.\n\n##### PostgreSQL\nIf you configure the FHIR server to use a PostgreSQL database, you must:\n\n1. create the database if it doesn't already exist\n\n2. execute the `fhir-persistence-schema` utility with a db-type of `postgresql` to create the necessary schemas (tables, indices, functions, etc)\n\nAn executable `fhir-persistence-schema` jar can be downloaded from the project's [Releases tab](https://github.com/IBM/FHIR/releases) and documentation can be found at https://github.com/IBM/FHIR/tree/main/fhir-persistence-schema.\n\nSince release 4.5.5 you can set the `searchOptimizerOptions/from_collapse_limit` and `searchOptimizerOptions/join_collapse_limit` properties to improve the performance of certain search queries involving multiple search parameters. This optimization is currently only available for PostgreSQL.\n\n##### Other\n\nTo enable the IBM FHIR Server to work with other relational database systems, see\nhttps://ibm.github.io/FHIR/guides/BringYourOwnPersistence#adding-support-for-another-relational-database\n\n\n#### 3.3.1.2 Datastore configuration examples\nTo understand how the configuration properties are defined for one or more datastores, let's start off with a couple of examples.\n\n##### Example 1\nHere is a simple example of a single (default) Derby datastore.\n\n**config/default/fhir-server-config.json**\n```json\n{\n    \"fhirServer\":{\n        …\n        \"persistence\":{\n            \"factoryClassname\":\"com.ibm.fhir.persistence.jdbc.FHIRPersistenceJDBCFactory\",\n            \"datasources\": {\n                \"default\": {\n                    \"type\": \"derby\",\n                    \"currentSchema\": \"APP\"\n                }\n            }\n        }\n    }\n}\n```\n\n**configDropins/overrides/datasource-derby.xml**\n```xml\n<server>\n    <library id=\"fhirSharedLib\">\n        <fileset dir=\"${shared.resource.dir}/lib/derby\" includes=\"*.jar\"/>\n    </library>\n\n    <!-- ============================================================== -->\n    <!-- TENANT: default; DSID: default; TYPE: read-write               -->\n    <!-- ============================================================== -->\n    <dataSource id=\"fhirDefaultDefault\" jndiName=\"jdbc/fhir_default_default\" type=\"javax.sql.XADataSource\" statementCacheSize=\"200\" syncQueryTimeoutWithTransactionTimeout=\"true\" validationTimeout=\"30s\">\n        <jdbcDriver javax.sql.XADataSource=\"org.apache.derby.jdbc.EmbeddedXADataSource\" libraryRef=\"sharedLibDerby\"/>\n        <properties.derby.embedded createDatabase=\"create\" databaseName=\"derby/fhirDB\"/>\n        <connectionManager maxPoolSize=\"50\" minPoolSize=\"10\"/>\n    </dataSource>\n</server>\n```\n\nIn this example, we define an embedded Derby database named `derby/fhirDB` (a location relative to the `<WLP_HOME>/usr/servers/fhir-server` directory). The datastore-id associated with this datastore is `default`, which is the value that is used if no `X-FHIR-DSID` request header is found in the incoming request. So, when only a single database is being used, it's wise to leverage the `default` datastore-id value to allow REST API consumers to avoid having to set the `X-FHIR-DSID` request header on each request.\n\n##### Example 2\nThis example shows a slightly more complex scenario. In this scenario, the `acme` tenant would like to store data in one of two study-specific Db2 databases with datastore-id values `study1` and `study2`.\n\nFurthermore, the REST API consumers associated with Acme applications will be coded to always set the `X-FHIR-TENANT-ID` request header to be `acme` and the `X-FHIR-DSID` request header to the specific datastore-id associated with each request (either `study1` or `study2`). In this case, the following properties would be configured:\n\n**config/acme/fhir-server-config.json**\n```json\n{\n    \"__comment\":\"Acme's FHIR server configuration\",\n    \"fhirServer\":{\n        …\n        \"persistence\":{\n            \"factoryClassname\":\"com.ibm.fhir.persistence.jdbc.FHIRPersistenceJDBCFactory\",\n            \"datasources\": {\n                \"study1\": {\n                    \"tenantKey\": \"<the-tenant-key>\",\n                    \"type\": \"db2\",\n                    \"currentSchema\": \"DB2INST1\"\n                },\n                \"study2\": {\n                    \"tenantKey\": \"<the-tenant-key>\",\n                    \"type\": \"db2\",\n                    \"currentSchema\": \"DB2INST1\"\n                }\n            }\n        }\n    }\n}\n```\n\n**configDropins/overrides/datasources-acme.xml**\n```xml\n<server>\n    <library id=\"fhirSharedLib\">\n        <fileset dir=\"${shared.resource.dir}/lib/db2\" includes=\"*.jar\"/>\n    </library>\n\n    <!-- ============================================================== -->\n    <!-- TENANT: acme; DSID: study1; TYPE: read-write                   -->\n    <!-- ============================================================== -->\n    <dataSource id=\"fhirDefaultDefault\" jndiName=\"jdbc/fhir_acme_study1\" type=\"javax.sql.XADataSource\" statementCacheSize=\"200\" syncQueryTimeoutWithTransactionTimeout=\"true\" validationTimeout=\"30s\">\n        <jdbcDriver javax.sql.XADataSource=\"com.ibm.db2.jcc.DB2XADataSource\" libraryRef=\"sharedLibDb2\"/>\n        <properties.db2.jcc\n            serverName=\"dbserver1\"\n            portNumber=\"50000\"\n            user=\"db2inst1\"\n            password=\"change-password\"\n            databaseName=\"ACMESTUDY1\"\n            currentSchema=\"DB2INST1\"\n            driverType=\"4\"\n         />\n        <connectionManager maxPoolSize=\"200\" minPoolSize=\"40\"/>\n    </dataSource>\n\n    <!-- ============================================================== -->\n    <!-- TENANT: acme; DSID: study2; TYPE: read-write                   -->\n    <!-- ============================================================== -->\n    <dataSource id=\"fhirDefaultDefault\" jndiName=\"jdbc/fhir_acme_study2\" type=\"javax.sql.XADataSource\" statementCacheSize=\"200\" syncQueryTimeoutWithTransactionTimeout=\"true\" validationTimeout=\"30s\">\n        <jdbcDriver javax.sql.XADataSource=\"com.ibm.db2.jcc.DB2XADataSource\" libraryRef=\"sharedLibDb2\"/>\n        <properties.db2.jcc\n            serverName=\"dbserver1\"\n            portNumber=\"50000\"\n            user=\"db2inst1\"\n            password=\"change-password\"\n            databaseName=\"ACMESTUDY2\"\n            currentSchema=\"DB2INST1\"\n            driverType=\"4\"\n         />\n        <connectionManager maxPoolSize=\"200\" minPoolSize=\"40\"/>\n    </dataSource>\n</server>\n```\n\nNote that because this example is using the default FHIR server naming scheme for datasource JNDI names, there is no need to include the 'jndiName' property in the fhir-server-config.json, although you can specify it should you wish to make the mapping clear.\n\nAdditionally, note that each datasource definition in the configDropin gets its own connection pool with properties defined by the 'connectionManager' element.\n\n#### 3.3.1.3 Database Access TransactionManager Timeout\nThe TransactionManager controls the timeout of database queries.  \n\nTo modify the default transaction timeout value, set the environment variable `FHIR_TRANSACTION_MANAGER_TIMEOUT` or enter the value in the server.env file at the root of the WLP fhir-server instance. Example values are `120s` (seconds) or `2m` (minutes).\n\n# 4 Customization\nYou can modify the default server implementation by taking advantage of the IBM FHIR server's extensibility. The following extension points are available:\n * Custom operations framework:  The IBM FHIR Server defines an operations framework that builds on the FHIR OperationDefinition resource in order to extend the FHIR REST API with custom endpoints.\n * Pluggable audit service:  Logging and auditing options including Cloud Auditing Data Federation (CADF) over Apache Kafka.\n * Persistence interceptors:  Intercept requests before and/or after each persistence action.\n * Resource validation:  FHIRPath-based validation of FHIR resources on create or update with the ability to extend the system with custom constraints.\n\n## 4.1 Extended operations\nIn addition to the standard REST API (create, update, search, and so forth), the IBM FHIR Server supports the FHIR operations framework as described in the [FHIR specification]( https://www.hl7.org/fhir/r4/operations.html).\n\n### 4.1.1 Packaged operations\nThe FHIR team provides implementations for the standard `$validate` and `$document` operations, as well as a custom operation named `$healthcheck`, which queries the configured persistence layer to report its health.\n\nNo other extended operations are packaged with the server at this time, but you can extend the server with your own operations.\n\n#### 4.1.1.1 $validate\nThe `$validate` operation checks whether the attached content would be acceptable either generally, or as a create, update, or delete against an existing resource instance or type.\n\nhttps://www.hl7.org/fhir/r4/resource-operations.html#validate\n\n#### 4.1.1.2 $document\nThe `$document` operation generates a fully bundled document from a composition resource.\n\nhttps://www.hl7.org/fhir/r4/composition-operations.html#document\n\n#### 4.1.1.3 $healthcheck\nThe `$healthcheck` operation returns the health of the FHIR server and its datastore. In the default JDBC persistence layer, this operation creates a connection to the configured database and return its status. The operations returns `200 OK` when healthy. Otherwise, it returns an HTTP error code and an `OperationOutcome` with one or more issues.\n\n### 4.1.2 Custom operations\nIn addition to the provided operations, the FHIR server supports user-provided custom operations through a Java Service Provider Interface (SPI).\n\nTo contribute an operation:\n1. Implement each operation as a Java class that extends `com.ibm.fhir.operation.AbstractOperation` from `fhir-operation.jar`. Ensure that your implementation returns an appropriate `OperationDefinition` in its `getDefinition()` method, because the framework validates both the request and response payloads to ensure that they conform to the definition.\n\n2. Create a file named `com.ibm.fhir.operation.FHIROperation` with one or more fully qualified `FHIROperation` classnames and package it in your jar under `META-INF/services/`.\n\n3. Include your jar file under the `<WLP_HOME>/usr/servers/fhir-server/userlib/` directory of your installation.\n\n4. Restart the FHIR server. Changes to custom operations require a server restart, because the server discovers and instantiates operations during server startup only.\n\nAfter you register your operation with the server, it is available via HTTP POST at `[base]/api/1/$<yourCode>`, where `<yourCode>` is the value of your OperationDefinition's [code](https://www.hl7.org/fhir/r4/operationdefinition-definitions.html#OperationDefinition.code).\n\n## 4.2 Notification Service\nThe FHIR server provides a notification service that publishes notifications about persistence events, specifically _create_, _update_, and _delete_ operations. The notification service can be used by other Healthcare components to trigger specific actions that need to occur as resources are being updated in the FHIR server datastore.\n\nThe notification service supports two implementations: WebSocket and Kafka.\n\n### 4.2.1 FHIRNotificationEvent\nThe `FHIRNotificationEvent` class defines the information that is published by the notification service. Each notification event published to the WebSocket or Kafka topic is an instance of `FHIRNotificationEvent`, serialized as a JSON object. This JSON object will have the following fields:\n\nField name     | Type   | Description\n|--------------| -----  | ------------|\n`operationType`| String | The operation associated with the notification event. Valid values are _create_ and _update_.\n`location`     | String | The location URI of the resource associated with the notification event. To retrieve this resource, invoke a GET request using the location URI value as the URL string.\n`lastUpdated`  | String | The date and time of the last update made to the resource associated with the notification event.\n`resourceId`   | String | The logical id of the resource associated with the notification event.\n`resource`     | String | A stringified JSON object which is the resource associated with the notification event.\n\nThe following JSON is an example of a serialized notification event:\n```\n{\n  \"lastUpdated\":\"2016-06-01T10:36:23.232-05:00\",\n  \"location\":\"Observation/3859/_history/1\",\n  \"operationType\":\"create\",\n  \"resourceId\":\"3859\",\n  \"resource\":{ …<contents of resource>… }\n}\n```\n\n### 4.2.2 WebSocket\nThe WebSocket implementation of the notification service will publish notification event messages to a WebSocket. To enable WebSocket notifications, set the `fhirServer/notifications/websocket/enabled` property to `true`, as in the following example:\n\n```\n{\n    \"fhirServer\":{\n        …\n        \"notifications\":{\n            …\n            \"websocket\":{\n                \"enabled\":true\n            }\n        …\n    }\n}\n```\n\nThe WebSocket location URI is `ws://<host>:<port>/fhir-server/api/v4/notification`, where `<host>` and `<port>` represent the host and port of the FHIR server's REST API endpoint. So for example, if the FHIR server endpoint's base URL is `https://localhost:9443/fhir-server/api/v4` then the corresponding location of the WebSocket would be `ws://localhost:9443/fhir-server/api/v4/notification`.\n\n### 4.2.3 Kafka\nThe Kafka implementation of the notification service will publish notification event messages to a Kafka topic. To configure the Kafka notification publisher, configure properties in the `fhir-server-config.json` file as indicatesd in the following example:\n\n```\n{\n    \"fhirServer\":{\n        …\n        \"notifications\":{\n            …\n            \"kafka\":{\n                \"enabled\":true,\n                \"topicName\":\"fhirNotifications\",\n                \"connectionProperties\":{\n                    \"group.id\":\"securing-kafka-group\",\n                    \"bootstrap.servers\":\"localhost:9093\",\n                    \"security.protocol\":\"SSL\",\n                    \"ssl.truststore.location\":\"resources/security/kafka.client.truststore.jks\",\n                    \"ssl.truststore.password\":\"change-password\",\n                    \"ssl.keystore.location\":\"resources/security/kafka.client.keystore.jks\",\n                    \"ssl.keystore.password\":\"change-password\",\n                    \"ssl.key.password\":\"change-password\",\n                    \"ssl.truststore.type\":\"JKS\",\n                    \"ssl.keystore.type\":\"JKS\"\n                }\n            }\n        …\n    }\n}\n```\n\nThe `fhirServer/notifications/kafka/enabled` property is used to enable or disable the Kafka publisher component.\n\nThe `fhirServer/notifications/kafka/topicName` property is used to configure the appropriate topic name to which the notification events should be published.\n\nThe `fhirServer/notifications/kafka/connectionProperties` property group is used to configure the properties necessary to successfully connect to the Kafka server. You can specify an arbitrary `group.id`. The `bootstrap.servers` property is required, but the rest are optional, although if your Kafka server is configured to require an SSL connection and client authentication, then the remaining properties must also be set. For more details about Kafka-related properties, see the Kafka documentation.\n\nIn the `connectionProperties` property group in preceding example, you'll notice that the password-related properties have encoded values. To store a value requiring security (such as a password), you can use Liberty's `securityUtility` command to encode the value. See [Section 3.1 Encoded passwords](#31-encoded-passwords) for details.\n\nBefore you enable Kafka notifications, it's important to understand the topology of the environment in which the FHIR server instance will be running. Your topic name selection should be done in consideration of the topology. If you have multiple instances of the FHIR server clustered together to form a single logical endpoint, then each of those instances should be configured to use the same Kafka topic for notifications. This is so that notification consumers (subscribers) can subscribe to a single topic and receive all the notifications published by each of the FHIR server instances within the cluster.\n\nOn the other hand, if you have two completely independent FHIR server instances, then you should configure each one with its own topic name.\n\n### 4.2.3 NATS\nThe [NATS](http://nats.io) implementation of the notification service publishes notification event messages to a NATS streaming cluster. To configure the NATS notification publisher, configure properties in the `fhir-server-config.json` file as shown in the following example:\n\n```\n{\n    \"fhirServer\":{\n        ...\n        \"notifications\":{\n            ...\n            \"nats\": {\n\t\t        \"enabled\": true,\n\t\t        \"cluster\": \"nats-streaming\",\n\t\t        \"channel\": \"fhirNotifications\",\n\t\t        \"clientId\": \"fhir-server\",\n\t\t        \"servers\": \"nats://nats-node1:4222,nats://nats-node2:4222,nats://nats-node3:4222\",\n\t\t        \"useTLS\": true,\n\t\t        \"truststoreLocation\": \"resources/security/nats.client.truststore.p12\",\n\t\t        \"truststorePassword\": \"change-password\",\n\t\t        \"keystoreLocation\": \"resources/security/nats.client.keystore.p12\",\n\t\t        \"keystorePassword\": \"change-password\"\n    }\n        ...\n    }\n}\n```\n\nSet the `fhirServer/notifications/nats/enabled` property to true and provide the name of your NATS cluster for the value of `fhirServer/notifications/nats/cluster`.  You may leave `fhirServer/notifications/nats/channel` and `fhirServer/notifications/nats/clientId` as defined.  Provide the URL for one or more NATS servers as the value for `fhirServer/notifications/nats/servers`.\n\nTo use TLS to connect to your NATS cluster, set `fhirServer/notifications/nats/useTLS` to true and provide client truststore and keystore locations and passwords as the remaining config values. Ensure that your NATS cluster is configured for TLS client connections.\n\nTo store a value requiring security, such as a password, use Liberty's `securityUtility` command to encode the value. See Section 3.1 Encoded passwords for details.\n\n### 4.2.4 Resource type filtering\nBy default, notification messages are published for all _create_ and _update_ persistence operations. However, the FHIR server allows you to configure a list of resource types for which notification events will be published. To do this, list the resource types for which you want to generate notifications in an array of strings within the  `fhirServer/notifications/common/includeResourceTypes` property in the `fhir-server-config.json` file, as in the following example:\n\n```\n{\n    \"fhirServer\":{\n        …\n        \"notifications\":{\n            …\n            \"common\":{\n                \"includeResourceTypes\":[\n                     \"Observation\",\n                     \"Patient\"\n                ]\n            },\n        …\n    }\n}\n```\n\nWith the `includeResourceTypes`property set as in the preceding example, the FHIR server publishes notification events only for `Patient` and `Observation` resources. If you omit this property or set its value to `[]` (an empty array), then the FHIR server publishes notifications for all resource types.\n\n## 4.3 Persistence interceptors\nThe FHIR server supports a persistence interceptor feature that enables users to add their own logic to the REST API processing flow around persistence events. This could be used to enforce application-specific business rules associated with resources. Interceptor methods can be called immediately before or after _create_ and _update_ persistence operations.\n\n### 4.3.1 FHIRPersistenceInterceptor interface\nA persistence interceptor implementation must implement the `com.ibm.fhir.persistence.interceptor.FHIRPersistenceInterceptor`\ninterface.\n\nEach interceptor method receives a parameter of type `FHIRPersistenceEvent`, which contains context information related to the request being processed at the time that the interceptor method is invoked. It includes the FHIR resource, security information, request URI information, and the collection of HTTP headers associated with the request.\n\nThere are two primary use cases for persistence interceptors:\n\n1.  Enforce certain application-specific governance rules, such as making sure that a patient has signed a consent form prior to allowing his/her data to be stored in the FHIR server's datastore. In this case, the `beforeCreate` or `beforeUpdate` interceptor methods could verify that the patient has a consent agreement on file, and if not then throw a `FHIRPersistenceInterceptorException` to prevent the _create_ or _update_ persistence events from completing normally. The exception thrown by the interceptor method will be propagated back to the FHIR server request processing flow and would result in an `OperationOutcome` being returned in the REST API response, along with a `Bad Request` HTTP status code.\n\n2.  Perform some additional processing steps associated with a _create_ or _update_ persistence event, such as additional audit logging. In this case, the `afterCreate` and `afterUpdate` interceptor methods could add records to an audit log to indicate the request URI that was invoked, the user associated with the invocation request, and so forth.\n\nIn general, the `beforeCreate` and `beforeUpdate` interceptor methods would be useful to perform an enforcement-type action where you would potentially want to prevent the request processing flow from finishing. Conversely, the `afterCreate` and `afterUpdate` interceptor methods would be useful in situations where you need to perform additional steps after the _create_ or _update_ persistence events have been performed.\n\n### 4.3.2 Implementing a persistence interceptor\nTo implement a persistence interceptor, complete the following steps:\n\n1.  Develop a Java class which implements the `FHIRPersistenceInterceptor` interface.\n2.  Store the fully-qualified classname of your interceptor implementation class in a file called :\n\n      `META-INF/services/com.ibm.fhir.persistence.interceptor.FHIRPersistenceInterceptor`\n\n    Here's an example of the file contents:\n\n    `com.ibm.mysolution.MyInterceptor`\n\n3.  Copy your jar to the `<WLP_HOME>/usr/servers/fhir-server/userlib` directory so that it is accessible to the FHIR server via the classpath (the `server.xml` file contains a library element that defines this directory as a shared library).\n\n4.  Re-start the FHIR server.\n\n## 4.4 Resource validation\n\n### 4.4.1 HL7 spec-defined validation support\nThe FHIR specification provides a number of different validation resources including:\n\n1.  XML Schemas\n2.  ISO XML Schematron rules\n3.  Structure Definitions / Profiles for standard resource types, data types and built-in value sets\n\nThe FHIR server validates incoming resources for create and update interactions using the resource definitions and their corresponding FHIRPath constraints. Additionally, the FHIR server provides the following `$validate` operation that API consumers can use to POST resources and get validation feedback:\n `POST <base>/Resource/$validate`\n\n### 4.4.2 User-provided validation\nThe IBM FHIR Server can be extended with custom profile validation. This allows one to apply validation rules on the basis of the `Resource.meta.profile` codes included on the resource instance.\n\nFor example, you can configure a set of FHIRPath Constraints to run for resources that claim conformance to the `http://ibm.com/fhir/profile/partner` profile when you see an input resource like the following:\n```\n{\n    \"resourceType\" : \"Patient\",\n    \"meta\": {\n        \"profile\": [ \"http://ibm.com/fhir/profile/partner\" ]\n    },\n    \"name\" : [ {\n        \"family\" : [ \"Doe\" ],\n        \"given\" : [ \"John\" ]\n    } ],\n    \"telecom\" : [ {\n        \"value\" : \"555-1234\",\n        \"system\": \"phone\",\n        \"use\" : \"home\"\n    } ],\n    \"birthDate\" : \"1950-08-15\"\n}\n```\n\nIt is also possible to configure a set of profiles, one or more of which a resource must claim conformance to and be successfully validated against in order to be persisted to the FHIR server. The FHIR server supports this optional behavior via the `fhirServer/resources/<resourceType>/profiles/atLeastOne` configuration parameter. If this configuration parameter is set to a non-empty list of profiles, then the FHIR server will perform the following validation, returning FAILURE if not successful:\n * Validate that at least one profile in the list is specified in the resource's `meta.profile` element\n * Validate that all profiles specified in the resource's `meta.profile` element are supported by the FHIR server\n * Validate that the resource's data conforms to all profiles specified in the resource's `meta.profile` element\n\nIf a profile in the list specified by the configuration parameter contains a version, for example `http://ibm.com/fhir/profile/partner|1.0`, then a profile of the same name specified in the resource's `meta.profile` element will only be considered a match if it contains exactly the same version. However, if a profile in the list specified by the configuration parameter does not contain a version, for example `http://ibm.com/fhir/profile/partner`, then a profile of the same name specified in the resource's `meta.profile` element will be considered a match whether it contains a version or not.\n\nIf this configuration parameter is not set or is set to an empty list, then the FHIR server will perform its standard validation.\n\nThe IBM FHIR Server pre-packages all conformance resources from the core specification.\n\nSee [Validation Guide - Optional profile support](https://ibm.github.io/FHIR/guides/FHIRValidationGuide#optional-profile-support) for a list of pre-built Implementation Guide resources and how to load them into the IBM FHIR server.\n\nSee [Validation Guide - Making profiles available to the fhir registry](https://ibm.github.io/FHIR/guides/FHIRValidationGuide#making-profiles-available-to-the-fhir-registry-component-fhirregistry) for information about how to extend the server with additional Implementation Guide artifacts.\n\n## 4.5 “Update/Create” feature\nNormally, the _update_ operation is invoked with a FHIR resource which represents a new version of an existing resource. The resource specified in the _update_ operation would contain the same id of that existing resource. If a resource containing a non-existent id were specified in the _update_ invocation, an error would result.\n\nThe FHIR specification defines optional behavior for the _update_ operation where it can create a new resource if a non-existent resource is specified in the invocation. The FHIR server supports this optional behavior via the `fhirServer/persistence/common/updateCreateEnabled` configuration parameter. If this configuration parameter is set to `true` (the default), then the _update_ operation will create a new resource if it is invoked with a resource containing a non-existent id. If the option is set to false, then the optional behavior is disabled and an error would be returned.\n\nThe following example shows the JSON for enabling _update_ operations to create resources:\n```\n{\n    \"fhirServer\":{\n        …\n        \"persistence\":{\n            \"common\":{\n                \"updateCreateEnabled\":true\n            }\n        }\n        …\n    }\n}\n```\n\n## 4.6 FHIR client API\n\n### 4.6.1 Overview\nIn addition to the server, we also offer a Java API for invoking the FHIR REST APIs. The IBM FHIR Client API is based on the JAX-RS 2.0 standard and provides a simple properties-driven client that can be easily configured for a given endpoint, mutual authentication, request/response logging, and more.\n\n### 4.6.2 Maven coordinates\nTo use the FHIR Client from your application, specify the `fhir-client` artifact as a dependency within your `pom.xml` file, as in the following example:\n\n```\n        <dependency>\n            <groupId>com.ibm.fhir</groupId>\n            <artifactId>fhir-client</artifactId>\n            <version>${fhir.client.version}</version>\n        </dependency>\n```\n\n### 4.6.3 Sample usage\nFor examples on how to use the IBM FHIR Client, look for tests like `com.ibm.fhir.client.test.mains.FHIRClientSample` from the `fhir-client` project in git. Additionally, the FHIR Client is heavilly used from our integration tests in `fhir-server-test`.\n\n## 4.7 FHIR command-line interface (fhir-cli)\nThe FHIR command-line interface (fhir-cli for short) is a command that can be used to invoke FHIR REST API operations from the command line. The compressed file for installing the fhir-cli tool is available from [Maven Central](https://repo1.maven.org/maven2/com/ibm/fhir/fhir-cli/).\n\n### 4.7.1 Installing fhir-cli\nBecause the fhir-cli tool is intended to be used by clients that need to access the FHIR server, it has its own installation process separate from the server. To install the fhir-cli tool, complete the following steps:\n\n1.  Obtain the `fhir-cli.zip` file from the FHIR server installation zip or Maven.\n2.  Decompress the `fhir-cli.zip` file into a directory of your choosing, for example:\n\n    ```\n    cd /mydir\n    unzip fhir-cli.zip\n    ```\n\n3.  [Optional] To enable you to run fhir-cli from multiple directories, run the following command to add `fhir-cli` to your `PATH` environment variable.\n    ```\n    export PATH=$PATH:/mydir/fhir-cli\n    ```\n\n### 4.7.2 Configuring fhir-cli\nThe fhir-cli tool requires a properties file containing various configuration properties, such as the base endpoint URL, the username and password for basic authentication, amd so forth. The properties contained in this file are the same properties supported by the FHIR client API. The fhir-cli tool comes with a sample properties file named `fhir-cli.properties` which contains a collection of default property settings.\n\nUsing the sample properties file as a guide, you can create your own properties file to reflect the required endpoint configuration associated with the FHIR server endpoint that you would like to access. In the examples that follow, we'll refer to this file as `my-fhir-cli.properties`, although you can name the file anything you'd like.\n\n### 4.7.3 Running fhir-cli\nThe fhir-cli tool comes with two shell scripts: `fhir-cli` (Linux&reg;) and `fhir-cli.bat` (Windows&trade;). In the examples that follow, we'll use `<fhir-cli-home>` as the location of the fhir-cli tool (that is, the `/mydir/fhir-cli` directory mentioned in preceding section).\n\nThe following examples illustrate how to invoke the fhir-cli tool:\n\n*   Display help text\n```\n$ <fhir-cli-home>/fhir-cli –help\n\nFHIR Client Command Line Interface (fhir-cli)    (c) Copyright IBM Corporation, 2016.\n\nusage: fhir-cli [options]\n\nProvides access to the FHIR Client API via the command line.\n\nOptions:\n   -h,--help                           Display this help text\n   -id,--resourceId <ID>               Use resource identifier <ID> for the operation invocation\n   -o,--output <FILE>                  Write output resource to <FILE> (e.g. searchresults.json)\n   -op,--operation <OPERATION>         The operation to be invoked\n   -p,--properties <FILE>              Use FHIR Client properties contained in <FILE> (e.g.\n                                       fhir-cli.properties)\n   -qp,--queryParameter <NAME=VALUE>   Include query parameter NAME=VALUE with the operation\n                                       invocation (e.g. _count=100).\n   -r,--resource <FILE>                Use FHIR resource contained in <FILE> for operation\n                                       invocation (e.g. patient.json)\n   -t,--type <TYPE>                    Use resource type <TYPE> for the operation invocation (e.g.\n                                       \"Patient\")\n   -v,--verbose                        Display detailed output\n   -vid,--versionId <VID>              Use version # <VID> for the operation invocation\n\nOPERATION should be one of: batch | create | history | metadata | read | search | search-all |\nsearch-post | transaction | update | validate | vread\n```\n*   Invoke the 'metadata' operation\n```\n$ <fhir-cli-home>/fhir-cli --properties my-fhir-cli.properties --operation metadata --output conformance.json\n\nFHIR Client Command Line Interface (fhir-cli)    (c) Copyright IBM Corporation, 2016.\n\nInvoking operation 'metadata'... done! (651ms)\nStatus code: 200\nResponse resource written to file: conformance.json\n```\nNote: in this example the “--output” option is used to specify that the Conformance resource should be saved in file 'conformance.json'.\n*   Perform a _create_ operation\n```\n$ <fhir-cli-home>/fhir-cli --properties my-fhir-cli.properties --operation create --resource newpatient.json\n\nFHIR Client Command Line Interface (fhir-cli)    (c) Copyright IBM Corporation, 2016.\n\nInvoking operation _create_... done! (2719ms)\nStatus code: 201\nLocation URI: http://localhost:9443/fhir-server/api/v4/Patient/26b694ef-cea7-4485-a896-5ac2a1da9f64/_history/1\nETag: W/\"1\"\nLast modified: 2016-09-13T20:51:21.048Z\n```\nNote: In this example, the “--resource” option is used to indicate that the contents of the new resource to be created should be read from file 'newpatient.json'.\n*   Perform a 'read' operation\n```\n$ <fhir-cli-home>/fhir-cli --properties my-fhir-cli.properties --operation read --type Patient --resourceId 26b694ef-cea7-4485-a896-5ac2a1da9f64 -o patient1.json\n\nFHIR Client Command Line Interface (fhir-cli)    (c) Copyright IBM Corporation, 2016.\n\nInvoking operation 'read'... done! (321ms)\nStatus code: 200\nETag: W/\"1\"\nLast modified: 2016-09-13T20:51:21.048Z\nResponse resource written to file: patient1.json\n```\nNote: the “-o” option is used as a shortcut for “--output”\n*   Perform an _update_ operation\n```\n$ <fhir-cli-home>/fhir-cli --properties my-fhir-cli.properties --operation update --resource updatedpatient1.json\nFHIR Client Command Line Interface (fhir-cli)    (c) Copyright IBM Corporation, 2016.\n\nInvoking operation _update_... done! (2707ms)\nStatus code: 200\nLocation URI: http://localhost:9443/fhir-server/api/v4/Patient/26b694ef-cea7-4485-a896-5ac2a1da9f64/_history/2\nETag: W/\"2\"\nLast modified: 2016-09-13T21:11:48.988Z\n```\n*   Perform a 'vread' operation\n```\n$ <fhir-cli-home>/fhir-cli --properties my-fhir-cli.properties --operation vread -t Patient -id 26b694ef-cea7-4485-a896-5ac2a1da9f64 -vid 3 -o patient1v3.json\n\nFHIR Client Command Line Interface (fhir-cli)    (c) Copyright IBM Corporation, 2016.\n\nInvoking operation 'vread'... done! (290ms)\nStatus code: 200\nETag: W/\"3\"\nLast modified: 2016-09-13T21:18:28.412Z\nResponse resource written to file: patient1v3.json\n```\n*   Perform a 'history' operation\n```\n$ <fhir-cli-home>/fhir-cli --properties my-fhir-cli.properties --operation history -t Patient -id 26b694ef-cea7-4485-a896-5ac2a1da9f64 -o patient1history.json\n\nFHIR Client Command Line Interface (fhir-cli)    (c) Copyright IBM Corporation, 2016.\n\nInvoking operation 'history'... done! (414ms)\nStatus code: 200\nResponse resource written to file: patient1history.json\n```\nNote: in this example, the response resource is a Bundle containing the versions of the Patient resource.\n\n\n*   Perform a 'search' operation\n\n```\n$ <fhir-cli-home>/fhir-cli --properties my-fhir-cli.properties --operation search -t Patient -qp name=Doe -o searchresults.json\n\nFHIR Client Command Line Interface (fhir-cli)    (c) Copyright IBM Corporation, 2016.\n\nInvoking operation 'search'... done! (543ms)\nStatus code: 200\nResponse resource written to file: searchresults.json\n```\n\nNote: in this example the `-qp` option (shortcut for `–queryParameter`) is used to specify the search criteria (that is, `name=Doe`). The response resource is a Bundle that is written to the file `searchresults.json`.\n\n*   Perform a 'validate' operation\n\n```\n$ <fhir-cli-home>/fhir-cli --properties my-fhir-cli.properties --operation validate --resource newpatient.json\n\nFHIR Client Command Line Interface (fhir-cli)    (c) Copyright IBM Corporation, 2016.\n\nInvoking operation 'validate'... done! (3182ms)\nStatus code: 200\nResponse resource:\n\n{\n    \"resourceType\" : \"OperationOutcome\",\n    \"id\" : \"allok\",\n    \"text\" : {\n        \"status\" : \"additional\",\n        \"div\" : \"<div xmlns=\\\"http://www.w3.org/1999/xhtml\\\"><p>All OK</p></div>\"\n    },\n    \"issue\" : [ {\n        \"severity\" : \"information\",\n        \"code\" : \"informational\",\n        \"details\" : {\n            \"text\" : \"All OK\"\n        }\n    } ]\n}\n```\n\n## 4.8 Using local references within request bundles\nInter-dependencies between resources are typically defined by one resource containing a field of type `Reference` which contains an _external reference_<sup id=\"a5\">[5](#f5)</sup> to another resource. For example, an `Observation` resource could reference a `Patient` resource via the Observation's `subject` field. The value that is stored in the `Reference-type` field (for example, `subject` in the case of the `Observation` resource) could be an absolute URL, such as `https://fhirserver1:9443/fhir-server/api/v4/Patient/12345`, or a relative URL (for example, `Patient/12345`).\n\nIn order to establish a reference to a resource, you must first know its resource identifier. However, if you are using a request bundle to create both the referenced resource (`Patient` in this example) and the resource which references it (`Observation`), then it is impossible to know the `Patient`resource identifier before the request bundle has been processed (that is, before the new `Patient` resource is created).\n\nThankfully, the HL7 FHIR specification defines a way to express a dependency between two resources within a request bundle by using a _local reference_<sup id=\"a6\">[6](#f6)</sup>. In the following example, a request bundle contains a `POST` request to create a new `Patient` resource, along with a `POST` request to create a new `Observation` resource that references that `Patient`:\n\n#### 4.8.0.1 Example 1: Observation references Patient via local reference\n```\n{\n    \"resourceType\" : \"Bundle\",\n    \"type\" : \"batch\",\n    \"entry\" : [ {\n        \"fullUrl\" : \"urn:uuid:7113a0bb-d9e0-49df-9855-887409388c69\",\n        \"resource\" : {\n            \"resourceType\" : \"Patient\",\n            …\n        },\n        \"request\" : {\n            \"method\" : \"POST\",\n            \"url\" : \"Patient\"\n        }\n    }, {\n        \"resource\" : {\n            \"resourceType\" : \"Observation\",\n            …\n            \"subject\" : {\n                \"reference\" : \"urn:uuid:7113a0bb-d9e0-49df-9855-887409388c69\"\n            },\n            …\n        },\n        \"request\" : {\n            \"method\" : \"POST\",\n            \"url\" : \"Observation\"\n        }\n    } ]\n}\n```\n\nIn order to reference a resource via a local reference, you must first define a local identifier for that resource by specifying the `fullUrl` field within the request entry. To define a local identifier, use a value that starts with `urn:` as in the preceding example. The HL7 FHIR specification highly recommends that the value of the identifier should be a UUID-type value, although the FHIR server does not require the use of a UUID value. You can use any value you like after the `urn:` prefix as long as it is unique within the bundle. For example, you can use urn:Patient_1, urn:ABC, or urn:Foo. Just make sure that no two request entries share the same fullUrl value within the request bundle.\n\nAfter you define a local identifier for the referenced resource, you can then define one or more references to that resource by using the local identifier instead of an external identifier. In the preceding example, you can see that the Observation's `subject.reference` field specifies the Patient's local identifier as specified in the `fullUrl` field of the Patient's request entry.\n\n### 4.8.1 Processing rules\nThe following processing rules apply for the use of local references within a request bundle:\n1.  A local identifier must be defined via a request entry's `fullUrl` field in order for that local identifier to be used in a local reference.\n2.  Local references will only be recognized for local identifiers associated with requst entries with a request method of `POST` or `PUT`.\n3.  `POST` requests will be processed before `PUT` requests.\n4.  There is no order dependency within a request bundle for request entries defining local identifiers, and request entries which reference those local identifiers via local reference. The exception to this rule is for request entries which specify [conditional create](https://www.hl7.org/fhir/http.html#ccreate) or [conditional update](https://www.hl7.org/fhir/http.html#cond-update) requests.\n5.  If a request entry specifying a conditional create or update request defines a local identifier, that request entry must be processed before a request entry which references the local identifier in a local reference.\n\nIn the example in [Section 4.8.0.1](#4801-example-1-observation-references-patient-via-local-reference), you can see that there are two POST requests and the `Patient` request entry appears in the bundle before the `Observation` request entry. However, based on rule 4, it would still be a valid request bundle if the `Observation` request entry appeared before the `Patient` request entry, unless the `Patient` request entry specified a conditional create (rule 5).\n\nIf those entries were reversed, and the `Patient` request entry specified a conditional create, then the FHIR server would return an error when processing the `Observation` request entry, because the `Patient` local identifier would not be defined yet.\n\nThe following examples also satisfy the local reference processing rules:\n\n#### 4.8.1.1 Example 2: Observation (PUT) appears before Patient (POST)\n```\n{\n    \"resourceType\" : \"Bundle\",\n    \"type\" : \"batch\",\n    \"entry\" : [ {\n        \"resource\" : {\n            \"resourceType\" : \"Observation\",\n            \"id\" : \"25b1fe08-7612-45eb-af80-7e15d9806b2b\",\n            …\n            \"subject\" : {\n                    \"reference\" : \"urn:Patient_1\"\n            },\n            …\n        },\n        \"request\" : {\n            \"method\" : \"PUT\",\n            \"url\" : \"Observation/25b1fe08-7612-45eb-af80-7e15d9806b2b\"\n        }\n    }, {\n        \"fullUrl\" : \"urn:Patient_1\",\n        \"resource\" : {\n            \"resourceType\" : \"Patient\",\n            …\n        },\n        \"request\" : {\n            \"method\" : \"POST\",\n            \"url\" : \"Patient\"\n        }\n    } ]\n}\n```\n\nIn Example 2, if the `Patient` request entry was a conditional create request, this would still be a valid request bundle, because `POST` requests are processed before `PUT` requests (rule 3). This means the `Patient` request entry would be processed before the `Observation` request entry, and thus the `Patient` local identifier would be defined when the `Observation` request entry was processed.\n\n#### 4.8.1.2 Example 3: Encounter and Procedure circular references\n```\n{\n    \"resourceType\" : \"Bundle\",\n    \"type\" : \"batch\",\n    \"entry\" : [ {\n        \"fullUrl\" : \"urn:Encounter_1\",\n        \"resource\" : {\n            \"resourceType\" : \"Encounter\",\n            …\n            \"reasonReference\" : [ {\n                    \"reference\" : \"urn:Procedure_1\"\n            } ],\n            …\n        },\n        \"request\" : {\n            \"method\" : \"POST\",\n            \"url\" : \"Encounter\"\n        }\n    }, {\n        \"fullUrl\" : \"urn:Procedure_1\",\n        \"resource\" : {\n            \"resourceType\" : \"Procedure\",\n            …\n            \"encounter\" : {\n                    \"reference\" : \"urn:Encounter_1\"\n            },\n            …\n        },\n        \"request\" : {\n            \"method\" : \"POST\",\n            \"url\" : \"Procedure\"\n        }\n    } ]\n}\n```\n\nWhile processing a request bundle, but before processing individual request entries, the IBM FHIR server detects the use of a local identifier within any `POST` or `PUT` request entry's `fullUrl` field, and establishes a mapping between that local identifier and the corresponding external identifier that results from performing the `POST` or `PUT` operation.\n\nUsing Example 3, the FHIR server detects the use of local identifiers in the `Encounter` request entry (`urn:Encounter_1`) and in the `Procedure` request entry (`urn:Procedure_1`), and establishes a mapping between the local identifiers and the external references to be associated with the new `Encounter` and `Procedure` resources (for example, `Encounter/1cc5d299-d2be-4f93-8745-a121232ffe5b` and `Procedure/22b21fcf-8d00-492d-9de0-e25ddd409eaf`).\n\nThen when the FHIR server processes the POST requests for the `Encounter` and `Procedure` resources, it detects the use of the local references and substitutes the corresponding external references for them before creating the new resources. Here is an example of a response bundle for the request bundle depicted in Example 3 in which we can see that the Encounter's `reasonReference.reference` field now contains a proper external reference to the newly-created `Procedure` resource, and the Procedure's `encounter.reference` field now contains a proper external reference to the newly-created `Encounter` resource:\n\n#### 4.8.1.3 Example 4: Response bundle for Example 3\n```\n{\n    \"resourceType\" : \"Bundle\",\n    \"type\" : \"batch-response\",\n    \"entry\" : [ {\n        \"resource\" : {\n            \"resourceType\" : \"Encounter\",\n            \"id\" : \"1cc5d299-d2be-4f93-8745-a121232ffe5b\",\n            …\n            \"reasonReference\" : [ {\n                    \"reference\" : \"Procedure/22b21fcf-8d00-492d-9de0-e25ddd409eaf\"\n            } ],\n            …\n        },\n        \"response\" : {\n            \"id\" : \"1cc5d299-d2be-4f93-8745-a121232ffe5b\",\n            \"status\" : \"201\",\n            \"location\" : \"Encounter/1cc5d299-d2be-4f93-8745-a121232ffe5b/_history/1\",\n            \"etag\" : \"W/\\\"1\\\"\",\n            \"lastModified\" : \"2017-03-01T20:56:59.540Z\"\n        }\n    }, {\n        \"resource\" : {\n            \"resourceType\" : \"Procedure\",\n            \"id\" : \"22b21fcf-8d00-492d-9de0-e25ddd409eaf\",\n            …\n            \"encounter\" : {\n                \"reference\" : \"Encounter/1cc5d299-d2be-4f93-8745-a121232ffe5b\"\n            },\n            …\n        },\n        \"response\" : {\n            \"id\" : \"22b21fcf-8d00-492d-9de0-e25ddd409eaf\",\n            \"status\" : \"201\",\n            \"location\" : \"Procedure/22b21fcf-8d00-492d-9de0-e25ddd409eaf/_history/1\",\n            \"etag\" : \"W/\\\"1\\\"\",\n            \"lastModified\" : \"2017-03-01T20:56:59.652Z\"\n        }\n    } ]\n}\n```\n\n## 4.9 Multi-tenancy\nThe FHIR server includes features that allow a single instance of the server to simultaneously support multiple tenants. A tenant is defined as a group of one or more FHIR REST API consumers that share a FHIR server configuration along with one or more data stores associated with that configuration. A tenant could be a single application using the FHIR REST API, or it could be a group of applications belonging to a single customer. The main idea behind multi-tenancy is that each tenant can experience its own customized FHIR server runtime behavior and its data can be physically isolated from other tenants' data for increased security and privacy.\n\n### 4.9.1 Specifying the tenant id\nTo support multi-tenancy, the FHIR server must know which tenant an incoming REST API request is intended for. To provide the tenant id to the FHIR server, a REST API consumer must set a request header in each REST API request. The name of this request header is itself configurable by setting the `fhirServer/core/tenantIdHeaderName` configuration property in the FHIR server's global configuration file (located at `$⁠{server.config.dir}/config/default/fhir-server-config.json`). The following example shows the default setting for this configuration parameter:\n```\n\n{\n  \"fhirServer\":{\n      \"core\":{\n            \"tenantIdHeaderName\":\"X-FHIR-TENANT-ID\"\n      },\n      …\n   }\n}\n```\n\nWith this configuration in place, each REST API consumer would need to set the `X-FHIR-TENANT-ID` request header to the appropriate tenant id. Each tenant's tenant id value is assigned by the deployer. It is simply a short name associated with the tenant and must be unique among all tenants supported by a single FHIR server instance. For example, let's suppose Acme Healthcare, Inc. is using the FHIR server and their tenant id has been assigned by the deployer as “acme”. In this case, Acme-related applications would set the following request header in each REST API request: `X-FHIR-TENANT-ID: acme`\n\nAs mentioned earlier, the name of the request header is configurable in the FHIR server's global configuration file. For example, the FHIR server deployer could configure the request header name to be `X-WHCLSF-tenant-id` by setting `tenantIdHeaderName` as shown in the following example:\n```\n{\n   \"fhirServer\":{\n      \"core\":{\n            \"tenantIdHeaderName\":\"X-WHCLSF-tenant-id\"\n      },\n      …\n   }\n}\n```\n\nThis would be useful in an environment where the applications might already be using a similar type of request header. With this configuration in place, the “Acme Healthcare, Inc.” tenant would set the following request header in each REST API request:\n    `X-WHCLSF-tenant-id: acme`\n\n\n### 4.9.2 Configuration properties\nThe FHIR server allows a deployer to configure a subset of the supported configuration properties on a tenant-specific basis.\nFor a complete list of configuration properties supported on a per-tenant basis, see [Section 5.1.3 Property attributes](#513-property-attributes).\n\nWhen the FHIR server needs to retrieve any of the tenant-specific configuration properties, it does so dynamically each time the property value is needed. This means that a deployer can change the value of a tenant-specific property within a tenant's configuration file on disk, and the FHIR server will immediately “see” the new value the next time it tries to retrieve it. For example, suppose the deployer initially defines the `acme` tenant's `fhir-server-config.json` file such that the `fhirServer/core/defaultPrettyPrint` property is set to true.\n\nRequests from the `acme` tenant would result in pretty-printed responses (with newlines and indentation), making it easier for humans to read.\nNow suppose the deployer changes the value of that property to true within the `acme` tenant's `fhir-server-config.json` file.\nA subsequent REST API request would then see the output condensed into a single line with minimal whitespace.\n\n#### 4.9.2.1 Examples\nThis section contains examples of both a global (default) configuration and a tenant-specific configuration.\n\n##### Global configuration (default)\nThe global configuration contains non-tenant specific configuration parameters (configuration parameters that are not resolved or used on a tenant-specific basis), as well as default values for tenant-specific configuration parameters.\n\n`${server.config.dir}/config/default/fhir-server-config.json`\n\n```\n{\n    \"__comment\":\"FHIR server global (default) configuration\",\n    \"fhirServer\":{\n        \"core\":{\n            \"defaultPrettyPrint\":false,\n            \"tenantIdHeaderName\":\"X-FHIR-TENANT-ID\"\n        },\n        \"notifications\":{\n            \"common\":{\n                \"includeResourceTypes\":[\n                    \"QuestionnaireResponse\",\n                    \"CarePlan\",\n                    \"MedicationAdministration\",\n                    \"Device\",\n                    \"DeviceComponent\",\n                    \"DeviceMetric\",\n                    \"MedicationOrder\",\n                    \"Observation\"\n                ]\n            },\n            \"websocket\":{\n                \"enabled\":false\n            },\n            \"kafka\":{\n                \"enabled\":false,\n                \"topicName\":\"fhirNotifications\",\n                \"connectionProperties\":{\n                }\n            }\n        },\n        \"audit\": {\n            \"serviceClassName\" : \"com.ibm.fhir.audit.impl.NopService\",\n            \"serviceProperties\" : {\n            }\n        },\n        \"persistence\":{\n            \"factoryClassname\":\"com.ibm.fhir.persistence.jdbc.FHIRPersistenceJDBCFactory\",\n            \"common\":{\n                \"__comment\":\"Configuration properties common to all persistence layer implementations\",\n                \"updateCreateEnabled\":true\n            },\n            \"jdbc\":{\n                \"__comment\":\"Configuration properties for the JDBC persistence implementation\",\n            },\n        …\n        }\n    …\n    }\n```\n\n##### Acme Healthcare, Inc. (acme)\nThe Acme Healthcare, Inc tenant configuration overrides the `fhirServer/core/defaultPrettyPrint` property so that the development\nteam can more easilly read the messages.\n\n`${server.config.dir}/config/acme/fhir-server-config.json`\n\n```\n{\n    \"__comment\":\"FHIR server configuration for tenant: Acme Healthcare, Inc.\",\n    \"fhirServer\":{\n        \"core\":{\n            \"defaultPrettyPrint\":true\n        }\n    }\n}\n```\n\nIt is also possible to configure the persistence properties for a specific tenant, for example to set an alternate\ndatabase hostname or database schema name.\n\n## 4.10 Bulk data operations\nThe IBM FHIR Server implements bulk data export according to the [HL7 FHIR BulkDataAccess IG: STU1](http://hl7.org/fhir/uv/bulkdata/STU1/export/index.html), and bulk data import is implemented according to the [Proposal for $import Operation](https://github.com/smart-on-fhir/bulk-import/blob/master/import.md).\n\nThere are 2 modules involved:\n\n- fhir-operation-bulkdata\n- fhir-bulkdata-webapp   \n\nThe *fhir-operation-bulkdata* module implements the REST APIs for bulk data export, import and status as FHIR Operations.  There are five operations:\n\n| Operation | Path |\n|-----|-----|\n| ExportOperation| system `$export` |\n| PatientExportOperation| Patient `Patient/$export` |\n| GroupExportOperation| Group `Group/[id]/$export` |\n| ImportOperation | import resources using the system endpoint, `$import` |\n| StatusOperation | polling status for import and export `$bulkdata-status` |\n\nEach operation queues a job with the Open Liberty JavaBatch framework. Each job instance unit-of-work is executed as a job with the *fhir-bulkdata-webapp* module. There are 5 JavaBatch jobs defined in the *fhir-bulkdata-webapp* module for the above 3 export operations and 1 import operation:\n\n| Java Batch Job | Operation |\n|-----|-----|\n| FhirBulkExportChunkJob| `$export` |\n| FhirBulkExportFastJob| `$export` |\n| FhirBulkExportPatientChunkJob| `Patient/$export` |\n| FhirBulkExportGroupChunkJob| `Group/[id]/$export` |\n| FhirBulkImportChunkJob | `$import` |\n\nThe *fhir-bulkdata-webapp* module is a wrapper for the whole BulkData web application, which is the build artifact - fhir-bulkdata-webapp.war. This web archive is copied to the `apps/` directory of the liberty server. The feature is configured using the `configDropins/default/bulkdata.xml`, such as:\n\n```xml\n<webApplication id=\"fhir-bulkdata-webapp\" location=\"fhir-bulkdata-webapp.war\" name=\"fhir-bulkdata-webapp\">\n    <classloader privateLibraryRef=\"configResources,fhirUserLib\"/>\n    <application-bnd>\n        <security-role id=\"users\" name=\"FHIRUsers\">\n            <group id=\"bulkUsersGroup\" name=\"FHIRUsers\"/>\n        </security-role>\n    </application-bnd>\n</webApplication>\n```\n\nThe Bulk Data web application writes the exported FHIR resources to an IBM Cloud Object Storage (COS), any Amazon S3-Compatible bucket (e.g, Amazon S3, minIO etc), or directory as configured in the per-tenant server configuration under `fhirServer/bulkdata`. The following is an example configuration for bulkdata; please refer to section 5 for the detailed description of these properties:\n\n``` json\n\"bulkdata\": {\n    \"enabled\": true,\n    \"core\": {\n        \"api\": {\n            \"url\": \"https://localhost:9443/ibm/api/batch\",\n            \"user\": \"fhiradmin\",\n            \"password\": \"change-password\",\n            \"truststore\": \"resources/security/fhirTrustStore.p12\",\n            \"truststorePassword\": \"change-password\"\n        },\n        \"cos\" : {\n            \"useServerTruststore\": true\n        },\n        \"pageSize\": 100,\n        \"batchIdEncryptionKey\": \"example-password\",\n        \"maxPartitions\": 3,\n        \"maxInputs\": 5\n    },\n    \"storageProviders\": {\n        \"default\" : {\n            \"type\": \"file\",\n            \"fileBase\": \"${WLP_OUTPUT_DIR}/fhir-server/output\",\n            \"exportPublic\": true,\n            \"disableOperationOutcomes\": true,\n            \"duplicationCheck\": false,\n            \"validateResources\": false\n        },\n        \"minio\" : {\n            \"type\": \"aws-s3\",\n            \"bucketName\": \"fhirbulkdata\",\n            \"location\": \"us\",\n            \"endpointInternal\": \"https://minio:9000\",\n            \"endpointExternal\": \"https://localhost:9000\",\n            \"auth\" : {\n                \"type\": \"hmac\",\n                \"accessKeyId\": \"example\",\n                \"secretAccessKey\": \"example-password\"\n            },\n            \"enableParquet\": false,\n            \"disableBaseUrlValidation\": true,\n            \"exportPublic\": true,\n            \"disableOperationOutcomes\": true,\n            \"duplicationCheck\": false,\n            \"validateResources\": false,\n            \"create\": false,\n            \"presigned\": true\n        }\n    }\n}\n```\n\nEach tenant's configuration may define multiple storageProviders. The default is assumed, unless specified with the `X-FHIR-BULKDATA-PROVIDER` and `X-FHIR-BULKDATA-PROVIDER-OUTCOME`. Each tenant's configuration may mix the different providers, however each provider is only of a single type. For instance, `minio` is `aws-s3` and `default` is `file`. Note, type `http` is only applicable to `$import` operations. Export is only supported with s3 and file.\n\nTo use Amazon S3 bucket for exporting, please set `accessKeyId` to S3 access key, and set `secretAccessKey` to the S3 secret key, and the auth type to `hmac`.\n\nBasic system exports to S3 without typeFilters use a streamlined implementation which bypasses the IBM FHIR Server Search API for direct access to the data enabling better throughput. The `fhirServer/bulkdata/core/systemExportImpl` property can be used to disable the streamlined system export implementation. To use the legacy implementation based on IBM FHIR Server search, set the value to \"legacy\". The new system export implementation is used by default for any export not using typeFilters. Exports using typeFilters use FHIR Search, and cannot use the streamlined export.\n\nTo import using the `$import` operation with `https`, one must additionally configure the `fhirServer/bulkdata/validBaseUrls`. For example, if one stores bulk data at `https://test-url1.cos.ibm.com/bucket1/test.ndjson` and `https://test-url2.cos.ibm.com/bucket2/test2.ndjson` you must specify both baseUrls in the configuration:\n\n```json\n    \"validBaseUrls\": [\n        \"https://test-url1.cos.ibm.com/bucket1\",\n        \"https://test-url2.cos.ibm.com/bucket2\"\n    ]\n```\n\nThese base urls are not checked when using cloud object store and bulk-import. If you need to disable the validBaseUrls feature you may add `fhirServer/bulkdata/storageProviders/(source)/disableBaseUrlValidation` as `true`.\n\nFor Bulk Data import, the `fhirServer/bulkdata/core/maxInputs` is used to configure a maximum number of inputs supported by the instance. The default number is 5. There is a hard character limit on the total input type and url must be under 4096 characters, as such the configuration may be tuned for each url scheme.\n\nNote: When `$import` is executed, if a resource to import includes a `Resource.id` then this id is honored (via create-on-update). If `Resource.id` is not valued, the server will perform a create and assign a new `Resource.id` for this resource.\n\nFollowing is the beautified response of sample polling location request after the export is finished:\n\n```json\n{\n\"transactionTime\": \"2020/01/20 16:53:41.160 -0500\",\n\"request\": \"https://myserver/fhir-server/api/v4/$export?_type=Patient\",\n\"requiresAccessToken\": false,\n\"output\" : [\n  { \"type\" : \"AllergyIntolerance\",\n      \"url\": \"https://s3.us-south.cloud-object-storage.appdomain.cloud/fhir-bulkimexport-connectathon/6SfXzbGvYl1nTjGbf5qeqJDFNjyljiGdKxXEJb4yJn8=/AllergyIntolerance_1.ndjson\",\n    \"count\": 20},\n  { \"type\" : \"AllergyIntolerance\",\n      \"url\": \"https://s3.us-south.cloud-object-storage.appdomain.cloud/fhir-bulkimexport-connectathon/6SfXzbGvYl1nTjGbf5qeqJDFNjyljiGdKxXEJb4yJn8=/AllergyIntolerance_2.ndjson\",\n    \"count\": 8},\n  { \"type\" : \"Observation\",\n      \"url\": \"https://s3.us-south.cloud-object-storage.appdomain.cloud/fhir-bulkimexport-connectathon/6SfXzbGvYl1nTjGbf5qeqJDFNjyljiGdKxXEJb4yJn8=/Observation_1.ndjson\",\n    \"count\": 234},\n  { \"type\" : \"Observation\",\n      \"url\": \"https://s3.us-south.cloud-object-storage.appdomain.cloud/fhir-bulkimexport-connectathon/6SfXzbGvYl1nTjGbf5qeqJDFNjyljiGdKxXEJb4yJn8=/Observation_2.ndjson\",\n    \"count\": 81}]\n}\n```\n\nFor the Import Operation, the polled status includes an indication of `$import` and the location of the OperationOutcome NDJSON files and the corresponding failure and success counts.\n\nFor S3 exports, the bulk data feature may use presigned urls.  To enable presigned urls, the authentication type must be `hmac` and `fhirServer/bulkdata/storageProviders/(source)/presigned` must be `true`.  The urls become:\n\n```\nhttps://s3.appdomain.cloud/fhir-example/Patient_1.ndjson?X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Credential=fcEXbf9cc1ac49e99eEX77%2F20210228%2Fus%2Fs3%2Faws4_request&X-Amz-Date=20210EXT160538Z&X-Amz-Expires=86400&X-Amz-SignedHeaders=host&X-Amz-Signature=5ecfc207546b9737fd38d4f0EXEX1c58f4f82976338a44c\n```\n\nThe presigned URL is valid for 86400 seconds (1 day).\n\nNote, the deletion of an a job is split into two phases, ACCEPTED (202) response and DELETED (204).  202 is returned until the operation is stopped or removed, and then 204.\n\nBy default, the exported `ndjson` file is configured with public access automatically and with 2 hours expiration time, the randomly generated secret in the path is used to protect the file. Please note that IBM COS does not support expiration time for each single COS object, so please configure retention policy (e.g, 1 day) for the bucket if IBM COS is used. For both Amazon S3 and IBM COS, please remember that public access should never be configured to the bucket itself.\n\nNote: `fhirServer/bulkdata/storageProviders/(source)/exportPublic` can be set to \"false\" to disable public access. Also, *minio* doesn't support object level ACL, so access token is always needed to download the exported `ndjson` files.\n\nJavaBatch feature must be enabled in `server.xml` as following on the Liberty server:\n\n```xml\n<featureManager>\n    ...\n    <feature>batchManagement-1.0</feature>\n    ...\n</featureManager>\n```\n\nThe JavaBatch user is configured in `bulkdata.xml` and the `fhir-server-config.json`:\n\n```xml\n<authorization-roles id=\"com.ibm.ws.batch\">\n\t<security-role name=\"batchAdmin\">\n\t\t<user name=\"fhiradmin\"/>\n\t</security-role>\n\t<security-role name=\"batchSubmitter\">\n\t\t<user name=\"fhiruser\"/>\n\t</security-role>\n\t<security-role name=\"batchMonitor\">\n\t\t<user name=\"fhiradmin\"/>\n\t\t<user name=\"fhiruser\"/>\n\t</security-role>\n</authorization-roles>\n```\n\nNote: The batch-user referenced in the `fhir-server-config.json` must have a role of at least batchSubmitter.\n\nBy default, in-memory Derby database is used for persistence of the JavaBatch Jobs as configured in `fhir-server/configDropins/defaults/bulkdata.xml`. This database is destroyed on the restart of the IBM FHIR Server, and does not support load balancing.\n\nTo support IBM Db2 on IBM Cloud, copy `fhir-server/configDropins/disabled/db2-cloud/bulkdata.xml` to `fhir-server/configDropins/defaults/bulkdata.xml` replacing the existing bulkdata.xml. One can configure the Datasource by setting the following environment variables:\n\n| Variable          | Default     | Description                                                    |\n|-------------------|-------------|----------------------------------------------------------------|\n| BATCH_DB_HOSTNAME | `blank`     | The hostname of the db2 instance                               |\n| BATCH_DB_NAME     | BLUDB       | The database name                                              |\n| BATCH_DB_SCHEMA   | FHIR_JBATCH | The Schema Name configured to support the Java Batch framework |\n| BATCH_DB_PORT     | 50001       | The port configured to support the database                    |\n| BATCH_DB_APIKEY   | `blank`     | The API Key for the Db2 Cloud database                         |\n\nInstruction is also provided in 'Configuring a Liberty Datasource with API Key' section of the DB2OnCloudSetup guide to configure DB2 service in IBM Clouds as JavaBatch persistence store. The JavaBatch schema is created using the `fhir-persistence-schema` command line interface jar.\n\nTo support IBM Db2 with a user-name and password , copy `fhir-server/configDropins/disabled/db2/bulkdata.xml` to `fhir-server/configDropins/defaults/bulkdata.xml` replacing the existing bulkdata.xml. One can configure the Datasource by setting the following environment variables:\n\n| Variable          | Default         | Description                                                    |\n|-------------------|-----------------|----------------------------------------------------------------|\n| BATCH_DB_HOSTNAME | `blank`         | The hostname of the db2 instance                               |\n| BATCH_DB_NAME     | FHIRDB          | The database name                                              |\n| BATCH_DB_SCHEMA   | FHIR_JBATCH     | The Schema Name configured to support the Java Batch framework |\n| BATCH_DB_PORT     | 50000           | The port configured to support the database                    |\n| BATCH_DB_USER     | db2inst1        | The user for the Db2 database                                  |\n| BATCH_DB_PASSWORD | `blank`         | The password for the Db2 database                              |\n| BATCH_DB_SSL      | true            | The ssl connection is either true or false                     |\n\nIf one wants to support Postgres with a user-name and password , one should copy `fhir-server/configDropins/disabled/postgres/bulkdata.xml` to `fhir-server/configDropins/defaults/bulkdata.xml` replacing the existing bulkdata.xml. One can configure the Datasource by setting the following environment variables:\n\n| Variable               | Default         | Description                                                    |\n|------------------------|-----------------|----------------------------------------------------------------|\n| BATCH_DB_HOSTNAME      | `blank`         | The hostname of the postgres instance                          |\n| BATCH_DB_NAME          | FHIRDB          | The database name                                              |\n| BATCH_DB_SCHEMA        | FHIR_JBATCH     | The Schema Name configured to support the Java Batch framework |\n| BATCH_DB_PORT          | 5432            | The port configured to support the database                    |\n| BATCH_DB_USER          | fhirserver      | The user for the postgres database                             |\n| BATCH_DB_PASSWORD      | `blank`         | The password for the postgres database                         |\n| BATCH_DB_SSL           | true            | The ssl connection is either true or false                     |\n| BATCH_DB_SSL_CERT_PATH | false           | The ssl connection is either true or false                     |\n\nNote: If you use PostgreSQL database as IBM FHIR Server data store or the JavaBatch job repository, please enable `max_prepared_transactions` in postgresql.conf, otherwise the import/export JavaBatch jobs fail.\n\nFor more information about Liberty JavaBatch configuration, please refer to [IBM WebSphere Liberty Java Batch White paper](https://www-03.ibm.com/support/techdocs/atsmastr.nsf/webindex/wp102544).\n\n### 4.10.1 Integration Testing\nTo integration test, there are tests in `ExportOperationTest.java` in `fhir-server-test` module with server integration test cases for system, patient and group export. Further, there are tests in `ImportOperationTest.java` in `fhir-server-test` module. These tests rely on the `fhir-server-config-db2.json` which specifies two storageProviders.\n\n### 4.10.2 Export to Parquet\nVersion 4.4 of the IBM FHIR Server introduced experimental support for exporting to Parquet format (as an alternative to the default NDJSON export). However, due to the size of the dependencies needed to make this work, this feature is disabled by default.\n\nTo enable export to parquet, an administrator must:\n1. make Apache Spark (version 3.0) and the IBM Stocator adapter (version 1.1) available to the fhir-bulkdata-webapp by dropping the necessary jar files under `fhir-server/userlib` directory; and\n2. set the `/fhirServer/bulkdata/storageProviders/(source)/enableParquet` config property to `true`\n\nAn alternative way to accomplish the first part of this is to change the scope of these dependencies from the fhir-bulkdata-webapp pom.xml and rebuild the webapp to include them.\n\n### 4.10.3 Job Logs\nBecause the bulk import and export operations are built on Liberty's java batch implementation, users may need to check the [Liberty batch job logs](https://www.ibm.com/support/knowledgecenter/SSEQTP_liberty/com.ibm.websphere.wlp.doc/ae/rwlp_batch_view_joblog.html) for detailed step information / troubleshooting.\n\nIn a standard installation, these logs will be at `wlp/usr/servers/fhir-server/logs/joblogs`.\nIn the `ibmcom/ibm-fhir-server` docker image, these logs will be at `/logs/joblogs`.\n\nNote, if you are using the default derby, the logs are overwritten upon restart of the server. You should use Db2 or Postgres for production purposes.\n\n## 4.11 Audit logging service\nThe Audit logging service pushes FHIR server audit events for FHIR operations in [Cloud Auditing Data Federation (CADF)](https://www.dmtf.org/standards/cadf) standard format to a Kafka backend, such as *IBM Cloud Event Streams service*.\n\nThere is early support for the [FHIR Standard: AuditEvent format](https://www.hl7.org/fhir/auditevent.html).\n\n### 4.11.1 CADF audit log entry\n\nEach FHIR interaction triggers a CADF audit log entry to be logged. The mapping of FHIR interaction to CADF action is as follows:\n\n| FHIR Interaction                                    | CADF Action |\n|-----------------------------------------------------|-------------|\n|`history,metadata,read,search,validate,version read` |   read      |\n|`create`                                             |   create    |\n|`update`                                             |   update    |\n|`delete`                                             |   delete    |\n|`bundle,custom operation,patch`                      |   unknown   |\n\nThe following table describes the JSON fields of the CADF audit log entries logged by the FHIR server:\n\n| CADF Audit Log Entry Field                           | Description |\n|------------------------------------------------------|-------------|\n|`action`                                              |Action that created the audit event. Possible values are \"read\", \"update\", \"create\", \"delete\", and \"unknown\".|\n|`eventTime`                                           |Audit event creation timestamp.|\n|`eventType`                                           |Audit event type. Value is always \"activity\".|\n|`id`                                                  |Globally unique identifier for the audit event.|\n|`outcome`                                             |Action outcome. Possible values are \"success\", \"failure\", \"unknown\", and \"pending\".|\n|`typeURI`                                             |TypeURI property of the CADF event entity. Value is always \"http://schemas.dmtf.org/cloud/audit/1.0/event\".|\n|`attachments`                                         |Note: Contains FHIR server-specific audit event data.|\n|`attachments/contentType`                             |FHIR server-specific audit event data content type. Value is always \"application/json\".|\n|`attachments/content`                                 |Note: Contents of this field (with its subfields) is encoded as Base64.\n|`attachments/content/request_unique_id`               |Globally unique identifier for the FHIR server request.|\n|`attachments/content/action`                          |FHIR action type. Possible values are \"C\" (create), \"U\" (update), \"R\" (read), \"D\" (delete), \"P\" (patch), and \"O\" (custom operation).|\n|`attachments/content/operation_name`                  |FHIR custom operation name.|\n|`attachments/content/start_time`                      |FHIR request start time.|\n|`attachments/content/end_time`                        |FHIR request end time.|\n|`attachments/content/api_parameters/request`          |FHIR request URL.|\n|`attachments/content/api_parameters/request_status`   |FHIR request HTTP status (e.g. 200).|\n|`attachments/content/data/resource_type`              |Resource type of FHIR resource that was created, updated, or deleted.|\n|`attachments/content/data/id`                         |Resource ID of FHIR resource that was created, updated, or deleted.|\n|`attachments/content/data/version`                    |Updated version of FHIR resource that was created, updated, or deleted.|\n|`attachments/content/batch/resources_read`            |FHIR resource count retrieved on a search request.|\n|`attachments/content/event_type`                      |FHIR event type. Possible values are \"fhir-create\", \"fhir-update\", \"fhir-patch\", \"fhir-delete\", \"fhir-read\", \"fhir-version-read\", \"fhir-history\", \"fhir-search\", \"fhir-bundle\", \"fhir-validate\", \"fhir-metadata\", and \"fhir-operation\".|\n|`attachments/content/description`                     |FHIR event type description. Possible values are \"FHIR Create request\", \"FHIR Update request\", \"FHIR Patch request\", \"FHIR Delete request\", \"FHIR Read request\", \"FHIR VersionRead request\", \"FHIR History request\", \"FHIR Search request\", \"FHIR Bundle request\", \"FHIR Validate request\", \"FHIR Metadata request\", and \"FHIR Operation request\".|\n|`attachments/content/client_cert_cn`                  |Value is determined by \"IBM-App-cli-CN\" HTTP header of the FHIR request.|\n|`attachments/content/client_cert_issuer_ou`           |Value is determined by \"IBM-App-iss-OU\" HTTP header of the FHIR request.|\n|`attachments/content/location`                        |IP address and hostname of the source of the FHIR request.|\n|`initiator/id`                                        |Value is always \"TENANT_ID@fhir-server\", where TENANT_ID is replaced with the tenant ID.|\n|`initiator/typeURI`                                   |Value is always \"compute/machine\".|\n|`initiator/host`                                      |IP address of FHIR server localhost.|\n|`initiator/credential/token`                          |Value is always \"user-AUTH_USER\", where AUTH_USER is replaced with the name of the authenticated user.|\n|`initiator/geolocation/city`                          |Value determined by \"fhirServer/audit/serviceProperties/geoCity\" configuration property.|\n|`initiator/geolocation/state`                         |Value determined by \"fhirServer/audit/serviceProperties/geoState\" configuration property.|\n|`initiator/geolocation/region`                        |Value determined by \"fhirServer/audit/serviceProperties/geoCounty\" configuration property.|\n|`observer/id`                                         |Value is always \"fhir-server\".|\n|`observer/typeURI`                                    |Value is always \"compute/node\".|\n|`observer/name`                                       |Value is always \"Fhir Audit\".|\n|`observer/geolocation/city`                           |Value is determined by \"fhirServer/audit/serviceProperties/geoCity\" configuration property.|\n|`observer/geolocation/state`                          |Value is determined by \"fhirServer/audit/serviceProperties/geoState\" configuration property.|\n|`observer/geolocation/region`                         |Value is determined by \"fhirServer/audit/serviceProperties/geoCounty\" configuration property.|\n\n### 4.11.2 Enable audit logging service\nPlease refer to the property names that start with `fhirServer/audit/` in [5.1 Configuration properties reference](#51-configuration-properties-reference) for how to enable and configure the CADF audit logging service.\n\n### 4.11.3 Configuration of audit logging service\n\nThere are two types of configuration for the Audit Logging Service. The first type is using the environment variable, and the second is the configuration driven from the fhir-server-config.json.\n\nFor example, the following uses the 'config' in order to config the Kafka publisher as part of the audit logging service.\n\n```\n\"audit\": {\n    \"serviceClassName\" : \"com.ibm.fhir.audit.impl.KafkaService\",\n    \"serviceProperties\" : {\n        \"load\": \"config\",\n    }\n```\n\nOr, you could load from an environment, note, this is the default behavior.\n\n```\n\"audit\": {\n    \"serviceClassName\" : \"com.ibm.fhir.audit.impl.KafkaService\",\n    \"serviceProperties\" : {\n        \"load\": \"environment\",\n    }\n```\n\n#### 4.11.3.1 Environment Variable Configuration of audit logging service\n\nThe audit logging service gets the event streams service credential from environment variable EVENT_STREAMS_AUDIT_BINDING with values like this:\n\n```\n    {\n  \"api_key\": \"xxxxxxxxxxxxxxxx_xxxxx_xxxxxxxxxxxxxxxxxxx\",\n  \"apikey\": \"xxxxxxxxxxxxxxxx_xxxxx_xxxxxxxxxxxxxxxxxxx\",\n   …\n  \"kafka_brokers_sasl\": [\n    \"broker-1-0server:9093\",\n    \"broker-2-0server:9093\",\n    \"broker-5-0server:9093\",\n    \"broker-4-0server:9093\",\n    \"broker-3-0server:9093\",\n    \"broker-0-0server:9093\"\n  ],\n   …\n}\n```\n\nIf you are using the IBM EventStreams on IBM Cloud, the service credential can be generated automatically when you run:\n\n```\n    ibmcloud ks cluster-service-bind --cluster <cluster_name_or_ID> --namespace <namespace> --service <event_streams_service_instance_name> …\n```\n\nto bind your event streams service instance to your Kubernetes cluster.\n\nAnd then in the YAML file for your Kubernetes deployment, specify the environment variable EVENT_STREAMS_AUDIT_BINDING that references the binding key of the generated secret(binding-<event_streams_service_instance_name>) as following:\n\n```\n            - name: EVENT_STREAMS_AUDIT_BINDING\n                valueFrom:\n                  secretKeyRef:\n                    key: binding\n                    name: binding-<event_streams_service_instance_name>\n```\n\nPlease refer to https://cloud.ibm.com/docs/containers?topic=containers-service-binding for detailed instructions if needed.\n\n#### 4.11.3.2 fhir-server-config.json Configuration of audit logging service\n\n```\n\"audit\": {\n    \"serviceClassName\" : \"com.ibm.fhir.audit.impl.KafkaService\",\n    \"serviceProperties\" : {\n        \"load\": \"config\",\n        \"mapper\": \"cadf\",\n        \"auditTopic\": \"FHIR_AUDIT\",\n        \"geoCity\": \"Dallas\",\n        \"geoState\": \"TX\",\n        \"geoCounty\": \"US\",\n        \"kafka\" : {\n            \"sasl.jaas.config\": \"********\",\n            \"bootstrap.servers\": \"********\",\n            \"sasl.mechanism\": \"PLAIN\",\n            \"security.protocol\": \"SASL_SSL\",\n            \"ssl.protocol\": \"TLSv1.2\",\n            \"ssl.enabled.protocols\": \"TLSv1.2\",\n            \"ssl.endpoint.identification.algorithm\": \"HTTPS\"\n        },\n        \"kafkaServers\": \"********\",\n        \"kafkaApiKey\": \"********\"\n    }\n```\n\nThe service can map to the CADF format or the FHIR AuditEvent resource format by declaring a mapper type - 'cadf' or 'auditevent'.\n\n- *CADF* Example\n```\n{\n    \"action\": \"create\",\n    \"eventTime\": \"2020-12-10 16:49:22.307\",\n    \"eventType\": \"activity\",\n    \"id\": \"c62ee8f8-be77-49d0-aad0-c0bf52a05fdf\",\n    \"outcome\": \"success\",\n    \"typeURI\": \"http://schemas.dmtf.org/cloud/audit/1.0/event\",\n    \"tags\": [\n    ],\n    \"target\": {\n        \"id\": \"176629076d7-ef3e8608-cd07-4c20-8823-ddfe46237052\",\n        \"typeURI\": \"data/database\",\n        \"addresses\": [\n            {\n                \"url\": \"https://test.io:443/fhir-server/api/v4/Patient\",\n                \"name\": \"\",\n                \"port\": \"\"\n            }\n        ],\n        \"geolocation\": {\n            \"city\": \"Hamil\",\n            \"state\": \"TEXAS\",\n            \"region\": \"USA\",\n            \"annotations\": [\n            ]\n        },\n        \"addresses\": [\n            {\n                \"url\": \"https://test.io:443/fhir-server/api/v4/Patient\",\n                \"name\": \"\",\n                \"port\": \"\"\n            }\n        ]\n    },\n    \"attachments\": [\n        {\n            \"contentType\": \"application/json\",\n            \"content\": \"rO0ABXQCUQp7CiAgICAicmVxdWVzdF91bmlxdWVfaWQiOiAiYzYyZWU4ZjgtYmU3Ny00OWQwLWFhZDAtYzBiZjUyYTA1ZmRmIiwKICAgICJhY3Rpb24iOiAiQyIsCiAgICAic3RhcnRfdGltZSI6ICIyMDIwLTEyLTEwIDE2OjQ5OjIyLjE2OCIsCiAgICAiZW5kX3RpbWUiOiAiMjAyMC0xMi0xMCAxNjo0OToyMi4zMDciLAogICAgImFwaV9wYXJhbWV0ZXJzIjogewogICAgICAgICJyZXF1ZXN0IjogImh0dHBzOi8vbG9jYWxob3N0Ojk0NDMvZmhpci1zZXJ2ZXIvYXBpL3Y0L1ZlcmlmaWNhdGlvblJlc3VsdCIsCiAgICAgICAgInJlcXVlc3Rfc3RhdHVzIjogMjAxCiAgICB9LAogICAgImRhdGEiOiB7CiAgICAgICAgInJlc291cmNlX3R5cGUiOiAiVmVyaWZpY2F0aW9uUmVzdWx0IiwKICAgICAgICAiaWQiOiAiMTc2NGQ4ZWEzMGEtYzUxOGMxOWItMWM0Zi00Yjc0LThhMDMtNGM5NjA0YmZkYjZlIiwKICAgICAgICAidmVyc2lvbl9pZCI6ICIxIgogICAgfSwKICAgICJldmVudF90eXBlIjogImZoaXItY3JlYXRlIiwKICAgICJkZXNjcmlwdGlvbiI6ICJGSElSIENyZWF0ZSByZXF1ZXN0IiwKICAgICJsb2NhdGlvbiI6ICIxMjcuMC4wLjEvbG9jYWxob3N0Igp9\"\n        }\n    ],\n    \"initiator\": {\n        \"id\": \"default@fhir-server\",\n        \"typeURI\": \"compute/machine\",\n        \"host\": \"192.168.86.20\",\n        \"credential\": {\n            \"token\": \"user-fhiruser\"\n        },\n        \"geolocation\": {\n            \"city\": \"Dallas\",\n            \"state\": \"TX\",\n            \"region\": \"US\",\n            \"annotations\": [\n            ]\n        }\n    },\n    \"observer\": {\n        \"id\": \"fhir-server\",\n        \"typeURI\": \"compute/node\",\n        \"name\": \"IBM FHIR Server - Audit\",\n        \"geolocation\": {\n            \"city\": \"Dallas\",\n            \"state\": \"TX\",\n            \"region\": \"US\",\n            \"annotations\": [\n            ]\n        }\n    }\n}\n```\n\n- *AuditEvent* Example\n\n```\n{\n    \"resourceType\": \"AuditEvent\",\n    \"type\": {\n        \"system\": \"http://terminology.hl7.org/CodeSystem/audit-event-type\",\n        \"code\": \"rest\",\n        \"display\": \"Restful Operation\"\n    },\n    \"subtype\": [\n        {\n            \"system\": \"http://hl7.org/fhir/restful-interaction\",\n            \"code\": \"search\",\n            \"display\": \"search\"\n        }\n    ],\n    \"action\": \"E\",\n    \"period\": {\n        \"start\": \"2020-12-10T16:38:14.466Z\",\n        \"end\": \"2020-12-10T16:38:14.631Z\"\n    },\n    \"recorded\": \"2020-12-10T11:38:14.632173-05:00\",\n    \"outcome\": \"0\",\n    \"outcomeDesc\": \"success\",\n    \"purposeOfEvent\": [\n        {\n            \"coding\": [\n                {\n                    \"system\": \"http://terminology.hl7.org/CodeSystem/v3-ActReason\",\n                    \"code\": \"PurposeOfUse\",\n                    \"display\": \"PurposeOfUse\"\n                }\n            ]\n        }\n    ],\n    \"agent\": [\n        {\n            \"role\": [\n                {\n                    \"coding\": [\n                        {\n                            \"system\": \"http://terminology.hl7.org/CodeSystem/extra-security-role-type\",\n                            \"code\": \"datacollector\",\n                            \"display\": \"datacollector\"\n                        }\n                    ]\n                }\n            ],\n            \"name\": \"fhir-server\",\n            \"requestor\": true,\n            \"network\": {\n                \"address\": \"internal-ip\",\n                \"type\": \"1\"\n            }\n        }\n    ],\n    \"source\": {\n        \"site\": \"127.0.0.1/localhost\",\n        \"observer\": {\n            \"reference\": \"fhir-server\"\n        },\n        \"type\": [\n            {\n                \"system\": \"http://terminology.hl7.org/CodeSystem/security-source-type\",\n                \"code\": \"4\",\n                \"display\": \"Application Server\"\n            }\n        ]\n    },\n    \"entity\": [\n        {\n            \"securityLabel\": [\n                {\n                    \"system\": \"http://terminology.hl7.org/CodeSystem/v3-Confidentiality\",\n                    \"code\": \"N\",\n                    \"display\": \"normal\"\n                }\n            ],\n            \"description\": \"FHIR Search request\",\n            \"query\": \"MTI3LjAuMC4xL2xvY2FsaG9zdC97X3RhZz1baHR0cDovL2libS5jb20vZmhpci90YWd8dGFnMixodHRwOi8vaWJtLmNvbS9maGlyL3RhZ3x0YWddLCBfY291bnQ9WzEwMDBdLCBfcGFnZT1bMV19\",\n            \"detail\": [\n                {\n                    \"type\": \"FHIR Context\",\n                    \"valueBase64Binary\": \"CnsKICAgICJyZXF1ZXN0X3VuaXF1ZV9pZCI6ICIzMmJmMDNhNS1kNmQ1LTQ2MTEtYmFjYS0wNjdkMzcwMDYyMzUiLAogICAgImFjdGlvbiI6ICJSIiwKICAgICJzdGFydF90aW1lIjogIjIwMjAtMTItMTAgMTY6Mzg6MTQuNDY2IiwKICAgICJlbmRfdGltZSI6ICIyMDIwLTEyLTEwIDE2OjM4OjE0LjYzMSIsCiAgICAiYXBpX3BhcmFtZXRlcnMiOiB7CiAgICAgICAgInJlcXVlc3QiOiAiaHR0cHM6Ly9sb2NhbGhvc3Q6OTQ0My9maGlyLXNlcnZlci9hcGkvdjQvX3NlYXJjaD9fdGFnPWh0dHAlM0ElMkYlMkZpYm0uY29tJTJGZmhpciUyRnRhZyU3Q3RhZzIlMkNodHRwJTNBJTJGJTJGaWJtLmNvbSUyRmZoaXIlMkZ0YWclN0N0YWcmX2NvdW50PTEwMDAmX3BhZ2U9MSIsCiAgICAgICAgInJlcXVlc3Rfc3RhdHVzIjogMjAwCiAgICB9LAogICAgInF1ZXJ5IjogIntfdGFnPVtodHRwOi8vaWJtLmNvbS9maGlyL3RhZ3x0YWcyLGh0dHA6Ly9pYm0uY29tL2ZoaXIvdGFnfHRhZ10sIF9jb3VudD1bMTAwMF0sIF9wYWdlPVsxXX0iLAogICAgImJhdGNoIjogewogICAgICAgICJyZXNvdXJjZXNfcmVhZCI6IDIKICAgIH0sCiAgICAiZXZlbnRfdHlwZSI6ICJmaGlyLXNlYXJjaCIsCiAgICAiZGVzY3JpcHRpb24iOiAiRkhJUiBTZWFyY2ggcmVxdWVzdCIsCiAgICAibG9jYXRpb24iOiAiMTI3LjAuMC4xL2xvY2FsaG9zdCIKfQ==\"\n                }\n            ]\n        }\n    ]\n}\n```\n\n### 4.11.4 Query CADF events in COS\n\n[Watson Studio stream flow](https://cloud.ibm.com/docs/tutorials?topic=solution-tutorials-big-data-log-analytics#create-a-streams-flow-source) can be created to push those FHIR Audit CADF events from the Event Streams service to a COS bucket (e.g. fhir-audit-dev) in CSV format. Another option is to configure Event Streams (Kafka) S3 connect to push those CADF events to a COS bucket (e.g. fhir-audit-dev) but in raw CADF json format.\n\nA service instance of the [IBM Cloud SQL Query](https://www.ibm.com/cloud/blog/analyzing-data-with-ibm-cloud-sql-query) service can be created to allow you to query those CADF audit events in COS with SQL queries. Before running an SQL query, it's recommended to first create a COS bucket to store your query results, otherwise the query results will be stored in a bucket which is automatically created by the SQL query service.\n\nSample queries for CSV records expanded from the JSON CADF events:\n\n```\nselect * from cos://us-south/fhir-audit-dev where EVENTTIME BETWEEN \"2019-06-07\" and \"2019-06-08\" and action=\"unknown\" into cos://us-south/fhir-audit-dev-res stored as csv\n\nselect action, count(*) from cos://us-south/fhir-audit-dev where EVENTTIME BETWEEN \"2019-06-05\" and \"2019-06-06\" group by action into cos://us-south/fhir-audit-dev-res stored as csv\n\nselect * from cos://us-south/fhir-audit-dev where EVENTTIME BETWEEN \"2019-06-05\" and \"2019-06-06\" and action=\"create\" and initiator_id=\"default@fhir-server\" into cos://us-south/fhir-audit-dev-res stored as csv\n\nselect * from cos://us-south/fhir-audit-dev where EVENTTIME BETWEEN \"2019-06-05\" and \"2019-06-06\" and ATTACHMENTS_CONTENT LIKE '%fhir-read%' into cos://us-south/fhir-audit-dev-res stored as csv\n```\n\nSample queries for the raw JSON CADF events:\n\n```\nselect * from cos://us-south/fhir-audit-dev0 stored as json where EVENTTIME BETWEEN \"2019-06-01\" and \"2019-06-08\" and action=\"unknown\" into cos://us-south/fhir-audit-dev0-res stored as json\n\nselect action, count(*) from cos://us-south/fhir-audit-dev0 stored as json where EVENTTIME BETWEEN \"2019-06-01\" and \"2019-06-06\" group by action into cos://us-south/fhir-audit-dev0-res stored as csv\n\nselect * from cos://us-south/fhir-audit-dev0 stored as json where EVENTTIME BETWEEN \"2019-06-01\" and \"2019-06-06\" and action=\"create\" and initiator.id=\"default@fhir-server\" into cos://us-south/fhir-audit-dev-res stored as json\n\nselect * from cos://us-south/fhir-audit-dev0 stored as json where EVENTTIME BETWEEN \"2019-06-01\" and \"2019-06-06\" and ATTACHMENTS[0].CONTENT LIKE '%fhir-read%' into cos://us-south/fhir-audit-dev-res stored as json\n\n```\n\n## 4.12 FHIR REST API\nBy default, the IBM FHIR Server allows the following RESTful interactions associated with the FHIR REST API: `create`, `read`, `vread`, `history`, `search`, `update`, `patch`, `delete`. However, it is possible to configure which of these interactions are allowed on a per resource basis through a set of interaction rules specified via the `fhirServer/resources/<resourceType>/interactions` property in `fhir-server-config.json`. The following snippet shows the general form for specifying interaction rules:\n\n```\n\"resources\": {\n    \"open\": true,\n    \"Condition\": {\n        \"interactions\": [\"create\", \"read\", \"vread\", \"history\", \"search\", \"update\", \"patch\", \"delete\"]\n    },\n    \"Observation\": {\n        \"interactions\": [\"create\", \"read\", \"vread\", \"history\", \"delete\"]\n    },\n    \"Patient\": {\n        \"interactions\": [\"read\", \"vread\", \"history\", \"search\"]\n    },\n    \"Procedure\": {\n        \"interactions\": [\"create\", \"read\", \"vread\", \"history\", \"delete\"]\n    }\n}\n```\n\nThe `fhirServer/resources/<resourceType>/interactions` property is a JSON array of strings that represent the RESTful interactions allowed for the given resource type. If an interaction is not in the list of strings specified for a resource type, that interaction will not be allowed for that resource type. In the example above, the following interactions are allowed for the `Observation` resource type: [`create`, `read`, `vread`, `history`, `delete`]. This means a user will not be able to search for `Observation` resources because the `search` interaction is not specified in the list of allowed interactions.\n\nOmitting the `fhirServer/resources/<resourceType>/interactions` property is equivalent to allowing all interactions for a given resource type. An empty array, `[]`, can be used to indicate that no interactions are allowed. Additionally, to define the set of interactions allowed for resource types which are not specifically configured in the `fhirServer/resources` property group, or for resource types which are configured, but which do not specify the `fhirServer/resources/<resourceType>/interactions` property, the base type of `Resource` may be specified:\n\n```\n\"resources\": {\n    \"open\": true,\n    \"Condition\": {\n        \"interactions\": [\"create\", \"read\", \"vread\", \"history\", \"search\", \"update\", \"delete\"]\n    },\n    \"Observation\": {\n        \"interactions\": [\"create\", \"read\", \"vread\", \"history\", \"delete\"]\n    },\n    \"Patient\": {\n        \"interactions\": [\"read\", \"vread\", \"history\", \"search\"]\n    },\n    \"Procedure\": {\n    },\n    \"Resource\": {\n        \"interactions\": [\"create\", \"read\", \"vread\", \"history\", \"search\", \"update\", \"patch\", \"delete\"]\n    }\n}\n```\n\nIn the example above, for any resource type which is not specifically configured, such as `Encounter`, or for any resource type which is configured but does not specify the `fhirServer/resources/<resourceType>/interactions` property, such as `Procedure`, all of the interactions listed for the `Resource` resource type will be allowed.\n\nOne final consideration when configuring interactions is the `fhirServer/resources/open` property. If this property is specified and its value is set to `false`, then no interactions will be allowed for resource types which are not specifically listed in the `fhirServer/resources` property group. Assume the following configuration:\n\n```\n\"resources\": {\n    \"open\": false,\n    \"Condition\": {\n        \"interactions\": [\"create\", \"read\", \"vread\", \"history\", \"search\", \"update\", \"delete\"]\n    },\n    \"Observation\": {\n        \"interactions\": [\"create\", \"read\", \"vread\", \"history\", \"delete\"]\n    },\n    \"Patient\": {\n        \"interactions\": [\"read\", \"vread\", \"history\", \"search\"]\n    }\n}\n```\n\nIn this case, since the `fhirServer/resources/open` property is set to `false`, only the resource types listed (`Condition`, `Observation`, `Patient`) are allowed to be interacted with via the FHIR REST API. For example, a `create` request of a `Procedure` resource will fail since that resource type is not specified.\n\nWhole-system search and whole-system history are special cases. Since no resource type is specified on a whole-system request, validation will be done against the `Resource` resource type. In the above configuration example, a whole-system search request such as `GET [base]?_lastUpdated=gt2020-01-01` will fail because the `Resource` resource type is not specified. If the configuration were to have the `fhirServer/resources/open` property set to `true`, or if the `Resource` resource type were specified in the `fhirServer/resources` property group, then the whole-system search request would be allowed, assuming the `search` interaction was valid for the `Resource` resource type.\n\nIn addition to interaction configuration, the `fhirServer/resources` property group also provides the ability to configure search parameter filtering and profile validation. See [Search configuration](https://ibm.github.io/FHIR/guides/FHIRSearchConfiguration#12-filtering) and [Resource validation](#44-resource-validation) respectively for details.\n\n## 4.12.1 Using the IBM FHIR Server behind a proxy\nIt is possible to run the IBM FHIR Server behind a reverse proxy such as Kubernetes Ingress or an API Gateway.\n\nBecause the FHIR API relies on links and references between resources (both absolute and relative), operators must ensure that the IBM FHIR Server is configured appropriately for the front-end URL being used by the FHIR clients.\n\nThis can be accomplished by configuring the `fhirServer/core/originalRequestUriHeaderName` property in the default fhir-server-config.json. When this parameter is configured, the IBM FHIR Server will use the value of the corresponding header to set the \"originalRequestUri\" for the scope of the request.\n\nFor example, consider a FHIR Server that is listening at https://fhir:9443/fhir-server/api/v4 and is configured with an  originalRequestUriHeaderName of `X-FHIR-FORWARDED-URL`. If this server is proxied by a server at https://example.com/fhir, then the proxy must set the `X-FHIR-FORWARDED-URL` header to the value of the front-end request URL (e.g. https://example.com/fhir/Patient/abc-123).\n\nThe originalRequestUriHeader is expected to contain the full path of the original request. Values with no scheme (e.g. `https://`) will be handled like relative URLs, but full URL values (including scheme, hostname, optional port, and path) are recommended. Query string values can be included in the header value but will be ignored by the server; the server will use the query string of the actual request to process the request.\n\n# 5 Appendix\n\n## 5.1 Configuration properties reference\nThis section contains reference information about each of the configuration properties supported by the FHIR server.\n\n### 5.1.1 Property descriptions\n| Property Name                 | Type | Description     |\n|-------------------------------|------|-----------------|\n|`fhirServer/core/defaultPrettyPrint`|boolean|A boolean flag which indicates whether \"Pretty Printing\" should be used by default. Applies to both XML and JSON.|\n|`fhirServer/core/tenantIdHeaderName`|string|The name of the request header that will be used to specify the tenant-id for each incoming FHIR REST API request. For headers with semicolon-delimited parts, setting a header name like `<headerName>:<partName>` will select the value from the part of header `<headerName>`'s value with a name of `<partName>` (e.g. setting `X-Test:part1` would select `someValue` from the header `X-Test: part1=someValue;part2=someOtherValue`).|\n|`fhirServer/core/dataSourceIdHeaderName`|string|The name of the request header that will be used to specify the datastore-id for each incoming FHIR REST API request. For headers with semicolon-delimited parts, setting a header name like `<headerName>:<partName>` will select the value from the part of header `<headerName>`'s value with a name of `<partName>` (e.g. setting `X-Test:part1` would select `someValue` from the header `X-Test: part1=someValue;part2=someOtherValue`).|\n|`fhirServer/core/originalRequestUriHeaderName`|string|The name of the request header that will be used to indicate the original, end-user-facing, request URI for a given request. This optional config parameter is provided for cases where the server is deployed behind a reverse proxy that overwrites the host and/or path portions of the original request.|\n|`fhirServer/core/defaultHandling`|string|The default handling preference of the server (*strict* or *lenient*) which determines how the server handles unrecognized search parameters and resource elements.|\n|`fhirServer/core/allowClientHandlingPref`|boolean|Indicates whether the client is allowed to override the server default handling preference using the `Prefer:handling` header value part.|\n|`fhirServer/core/checkReferenceTypes`|boolean|Indicates whether reference type checking is performed by the server during parsing / deserialization.|\n|`fhirServer/core/serverRegistryResourceProviderEnabled`|boolean|Indicates whether the server registry resource provider should be used by the FHIR registry component to access definitional resources through the persistence layer.|\n|`fhirServer/core/conditionalDeleteMaxNumber`|integer|The max number of matches supported in conditional delete. |\n|`fhirServer/core/capabilityStatementCacheTimeout`|integer|The number of minutes that a tenant's CapabilityStatement is cached for the metadata endpoint. |\n|`fhirServer/core/extendedCodeableConceptValidation`|boolean|A boolean flag which indicates whether extended validation is performed by the server during object construction for code, Coding, CodeableConcept, Quantity, Uri, and String elements which have required bindings to value sets.|\n|`fhirServer/core/disabledOperations`|string|A comma-separated list of operations which are not allowed to run on the IBM FHIR Server, for example, `validate,import`. Note, do not include the dollar sign `$`|\n|`fhirServer/term/graphTermServiceProvider/enabled`|boolean|Indicates whether the graph term service provider should be used by the FHIR term service to access code system content|\n|`fhirServer/term/graphTermServiceProvider/timeLimit`|integer|Graph traversal time limit (in milliseconds)|\n|`fhirServer/term/graphTermServiceProvider/configuration`|object (name/value pairs)|A JSON object that contains the name/value pairs used to configure the graph database behind the graph term service provider see: [https://docs.janusgraph.org/basics/configuration-reference/](https://docs.janusgraph.org/basics/configuration-reference/)|\n|`fhirServer/resources/open`|boolean|Whether resources that are not explicitly listed in the configuration should be supported by the FHIR Server REST layer. When open is set to `false`, only the resources listed in fhir-server-config.json are supported.|\n|`fhirServer/resources/Resource/interactions`|string list|A list of strings that represent the RESTful interactions (create, read, vread, update, patch, delete, history, and/or search) supported for resource types. Omitting this property is equivalent to supporting all FHIR interactions for the supported resources. An empty list, `[]`, can be used to indicate that no REST methods are supported. This property can be overridden for specific resource types via the `fhirServer/resources/<resourceType>/interactions` property.|\n|`fhirServer/resources/Resource/searchParameters`|object|The set of search parameters to support for all supported resource types. Omitting this property is equivalent to supporting all search parameters in the server's registry that apply to resource type \"Resource\" (all resources). An empty object, `{}`, can be used to indicate that no global search parameters are supported.|\n|`fhirServer/resources/Resource/searchParameters/<code>`|string|The URL of the search parameter definition to use for the search parameter `<code>`. Individual resource types may override this value via `fhirServer/resources/<resourceType>/searchParameters/<code>`|\n|`fhirServer/resources/Resource/searchIncludes`|string list|A comma-separated list of \\_include values supported for all resource types. Individual resource types may override this value via `fhirServer/resources/<resourceType>/searchIncludes`. Omitting this property is equivalent to supporting all \\_include values for the supported resources. An empty list, `[]`, can be used to indicate that no \\_include values are supported.|\n|`fhirServer/resources/Resource/searchRevIncludes`|string list|A comma-separated list of \\_revinclude values supported for all resource types. Individual resource types may override this value via `fhirServer/resources/<resourceType>/searchRevIncludes`. Omitting this property is equivalent to supporting all \\_revinclude values for the supported resources. An empty list, `[]`, can be used to indicate that no \\_revinclude values are supported.|\n|`fhirServer/resources/Resource/searchParameterCombinations`|string list|A comma-separated list of search parameter combinations supported for all resource types. Each search parameter combination is a string, where a plus sign, `+`, separates the search parameters that can be used in combination. To indicate that searching without any search parameters is allowed, an empty string must be included in the list. Including an asterisk, `*`, in the list indicates support of any search parameter combination. Individual resource types may override this value via `fhirServer/resources/<resourceType>/searchParameterCombinations`. Omitting this property is equivalent to supporting any search parameter combination.|\n|`fhirServer/resources/Resource/profiles/atLeastOne`|string list|A comma-separated list of profiles, at least one of which must be specified in a resource's `meta.profile` element and successfully validated against in order for a resource to be persisted to the FHIR server. Individual resource types may override this value via `fhirServer/resources/<resourceType>/profiles/atLeastOne`. Omitting this property or specifying an empty list is equivalent to not requiring any profile assertions for a resource.|\n|`fhirServer/resources/<resourceType>/interactions`|string list|A list of strings that represent the RESTful interactions (create, read, vread, update, patch, delete, history, and/or search) to support for this resource type. For resources without the property, the value of `fhirServer/resources/Resource/interactions` is used.|\n|`fhirServer/resources/<resourceType>/searchParameters`|object|The set of search parameters to support for this resource type. Global search parameters defined on the `Resource` resource can be overridden on a per-resourceType basis.|\n|`fhirServer/resources/<resourceType>/searchParameters/<code>`|string|The URL of the search parameter definition to use for the search parameter `<code>` on resources of type `<resourceType>`.|\n|`fhirServer/resources/<resourceType>/searchIncludes`|string list|A comma-separated list of \\_include values supported for this resource type. An empty list, `[]`, can be used to indicate that no \\_include values are supported. For resources without the property, the value of `fhirServer/resources/Resource/searchIncludes` is used.|\n|`fhirServer/resources/<resourceType>/searchRevIncludes`|string list|A comma-separated list of \\_revinclude values supported for this resource type. An empty list, `[]`, can be used to indicate that no \\_revinclude values are supported. For resources without the property, the value of `fhirServer/resources/Resource/searchRevIncludes` is used.|\n|`fhirServer/resources/<resourceType>/searchParameterCombinations`|string list|A comma-separated list of search parameter combinations supported for this resource type. Each search parameter combination is a string, where a plus sign, `+`, separates the search parameters that can be used in combination. To indicate that searching without any search parameters is allowed, an empty string must be included in the list. Including an asterisk, `*`, in the list indicates support of any search parameter combination. For resources without the property, the value of `fhirServer/resources/Resource/searchParameterCombinations` is used.|\n|`fhirServer/resources/<resourceType>/profiles/atLeastOne`|string list|A comma-separated list of profiles, at least one of which must be specified in a resource's `meta.profile` element and be successfully validated against in order for a resource of this type to be persisted to the FHIR server. If this property is not specified, or if an empty list is specified, the value of `fhirServer/resources/Resource/profiles/atLeastOne` will be used.|\n|`fhirServer/notifications/common/includeResourceTypes`|string list|A comma-separated list of resource types for which notification event messages should be published.|\n|`fhirServer/notifications/websocket/enabled`|boolean|A boolean flag which indicates whether or not websocket notifications are enabled.|\n|`fhirServer/notifications/kafka/enabled`|boolean|A boolean flag which indicates whether or not kafka notifications are enabled.|\n|`fhirServer/notifications/kafka/topicName`|string|The name of the topic to which kafka notification event messages should be published.|\n|`fhirServer/notifications/kafka/connectionProperties`|property list|A group of connection properties used to configure the KafkaProducer. These properties are used as-is when instantiating the KafkaProducer used by the FHIR server for publishing notification event messages.|\n|`fhirServer/notifications/nats/enabled`|boolean|A boolean flag which indicates whether or not NATS notifications are enabled.|\n|`fhirServer/notifications/nats/cluster`|string|The name of the NATS streaming cluster to which to connect.|\n|`fhirServer/notifications/nats/channel`|string|The name of the NATS channel on which NATS notification event messages are to be published.|\n|`fhirServer/notifications/nats/clientId`|string|The name to use for the connections to the NATS streaming cluster.|\n|`fhirServer/notifications/nats/servers`|string|The URL of one or more NATS servers in the NATS streaming cluster.|\n|`fhirServer/notifications/nats/useTLS`|boolean|A boolean flag which indicates whether or not to use TLS for connections to the NATS streaming cluster.|\n|`fhirServer/notifications/nats/truststoreLocation`|string|The file location of the truststore to use for TLS.|\n|`fhirServer/notifications/nats/truststorePassword`|string|The password for the truststore.|\n|`fhirServer/notifications/nats/keystoreLocation`|string|The file location of the keystore to use for TLS.|\n|`fhirServer/notifications/nats/keystorePassword`|string|The password for the keystore.|\n|`fhirServer/persistence/factoryClassname`|string|The name of the factory class to use for creating instances of the persistence layer implementation.|\n|`fhirServer/persistence/common/updateCreateEnabled`|boolean|A boolean flag which indicates whether or not the 'update/create' feature should be enabled in the selected persistence layer.|\n|`fhirServer/persistence/datasources`|map|A map containing datasource definitions. See [Section 3.3.1 The JDBC persistence layer](#331-the-jdbc-persistence-layer) for more information.|\n|`fhirServer/persistence/datasources/<datasourceId>/type`|string|`derby` or `db2` or `postgresql`|\n|`fhirServer/persistence/datasources/<datasourceId>/searchOptimizerOptions/from_collapse_limit`|int| For PostgreSQL, sets the from_collapse_limit query optimizer parameter to improve search performance. If not set, the IBM FHIR Server uses a value of 12. To use the database default (8), explicitly set this value to null. |\n|`fhirServer/persistence/datasources/<datasourceId>/searchOptimizerOptions/join_collapse_limit`|int| For PostgreSQL, sets the join_collapse_limit query optimizer parameter to improve search performance. If not set, the IBM FHIR Server uses a value of 12. To use the database default (8), explicitly set this value to null. |\n|`fhirServer/security/cors`|boolean|Used to convey to clients whether cors is supported or not; actual cors support is configured separately in the Liberty server.xml configuration|\n|`fhirServer/security/basic/enabled`|boolean|Whether or not the server is enabled for HTTP Basic authentication|\n|`fhirServer/security/certificates/enabled`|boolean|Whether or not the server is enabled for Certificate-based client authentication|\n|`fhirServer/security/oauth/enabled`|boolean|Whether or not the server is enabled for OAuth-based authentication/authorization|\n|`fhirServer/security/oauth/regUrl`|string|The registration URL associated with the OAuth 2.0 authentication/authorization support.|\n|`fhirServer/security/oauth/authUrl`|string|The authorization URL associated with the OAuth 2.0 authentication/authorization support.|\n|`fhirServer/security/oauth/tokenUrl`|string|The token URL associated with the OAuth 2.0 authentication/authorization support.|\n|`fhirServer/security/oauth/manageUrl`|string|The URL where an end-user can view which applications currently have access to data and can make adjustments to these access rights.|\n|`fhirServer/security/oauth/introspectUrl`|string|The URL of the server’s introspection endpoint that can be used to validate a token.|\n|`fhirServer/security/oauth/revokeUrl`|string|The URL to the server’s endpoint that can be used to revoke a token.|\n|`fhirServer/security/oauth/smart/enabled`|boolean|Whether or not the server is enabled for OAuth-based authentication/authorization|\n|`fhirServer/security/oauth/smart/scopes`|array|The list of SMART scopes to advertise in the `.well-known/smart-configuration endpoint|\n|`fhirServer/security/oauth/smart/capabilities`|array|The list of SMART capabilities to advertise in the `.well-known/smart-configuration endpoint|\n|`fhirServer/audit/serviceClassName`|string|The audit service to use. Currently, com.ibm.fhir.audit.impl.NopService to indicate the logger service is disabled, and com.ibm.fhir.audit.impl.KafkaService to indicate using Kafka as a destination.|\n|`fhirServer/audit/serviceProperties/auditTopic`|string|The kafka topic to use for CADF audit logging service|\n|`fhirServer/audit/serviceProperties/geoCity`|string|The Geo City configured for audit logging service.|\n|`fhirServer/audit/serviceProperties/geoState`|string|The Geo State configured for audit logging service.|\n|`fhirServer/audit/serviceProperties/geoCounty`|string|The Geo Country configured for audit logging service.|\n|`fhirServer/audit/serviceProperties/kafkaServers`|string|The CSV list of Kafka brokers.|\n|`fhirServer/audit/serviceProperties/kafkaApiKey`|string|The apikey for the JAAS configuration.|\n|`fhirServer/audit/serviceProperties/mapper`|string|The AuditEventLog mapper that determines the output format - valid types are 'cadf' and 'auditevent'. 'auditevent' refers to the FHIR Resource AuditEvent, and 'cadf' refers to the Cloud logging standard.|\n|`fhirServer/audit/serviceProperties/load`|string|The location that the configuration is loaded from 'environment' or 'config'.|\n|`fhirServer/audit/serviceProperties/kafka`|object|A set of name value pairs used as part of the 'config' for publishing to the kafka service. These should only be Kafka properties.|\n|`fhirServer/audit/hostname`|string|A string used to identify the Hostname, useful in containerized environments|\n|`fhirServer/audit/ip`|string|A string used to identify the IP address, useful to identify only one IP|\n|`fhirServer/search/useBoundingRadius`|boolean|True, the bounding area is a Radius, else the bounding area is a box.|\n|`fhirServer/search/useStoredCompartmentParam`|boolean|False, Compute and store parameter to accelerate compartment searches. Requires reindex using at least IBM FHIR Server version 4.5.1 before this feature is enabled |\n|`fhirServer/bulkdata/enabled`| string|Enabling the BulkData operations |\n|`fhirServer/bulkdata/core/api/url`|string|The URL to access the FHIR server hosting the batch web application |\n|`fhirServer/bulkdata/core/api/user`|string|User for submitting JavaBatch job |\n|`fhirServer/bulkdata/core/api/password`|string|Password for above batch user |\n|`fhirServer/bulkdata/core/api/truststore`|string|Trust store for JavaBatch job submission |\n|`fhirServer/bulkdata/core/api/truststorePassword`|string|Password for above trust store |\n|`fhirServer/bulkdata/core/api/trustAll`|boolean|Indicates calls to the local API should skip hostname verification|\n|`fhirServer/bulkdata/core/cos/partUploadTriggerSizeMB`|number|The size, in megabytes, at which to write a \"part\" for multi-part uploads. The S3 API requires parts to be between 5 and 5000 MB and does not allow more than 10,000 parts per object. |\n|`fhirServer/bulkdata/core/cos/objectSizeThresholdMB`|number|The size, in megabytes, at which to finish writing a given object. Use `0` to indicate that all resources of a given type should be written to a single object, but be aware that S3 objects can have a maximum of 10,000 parts and a maximum size of 5,000,000 MB (5 TB). |\n|`fhirServer/bulkdata/core/cos/objectResourceCountThreshold`|number|The number of resources at which to finish writing a given object. The actual number of resources written to a single object may be slightly above this number, dependent on the configured page size. Use `0` to indicate that there is no limit to the number of resources to be written to a single object.|\n|`fhirServer/bulkdata/core/cos/requestTimeout`|number|The request timeout in second for the COS client|\n|`fhirServer/bulkdata/core/cos/socketTimeout`|number|The socket timeout in second for the COS client|\n|`fhirServer/bulkdata/core/cos/useServerTruststore`|boolean|If the COS Client should use the IBM FHIR Server's TrustStore to access S3/IBMCOS service |\n|`fhirServer/bulkdata/core/cos/presignedExpiry`|number|The time in seconds of the presigned download URL; must be using HMAC auth|\n|`fhirServer/bulkdata/core/file/writeTriggerSizeMB`|number|The size, in megabytes, at which to write the buffer to file.|\n|`fhirServer/bulkdata/core/file/sizeThresholdMB`|number|The size, in megabytes, at which to finish writing a given file. Use `0` to indicate that all resources of a given type should be written to a single file.|\n|`fhirServer/bulkdata/core/file/resourceCountThreshold`|number|The number of resources at which to finish writing a given file. The actual number of resources written to a single file may be slightly above this number, dependent on the configured page size. Use `0` to indicate that there is no limit to the number of resources to be written to a single file.|\n|`fhirServer/bulkdata/core/batchIdEncryptionKey`|string|Encoding key for JavaBatch job id |\n|`fhirServer/bulkdata/core/pageSize`|number|The search page size for patient/group export and the legacy export, the default value is 1000 |\n|`fhirServer/bulkdata/core/maxPartitions`|number| The maximum number of simultaneous partitions that are processed per Export and Import |\n|`fhirServer/bulkdata/core/maxInputs`|number| The number of inputs allowed for $import |\n|`fhirServer/bulkdata/core/iamEndpoint`|string| Override the system's IAM endpoint |\n|`fhirServer/bulkdata/core/maxChunkReadTime`|string| Max time in milliseconds to read during a bulkdata export without type filters. The time should be three quarters of the transactionManager timeout (often the FHIR_TRANSACTION_MANAGER_TIMEOUT value). Note, this value is a string representation of a long value.|\n|`fhirServer/bulkdata/storageProviders/<source>/type`|string|The type of storageProvider aws-s3, ibm-cos, file, https |\n|`fhirServer/bulkdata/storageProviders/<source>/bucketName`|string| Object store bucket name |\n|`fhirServer/bulkdata/storageProviders/<source>/location`|string|Object store location |\n|`fhirServer/bulkdata/storageProviders/<source>/endpointInternal`|string|Object store end point url used to read/write from COS |\n|`fhirServer/bulkdata/storageProviders/<source>/endpointExternal`|string|Object store end point url used in the constructed download URLs|\n|`fhirServer/bulkdata/storageProviders/<source>/fileBase`|string| The absolute path of the output directory |\n|`fhirServer/bulkdata/storageProviders/<source>/validBaseUrls`|list|The list of supported urls which are approved for the fhir server to access|\n|`fhirServer/bulkdata/storageProviders/<source>/disableBaseUrlValidation`|boolean|Disables the URL checking feature, allowing all URLs to be imported|\n|`fhirServer/bulkdata/storageProviders/<source>/exportPublic`|boolean|Whether or not the server is configured to support export to parquet; to properly enable it the administrator must first make spark and stocator available to the fhir-bulkdata-webapp (e.g through the shared lib at `wlp/user/shared/resources/lib`)|\n|`fhirServer/bulkdata/storageProviders/<source>/enableParquet`|boolean|If give public read only access to the exported files|\n|`fhirServer/bulkdata/storageProviders/<source>/disableOperationOutcomes`|boolean|Disables the base url validation, allowing all URLs to be imported|\n|`fhirServer/bulkdata/storageProviders/<source>/duplicationCheck`|boolean|Enables duplication check on import|\n|`fhirServer/bulkdata/storageProviders/<source>/validateResources`|boolean|Enables the validation of imported resources|\n|`fhirServer/bulkdata/storageProviders/<source>/presigned`|boolean|When an hmac auth type is used, presigns the URLs of an export|\n|`fhirServer/bulkdata/storageProviders/<source>/create`|boolean|Enables the creation of buckets|\n|`fhirServer/bulkdata/storageProviders/<source>/auth/type`|string|A type of hmac, iam, or basic|\n|`fhirServer/bulkdata/storageProviders/<source>/accessKeyId`|string|For HMAC, API key for accessing COS |\n|`fhirServer/bulkdata/storageProviders/<source>/secretAccessKey`|string|For HMAC, secret key for accessing COS |\n|`fhirServer/bulkdata/storageProviders/<source>/iamApiKey`|string|For IAM, API key for accessing IBM COS |\n|`fhirServer/bulkdata/storageProviders/<source>/iamResourceInstanceId`|string|For IAM, secret key for accessing IBM COS |\n|`fhirServer/bulkdata/storageProviders/<source>/user`|string|For basic, user COS |\n|`fhirServer/bulkdata/storageProviders/<source>/secretAccessKey`|string|For basic, password for accessing COS |\n\n\n### 5.1.2 Default property values\n| Property Name                 | Default value   |\n|-------------------------------| ----------------|\n|`fhirServer/core/defaultPrettyPrint`|false|\n|`fhirServer/core/tenantIdHeaderName`|X-FHIR-TENANT-ID|\n|`fhirServer/core/dataSourceIdHeaderName`|X-FHIR-DSID|\n|`fhirServer/core/originalRequestUriHeaderName`|null|\n|`fhirServer/core/defaultHandling`|strict|\n|`fhirServer/core/allowClientHandlingPref`|true|\n|`fhirServer/core/checkReferenceTypes`|true|\n|`fhirServer/core/serverRegistryResourceProviderEnabled`|false|\n|`fhirServer/core/conditionalDeleteMaxNumber`|10|\n|`fhirServer/core/capabilityStatementCacheTimeout`|60|\n|`fhirServer/core/extendedCodeableConceptValidation`|true|\n|`fhirServer/term/graphTermServiceProvider/enabled`|false|\n|`fhirServer/term/graphTermServiceProvider/timeLimit`|90000|\n|`fhirServer/resources/open`|true|\n|`fhirServer/resources/Resource/interactions`|null (all interactions supported)|\n|`fhirServer/resources/Resource/searchParameters`|null (all global search parameters supported)|\n|`fhirServer/resources/Resource/searchIncludes`|null (all \\_include values supported)|\n|`fhirServer/resources/Resource/searchRevIncludes`|null (all \\_revinclude values supported)|\n|`fhirServer/resources/Resource/searchParameterCombinations`|null (all search parameter combinations supported)|\n|`fhirServer/resources/Resource/profiles/atLeastOne`|null (no resource profile assertions required)|\n|`fhirServer/resources/<resourceType>/interactions`|null (inherits from `fhirServer/resources/Resource/interactions`)|\n|`fhirServer/resources/<resourceType>/searchParameters`|null (all type-specific search parameters supported)|\n|`fhirServer/resources/<resourceType>/searchParameters/<code>`|null|\n|`fhirServer/resources/<resourceType>/searchIncludes`|null (inherits from `fhirServer/resources/Resource/searchIncludes`)|\n|`fhirServer/resources/<resourceType>/searchRevIncludes`|null (inherits from `fhirServer/resources/Resource/searchRevIncludes`)|\n|`fhirServer/resources/<resourceType>/searchParameterCombinations`|null (inherits from `fhirServer/resources/Resource/searchParameterCombinations`)|\n|`fhirServer/resources/<resourceType>/profiles/atLeastOne`|null (inherits from `fhirServer/resources/Resource/profiles/atLeastOne`)|\n|`fhirServer/notifications/common/includeResourceTypes`|`[\"*\"]`|\n|`fhirServer/notifications/websocket/enabled`|false|\n|`fhirServer/notifications/kafka/enabled`|false|\n|`fhirServer/notifications/kafka/topicName`|fhirNotifications|\n|`fhirServer/notifications/kafka/connectionProperties`|`{}`|\n|`fhirServer/notifications/nats/enabled`|false|\n|`fhirServer/notifications/nats/cluster`|nats-streaming|\n|`fhirServer/notifications/nats/channel`|fhirNotifications|\n|`fhirServer/notifications/nats/clientId`|fhir-server|\n|`fhirServer/notifications/nats/servers`||\n|`fhirServer/notifications/nats/useTLS`|true|\n|`fhirServer/notifications/nats/truststoreLocation`||\n|`fhirServer/notifications/nats/truststorePassword`||\n|`fhirServer/notifications/nats/keystoreLocation`||\n|`fhirServer/notifications/nats/keystorePassword`||\n|`fhirServer/persistence/factoryClassname`|com.ibm.fhir.persistence.jdbc.FHIRPersistenceJDBCFactory|\n|`fhirServer/persistence/common/updateCreateEnabled`|true|\n|`fhirServer/persistence/datasources`|embedded Derby database: derby/fhirDB|\n|`fhirServer/persistence/datasources/<datasourceId>/type`|derby|\n|`fhirServer/persistence/datasources/<datasourceId>/searchOptimizerOptions/from_collapse_limit`|16|\n|`fhirServer/persistence/datasources/<datasourceId>/searchOptimizerOptions/join_collapse_limit`|16|\n|`fhirServer/security/cors`|boolean|true|\n|`fhirServer/security/basic/enabled`|boolean|false|\n|`fhirServer/security/certificates/enabled`|boolean|false|\n|`fhirServer/security/oauth/enabled`|boolean|false|\n|`fhirServer/security/oauth/regUrl`|\"\"|\n|`fhirServer/security/oauth/authUrl`|\"\"|\n|`fhirServer/security/oauth/tokenUrl`|\"\"|\n|`fhirServer/security/oauth/manageUrl`|\"\"|\n|`fhirServer/security/oauth/introspectUrl`|\"\"|\n|`fhirServer/security/oauth/revokeUrl`|\"\"|\n|`fhirServer/security/oauth/smart/enabled`|boolean|false|\n|`fhirServer/security/oauth/smart/scopes`|array|null|\n|`fhirServer/security/oauth/smart/capabilities`|array|null|\n|`fhirServer/audit/serviceClassName`|\"\"|\n|`fhirServer/audit/serviceProperties/auditTopic`|FHIR_AUDIT|\n|`fhirServer/audit/serviceProperties/geoCity`|UnknownCity|\n|`fhirServer/audit/serviceProperties/geoState`|UnknownState|\n|`fhirServer/audit/serviceProperties/geoCounty`|UnknownCountry|\n|`fhirServer/audit/serviceProperties/mapper`|cadf|\n|`fhirServer/audit/serviceProperties/load`|environment|\n|`fhirServer/bulkdata/isExportPublic`|true|\n|`fhirServer/bulkdata/validBaseUrlsDisabled`|false|\n|`fhirServer/bulkdata/cosFileMaxResources`|200000|\n|`fhirServer/bulkdata/cosFileMaxSize`|209715200|\n|`fhirServer/bulkdata/patientExportPageSize`|200|\n|`fhirServer/bulkdata/useFhirServerTrustStore`|false|\n|`fhirServer/bulkdata/enableParquet`|false|\n|`fhirServer/bulkdata/ignoreImportOutcomes`|false|\n|`fhirServer/bulkdata/enabled`|true |\n|`fhirServer/bulkdata/core/api/trustAll`|false|\n|`fhirServer/bulkdata/core/cos/partUploadTriggerSizeMB`|10 |\n|`fhirServer/bulkdata/core/cos/objectSizeThresholdMB`|200 |\n|`fhirServer/bulkdata/core/cos/objectResourceCountThreshold`|200000|\n|`fhirServer/bulkdata/core/cos/requestTimeout`|120|\n|`fhirServer/bulkdata/core/cos/socketTimeout`|120|\n|`fhirServer/bulkdata/core/cos/useServerTruststore`|false|\n|`fhirServer/bulkdata/core/cos/presignedExpiry`|86400|\n|`fhirServer/bulkdata/core/pageSize`|1000|\n|`fhirServer/bulkdata/core/maxPartitions`|5|\n|`fhirServer/bulkdata/core/maxInputs`|5|\n|`fhirServer/bulkdata/core/iamEndpoint`|https://iam.cloud.ibm.com/oidc/token|\n|`fhirServer/bulkdata/core/maxChunkReadTime`|90000|\n|`fhirServer/bulkdata/storageProviders/<source>/disableBaseUrlValidation`|false|\n|`fhirServer/bulkdata/storageProviders/<source>/exportPublic`|false|\n|`fhirServer/bulkdata/storageProviders/<source>/enableParquet`|false|\n|`fhirServer/bulkdata/storageProviders/<source>/disableOperationOutcomes`|false|\n|`fhirServer/bulkdata/storageProviders/<source>/duplicationCheck`|false|\n|`fhirServer/bulkdata/storageProviders/<source>/validateResources`|false|\n|`fhirServer/bulkdata/storageProviders/<source>/presigned`|false|\n|`fhirServer/bulkdata/storageProviders/<source>/create`|false|\n\n### 5.1.3 Property attributes\nDepending on the context of their use, config properties can be:\n* tenant-specific or global\n* dynamic or static\n\nThe following table tracks which properties can be set on a tenant-specific basis\nand which properties are loaded dynamically.\nIf you change a properties that has an `N` in the `Dynamic?` column, it means you\nmust restart the server for that change to take effect.\n\n| Property Name                 | Tenant-specific? | Dynamic? |\n|-------------------------------|------------------|----------|\n|`fhirServer/core/defaultPrettyPrint`|Y|Y|\n|`fhirServer/core/tenantIdHeaderName`|N|N|\n|`fhirServer/core/dataSourceIdHeaderName`|N|N|\n|`fhirServer/core/originalRequestUriHeaderName`|N|N|\n|`fhirServer/core/defaultHandling`|Y|Y|\n|`fhirServer/core/allowClientHandlingPref`|Y|Y|\n|`fhirServer/core/checkReferenceTypes`|N|N|\n|`fhirServer/core/serverRegistryResourceProviderEnabled`|N|N|\n|`fhirServer/core/conditionalDeleteMaxNumber`|Y|Y|\n|`fhirServer/core/capabilityStatementCacheTimeout`|Y|Y|\n|`fhirServer/core/extendedCodeableConceptValidation`|N|N|\n|`fhirServer/core/disabledOperations`|N|N|\n|`fhirServer/term/graphTermServiceProvider/enabled`|N|N|\n|`fhirServer/term/graphTermServiceProvider/timeLimit`|N|N|\n|`fhirServer/term/graphTermServiceProvider/configuration`|N|N|\n|`fhirServer/resources/open`|Y|Y|\n|`fhirServer/resources/Resource/interactions`|Y|Y|\n|`fhirServer/resources/Resource/searchParameters`|Y|Y|\n|`fhirServer/resources/Resource/searchParameters/<code>`|Y|Y|\n|`fhirServer/resources/Resource/searchIncludes`|Y|Y|\n|`fhirServer/resources/Resource/searchRevIncludes`|Y|Y|\n|`fhirServer/resources/Resource/searchParameterCombinations`|Y|Y|\n|`fhirServer/resources/Resource/profiles/atLeastOne`|Y|Y|\n|`fhirServer/resources/<resourceType>/interactions`|Y|Y|\n|`fhirServer/resources/<resourceType>/searchParameters`|Y|Y|\n|`fhirServer/resources/<resourceType>/searchParameters/<code>`|Y|Y|\n|`fhirServer/resources/<resourceType>/searchIncludes`|Y|Y|\n|`fhirServer/resources/<resourceType>/searchRevIncludes`|Y|Y|\n|`fhirServer/resources/<resourceType>/searchParameterCombinations`|Y|Y|\n|`fhirServer/resources/<resourceType>/profiles/atLeastOne`|Y|Y|\n|`fhirServer/notifications/common/includeResourceTypes`|N|N|\n|`fhirServer/notifications/websocket/enabled`|N|N|\n|`fhirServer/notifications/kafka/enabled`|N|N|\n|`fhirServer/notifications/kafka/topicName`|N|N|\n|`fhirServer/notifications/kafka/connectionProperties`|N|N|\n|`fhirServer/notifications/nats/enabled`|N|N|\n|`fhirServer/notifications/nats/cluster`|N|N|\n|`fhirServer/notifications/nats/channel`|N|N|\n|`fhirServer/notifications/nats/clientId`|N|N|\n|`fhirServer/notifications/nats/servers`|N|N|\n|`fhirServer/notifications/nats/useTLS`|N|N|\n|`fhirServer/notifications/nats/truststoreLocation`|N|N|\n|`fhirServer/notifications/nats/truststorePassword`|N|N|\n|`fhirServer/notifications/nats/keystoreLocation`|N|N|\n|`fhirServer/notifications/nats/keystorePassword`|N|N|\n|`fhirServer/persistence/factoryClassname`|N|N|\n|`fhirServer/persistence/common/updateCreateEnabled`|N|N|\n|`fhirServer/persistence/datasources`|Y|N|\n|`fhirServer/persistence/datasources/<datasourceId>/type`|Y|N|\n|`fhirServer/persistence/datasources/<datasourceId>/searchOptimizerOptions/from_collapse_limit`|Y|Y|\n|`fhirServer/persistence/datasources/<datasourceId>/searchOptimizerOptions/join_collapse_limit`|Y|Y|\n|`fhirServer/security/cors`|Y|Y|\n|`fhirServer/security/basic/enabled`|Y|Y|\n|`fhirServer/security/certificates/enabled`|Y|Y|\n|`fhirServer/security/oauth/enabled`|Y|Y|\n|`fhirServer/security/oauth/regUrl`|Y|Y|\n|`fhirServer/security/oauth/authUrl`|Y|Y|\n|`fhirServer/security/oauth/tokenUrl`|Y|Y|\n|`fhirServer/security/oauth/manageUrl`|Y|Y|\n|`fhirServer/security/oauth/introspectUrl`|Y|Y|\n|`fhirServer/security/oauth/revokeUrl`|Y|Y|\n|`fhirServer/security/oauth/smart/enabled`|Y|Y|\n|`fhirServer/security/oauth/smart/scopes`|Y|Y|\n|`fhirServer/security/oauth/smart/capabilities`|Y|Y|\n|`fhirServer/audit/serviceClassName`|N|N|\n|`fhirServer/audit/serviceProperties/auditTopic`|N|N|\n|`fhirServer/audit/serviceProperties/geoCity`|N|N|\n|`fhirServer/audit/serviceProperties/geoState`|N|N|\n|`fhirServer/audit/serviceProperties/geoCounty`|N|N|\n|`fhirServer/audit/serviceProperties/mapper`|N|N|\n|`fhirServer/audit/serviceProperties/load`|N|N|\n|`fhirServer/audit/hostname`|N|N|\n|`fhirServer/audit/ip`|N|N|\n|`fhirServer/bulkdata/enabled`|Y|Y|\n|`fhirServer/bulkdata/core/api/url`|Y|Y|\n|`fhirServer/bulkdata/core/api/user`|Y|Y|\n|`fhirServer/bulkdata/core/api/password`|Y|Y|\n|`fhirServer/bulkdata/core/api/truststore`|Y|Y|\n|`fhirServer/bulkdata/core/api/truststorePassword`|Y|Y|\n|`fhirServer/bulkdata/core/api/trustAll`|Y|Y|\n|`fhirServer/bulkdata/core/cos/partUploadTriggerSizeMB`|N|N|\n|`fhirServer/bulkdata/core/cos/objectSizeThresholdMB`|N|N|\n|`fhirServer/bulkdata/core/cos/objectResourceCountThreshold`|N|N|\n|`fhirServer/bulkdata/core/cos/requestTimeout`|N|N|\n|`fhirServer/bulkdata/core/cos/socketTimeout`|N|N|\n|`fhirServer/bulkdata/core/cos/useServerTruststore`|Y|Y|\n|`fhirServer/bulkdata/core/cos/presignedExpiry`|Y|Y|\n|`fhirServer/bulkdata/core/batchIdEncryptionKey`|Y|N|\n|`fhirServer/bulkdata/core/pageSize`|Y|Y|\n|`fhirServer/bulkdata/core/maxPartitions`|Y|Y|\n|`fhirServer/bulkdata/core/maxInputs`|Y|Y|\n|`fhirServer/bulkdata/core/iamEndpoint`|N|N|\n|`fhirServer/bulkdata/core/fastTxTimeout`|N|N|\n|`fhirServer/bulkdata/storageProviders/<source>/type`|Y|Y|\n|`fhirServer/bulkdata/storageProviders/<source>/bucketName`|Y|Y|\n|`fhirServer/bulkdata/storageProviders/<source>/location`|Y|Y|\n|`fhirServer/bulkdata/storageProviders/<source>/endpointInternal`|Y|Y|\n|`fhirServer/bulkdata/storageProviders/<source>/endpointExternal`|Y|Y|\n|`fhirServer/bulkdata/storageProviders/<source>/fileBase`|Y|Y|\n|`fhirServer/bulkdata/storageProviders/<source>/validBaseUrls`|Y|Y|\n|`fhirServer/bulkdata/storageProviders/<source>/disableBaseUrlValidation`|Y|Y|\n|`fhirServer/bulkdata/storageProviders/<source>/exportPublic`|Y|Y|\n|`fhirServer/bulkdata/storageProviders/<source>/enableParquet`|Y|Y|\n|`fhirServer/bulkdata/storageProviders/<source>/disableOperationOutcomes`|Y|Y|\n|`fhirServer/bulkdata/storageProviders/<source>/duplicationCheck`|Y|Y|\n|`fhirServer/bulkdata/storageProviders/<source>/validateResources`|Y|Y|\n|`fhirServer/bulkdata/storageProviders/<source>/presigned`|Y|Y|\n|`fhirServer/bulkdata/storageProviders/<source>/create`|Y|Y|\n|`fhirServer/bulkdata/storageProviders/<source>/auth/type`|Y|Y|\n|`fhirServer/bulkdata/storageProviders/<source>/accessKeyId`|Y|Y|\n|`fhirServer/bulkdata/storageProviders/<source>/secretAccessKey`|Y|Y|\n|`fhirServer/bulkdata/storageProviders/<source>/iamApiKey`|Y|Y|\n|`fhirServer/bulkdata/storageProviders/<source>/iamResourceInstanceId`|Y|Y|\n|`fhirServer/bulkdata/storageProviders/<source>/user`|Y|Y|\n|`fhirServer/bulkdata/storageProviders/<source>/secretAccessKey`|Y|Y|\n\n## 5.2 Keystores, truststores, and the IBM FHIR server\n\n### 5.2.1 Background\nAs stated earlier, the FHIR server is installed with a default configuration in `server.xml` which includes the definition of a keystore (`fhirKeyStore.p12`) and a truststore (`fhirTrustStore.p12`)<sup id=\"a7\">[7](#f7)</sup>. These files are provided only as examples and while they may suffice in a test environment, the FHIR server deployer should generate a new keystore and truststore for any installations where security is a concern. Review the information in the following topics to learn how to configure a secure keystore and truststore.\n\n### 5.2.2 WebApp security\nBy default, the FHIR server REST API is only available via HTTPS on port 9443 and is protected by HTTP basic authentication.\nAlternatively, the server can use OpenID Connect and OAuth 2.0 via a Bearer Token as described in [Section 5.2.4 Oauth 2.0](#524-oauth-20).\nIn addition, the FHIR server web application can be secured via client certificate-based authentication.\n\nHere are some notes related to these authentication schemes:\n*   Basic authentication is a very simple authentication scheme and should only be used over HTTPS because the username and password are essentially transmitted in plain text.\n*   OAuth 2.0 authentication can only be used in conjunction with an HTTPS endpoint because the OAuth authorization steps rely on SSL handshake negotiations.\n*   Client certificate-based authentication can only be used in conjunction with an HTTPS endpoint since it involves SSL handshake negotiations. The main value of client authentication is that the server is able to securely authenticate the client through the use of certificates.\n\n### 5.2.3 Configuring mutual TLS authentication\nTo properly configure the FHIR server's keystore and truststore files, perform the following steps.\n\n### 5.2.3.1 Configure the keyStores\n1.  Create a new self-signed server certificate<sup id=\"a8\">[8](#f8)</sup> and store it in a new keystore file located in the `<WLP_HOME>/usr/servers/fhir-server/resources/security` directory.\n\n    In these instructions, we'll call this file `serverKeystore.jks`, although you can name your server keystore file anything you choose. We'll use the `keytool`<sup id=\"a9\">[9](#f9)</sup> command for all keystore- and truststore-related steps, although there are several ways to perform these actions.\n\n    The following command will generate a new self-signed certificate and store it in `serverKeystore.jks`:\n\n    ```\n    keytool -keystore serverKeystore.jks -storepass change-password -genkey\n        -alias default -keyalg RSA -keypass change-password\n    ```\n\n2.  Export the server certificate so that it can be imported into the client's truststore:\n\n    ```\n    keytool -keystore serverKeystore.jks -storepass change-password -export\n        -alias default -file server-public-key.cer\n    ```\n\n3.  Create the client's certificate and store it in `clientKeystore.jks`:\n\n    ```\n    keytool -keystore clientKeystore.jks -storepass change-password -genkey\n        -alias client-auth -keyalg RSA -keypass change-password\n    ```\n\n    Note: `keytool` will prompt you for the various components of the distinguished name (DN) associated with the certificate (similar to Step 1). The value that you specify for the common name (CN) component of the DN must match a username in the basic user registry<sup id=\"a10\">[10](#f10)</sup> configured within the `server.xml` file. This step is crucial for the client certificate-based authentication to work properly. The whole point of this authentication scheme is for the client to transmit its identity to the server via the client certificate, and the client's username must be contained in that certificate (the CN component of the DN) so that the FHIR server can properly authenticate the client.\n\n4.  Export the client's certificate so that it can be imported into the server's truststore:\n\n    ```\n    keytool -keystore clientKeystore.jks -storepass change-password -export -alias client-auth -file client-public-key.cer\n    ```\n\n5.  Import the server's public key certificate into the client's truststore:\n\n    ```\n    keytool -keystore clientTruststore.jks -storepass change-password -import -file server-public-key.cer\n    ```\n\n6.  Import the client's public key certificate into the server's truststore:\n\n    ```\n    keytool -keystore serverTruststore.jks -storepass change-password -import -file client-public-key.cer\n    ```\n\nAt this point, you should have a client keystore that contains a client certificate whose Distinguished Name's Common Name component is set to the username. You should also have a client truststore which contains the server's public key certificate. Essentially, the server and client both have a keystore that contains their own private and public key certificate and they both have a truststore which contains the public key certificate of their counterpart.\n\n### 5.2.3.1 Configure the server\nCopy the server keystore (`serverKeystore.jks`) and truststore (`serverTruststore.jks`) files to the appropriate directory (`<WLP_HOME>/usr/servers/fhir-server/resources/security`). Then configure the `server.xml` file correctly to reference your new keystore and truststore files.\n\n### 5.2.3.2 Configure the client\nThe precise steps required to configure certificate-based authentication for a client application depend on the specific REST API client framework, but these are the general rules:\n\n*   If the client is using the FHIR server's HTTPS endpoint, then the client's truststore should be configured with the certificate of the FHIR server<sup id=\"a11\">[11](#f11)</sup>.\n*   If the client is using basic authentication, then it must send an appropriate Authorization request header containing the username and password information in the HTTP request.\n*   If the client is using client certificate-based Authentication, then the client keystore must be configured with a certificate that is trusted by the FHIR server<sup id=\"a12\">[12](#f12)</sup>.\n*   If the client is using OAuth 2.0 Authentication, then the client keystore must be configured with the REST API client framework. In addition, it must send an appropriate Authorization request header containing the Bearer token in the HTTP request.\n\n## 5.3 OpenID Connect and OAuth 2.0\nThe FHIR specification recommends the use of OpenID Connect and OAuth 2.0.\nThe IBM FHIR Server supports these via either:\n* An external Authorization Server and/or Identity Provider like [IBM Cloud App ID](https://www.ibm.com/cloud/app-id) or [Keycloak](https://www.keycloak.org)\n* Liberty's own OpenID Connect and OAuth 2.0 support\n\nThe following sections focus on the latter and are adapted from the [WebSphere Liberty Knowledge Center](https://www.ibm.com/support/knowledgecenter/SSD28V_liberty/com.ibm.websphere.wlp.core.doc/ae/twlp_config_oidc_pc_examp_beginner.html), but the steps apply to OpenLiberty as well.\n\n### 5.3.1 Configure Liberty as the OpenID Connect Provider\nLiberty can be configured to act as an OpenID Connect Provider via the [openidConnectServer-1.0 feature](https://openliberty.io/docs/ref/feature/#openidConnectServer-1.0.html). To enable this feature without modifying the default `server.xml`, move the `oidcProvider.xml` config snippet on the installed FHIR Server from `<WLP_HOME>/usr/servers/fhir-server/configDropins/disabled/` to `<WLP_HOME>/usr/servers/fhir-server/configDropins/defaults/` and modify as desired.\n\nA copy of this snippet is provided here for illustrative purposes:\n```xml\n<featureManager>\n    <feature>openidConnectServer-1.0</feature>\n</featureManager>\n\n<openidConnectProvider id=\"oidc-provider\"\n    oauthProviderRef=\"oauth2-provider\"\n    keyStoreRef=\"defaultKeyStore\"\n    signatureAlgorithm=\"RS256\" />\n\n<oauth-roles>\n    <authenticated>\n        <special-subject type=\"ALL_AUTHENTICATED_USERS\" />\n    </authenticated>\n    <clientManager>\n        <group name=\"clientAdministrator\" />\n    </clientManager>\n</oauth-roles>\n\n<oauthProvider id=\"oauth2-provider\" oauthOnly=\"false\" allowPublicClients=\"true\" jwtAccessToken=\"true\">\n    <grantType>authorization_code</grantType>\n    <databaseStore dataSourceRef=\"OAuthDataSource\" schema=\"FHIR_OAUTH\" />\n</oauthProvider>\n\n<dataSource id=\"OAuthDataSource\" jndiName=\"jdbc/OAuth2DB\">\n    <properties.derby.embedded createDatabase=\"create\" databaseName=\"derby/oauth2db\" />\n    <jdbcDriver libraryRef=\"sharedLibDerby\" />\n</dataSource>\n```\n\n### 5.3.1.1 oidcProvider.xml snippet details\nOpenID Connect is built on OAuth 2.0 and so the `oidcProvider.xml` snippet configures Liberty as an OAuth 2.0 provider as described at [Defining OAuth](https://www.ibm.com/support/knowledgecenter/SSEQTP_liberty/com.ibm.websphere.wlp.doc/ae/twlp_oauth_defining.html).\n\nLiberty supports the registration of clients through either a localStore in the server.xml or a databaseStore in a configured dataSource.\nTo support \"dynamic client registration\", the snippet configures an oauthProvider databaseStore and a clientManager oauth-role for managing the OAuth 2.0 clients.\n\nAdditionally, the `fhir-persistence-schema` project (which is also used to deploy the main IBM FHIR Server schema) creates the tables required by this Liberty feature by default (as described at [OAuth Databases](https://www.ibm.com/support/knowledgecenter/SSD28V_liberty/com.ibm.websphere.wlp.core.doc/ae/twlp_oauth_dbs.html)).\n\nFinally, the `openidConnectProvider` element is specified with a default signatureAlgorithm of RS256 and a reference to the defaultKeyStore which must contain a private key that can be used for signing.\n\n### 5.3.1.2 Register a client\nNow that the server is configured as an OAuth 2.0 provider, clients can self-register by invoking the https://[host]:9443/oauth2/endpoint/oauth2-provider/registration endpoint.\n\nFor example, for a server running on localhost:\n```sh\ncurl -u 'fhiruser:change-password' 'https://localhost:9443/oauth2/endpoint/oauth2-provider/registration' \\\n--header 'Content-Type: application/json' \\\n--data-raw '{\n   \"token_endpoint_auth_method\":\"client_secret_basic\",\n   \"scope\":\"launch launch/patient offline_access openid profile user/*.* patient/*.*\",\n   \"grant_types\":[\n      \"authorization_code\",\n      \"client_credentials\",\n      \"implicit\",\n      \"refresh_token\",\n      \"urn:ietf:params:oauth:grant-type:jwt-bearer\"\n   ],\n   \"response_types\":[\n      \"code\",\n      \"token\",\n      \"id_token token\"\n   ],\n   \"application_type\":\"web\",\n   \"subject_type\":\"public\",\n   \"post_logout_redirect_uris\":[\n      \"http://localhost:4567/inferno/oauth2/static/redirect\"\n   ],\n   \"preauthorized_scope\":\"launch launch/patient offline_access openid profile user/*.* patient/*.*\",\n   \"introspect_tokens\":true,\n   \"trusted_uri_prefixes\":[\n      \"https://server.example.com:9000/trusted/\"\n   ],\n   \"redirect_uris\":[\n      \"http://localhost:4567/inferno/oauth2/static/redirect\"\n   ]\n}'\n```\n\nFor more information on Liberty's support for client registration, see https://www.ibm.com/support/knowledgecenter/SSEQTP_liberty/com.ibm.websphere.wlp.doc/ae/twlp_client_registration.html.\n\n### 5.3.1.3 Request an access token\nAfter you've registered a client, invoke the authorization endpoint with the client_id assigned to your client in order to obtain an authorization code that can be exchanged for an access token.\nFor a server running on localhost, the auth URL is `https://localhost:9443/oidc/endpoint/oidc-provider/authorize`.\n\nThe provider endpoint will present an HTML login form and you must enter a valid username/password from Liberty's configured user registry (e.g. `fhiruser`/`change-password`).\nThis will redirect you to the configured redirect uri for your client, passing it a code that can be exchanged for an access token at the token endpoint.\nFor a server running on localhost, the token URL is `https://localhost:9443/oidc/endpoint/oidc-provider/token`.\n\n### 5.3.2 Configure Liberty to be an Oauth 2.0 Protected Resource Server\nLiberty can be configured to act as an OAuth 2.0 Protected Resource Server via the [openidConnectClient-1.0 feature](https://openliberty.io/docs/ref/feature/#openidConnectClient-1.0.html). To enable this feature without modifying the default `server.xml`, move the `oauthResourceServer.xml` config snippet on the installed FHIR Server from `<WLP_HOME>/usr/servers/fhir-server/configDropins/disabled/` to `<WLP_HOME>/usr/servers/fhir-server/configDropins/defaults/` and modify as desired.\n\nA copy of this snippet is provided here for illustrative purposes:\n```xml\n<featureManager>\n    <feature>openidConnectClient-1.0</feature>\n</featureManager>\n\n<!-- Liberty acts as an OAuth 2.0 protected resource server when inboundPropagation=”required” -->\n<openidConnectClient id=\"RS\" inboundPropagation=\"required\"\n    trustStoreRef=\"defaultTrustStore\"\n    trustAliasName=\"libertyop\"\n    issuerIdentifier=\"https://localhost:9443/oauth2/endpoint/oauth2-provider,https://host.docker.internal:9443/oauth2/endpoint/oauth2-provider\"\n    validationEndpointUrl=\"https://localhost:9443/oauth2/endpoint/oauth2-provider/introspect\"\n    signatureAlgorithm=\"RS256\"\n    authFilterRef=\"filter\"/>\n\n<authFilter id=\"filter\">\n    <requestUrl urlPattern=\"/fhir-server\"/>\n</authFilter>\n```\n\n### 5.3.2.1 oauthResourceServer.xml snippet details\nBy default, the server is configured with a defaultTrustStore that includes a copy of the server's signed certificate with alias `libertyop` (\"op\" for OpenID Connect Provider).\n\nThe server is configured to accept tokens with an issuerIdentifier that has a hostname of either localhost or host.docker.internal so that we can test it from the [Inferno test tool's](https://github.com/onc-healthit/inferno) docker-compose environment.\n\nThe signatureAlgorithm must match the signature used by the OAuth provider and the authFilter is required when the server is also acting as both an OAuth Resource Server *and* an OAuth/OpenId Connect provider so that the OAuth endpoints themselves can be accessed to grant the access tokens needed for accessing the rest of the server endpoints.\n\n### 5.3.2.2 Configuring the trustStore\nIf you are using Liberty as both the openIdConnect server and the openIdConnect client and you have modified the defaultKeyStore to use a different key, you can configure the corresponding trustStore based on the following keytool commands:\n\n1. Export the OAuth 2.0 provider's certificate from the configured keystore via one of the following commands:\n* `keytool -exportcert -keystore key.p12 -storepass Password -alias default -file libertyOP.cer`\n* `keytool -exportcert -keystore key.jks -storepass Password -alias default -file libertyOP.cer`\n\n2. Import the certificate into the server's trustStore. Assuming you use the same keystore for both, then use of these:\n* `keytool -importcert -keystore key.p12 -storepass Password -alias libertyop -file libertyOP.cer -noprompt`\n* `keytool -importcert -keystore key.jks -storepass Password -alias libertyop -file libertyOP.cer -noprompt`\n\n### 5.3.3 Advertise the OAuth endpoints via fhir-server-config\nTo configure the FHIR Server to advertise the OpenID Connect and OAuth 2.0 endpoints of the providers, provide values for at least the following properties in the default fhir-server-config.json file:\n* `fhirServer/security/oauth/authUrl`\n* `fhirServer/security/oauth/tokenUrl`\n\nWhen the Liberty server is the OpenID Connect / OAuth 2.0 provider, use a placeholder of `<host>` in the property values to have the server automatically replace this text with the hostname used by requestors (see `fhirServer/core/originalRequestUriHeaderName`).\n\nThese values will be used to populate the corresponding entries in both the server capability statement (`GET [base]/metadata`) and the smart-configuration (`GET [base]/.well-known/smart-configuration`).\n\nFor example, the following excerpt from a CapabilityStatement shows sample OAuth-related URLs (register, authorize, and token) values in the `valueUri` elements.\n```\n…\n\"rest\": [\n    {\n      \"mode\": \"server\",\n      \"security\": {\n        \"extension\": [\n          {\n            \"url\": \"http://fhir-registry.smarthealthit.org/StructureDefinition/oauth-uris\"\n            \"extension\": [\n              {\n                \"url\": \"register\",\n                \"valueUri\": \"https://localhost:9443/oauth2/endpoint/oauth2-provider/registration\"\n              },\n              {\n                \"url\": \"authorize\",\n                \"valueUri\": \"https://localhost:9443/oauth2/endpoint/oauth2-provider/authorize\"\n              },\n              {\n                \"url\": \"token\",\n                \"valueUri\": \"https://localhost:9443/oauth2/endpoint/oauth2-provider/token\"\n              }\n            ]\n          }\n        ],\n…\n```\n\nSMART on FHIR applications should use the `.well-known/smart-configuration` endpoint to determine the OAuth URLs to use for authorization,\nbut the entries in the Capability Statement are needed for backwards compatibility.\n\n## 5.4 Custom HTTP Headers\nIBM FHIR Server Supports the following custom HTTP Headers:\n\n| Header Name      | Description                |\n|------------------|----------------------------|\n|`X-FHIR-TENANT-ID`|Specifies which tenant config should be used for the request. Default is `default`. The header name can be overridden via config property `fhirServer/core/tenantIdHeaderName`.|\n|`X-FHIR-DSID`|Specifies which datastore config should be used for the request. Default is `default`. The header name can be overridden via config property `fhirServer/core/dataSourceIdHeaderName`.|\n|`X-FHIR-FORWARDED-URL`|The original (user-facing) request URL; used for constructing absolute URLs within the server response. Only enabled when explicitly configured in the default fhir-server-config.json. If either the config property or the header itself is missing, the server will use the actual request URL. The header name can be overridden via config property `fhirServer/core/originalRequestUriHeaderName`.|\n\n# 6 Related topics\nFor more information about topics related to configuring a FHIR server, see the following documentation:\n*   [IBM Java 8 Keytool documentation](https://www.ibm.com/support/knowledgecenter/SSYKE2_8.0.0/com.ibm.java.security.component.80.doc/security-component/keytoolDocs/keytool_overview.html)\n*   [WebSphere Liberty documentation: Configuring your web application and server for client certificate authentication](https://www.ibm.com/support/knowledgecenter/SSEQTP_liberty/com.ibm.websphere.wlp.doc/ae/twlp_sec_clientcert.html)\n*   [Java EE 7 Tutorial, Chapter 50](https://docs.oracle.com/javaee/7/tutorial/security-advanced002.htm#GLIEN)\n*   [WebSphere Liberty documentation: Defining an OAuth Service Provider](https://www.ibm.com/support/knowledgecenter/SSEQTP_liberty/com.ibm.websphere.wlp.doc/ae/twlp_oauth_defining.html)\n*   [WebSphere Liberty documentation: Configuring an Open ID Connect Client in liberty](https://www.ibm.com/support/knowledgecenter/SSEQTP_liberty/com.ibm.websphere.wlp.doc/ae/twlp_config_oidc_rp.html)\n\n<hr/>\n\n- <b name=\"f1\">1</b>\n\n    The fhir-server-config.json file contains configuration information associated with the FHIR server. The global configuration is located in `WLP_HOME/wlp/usr/servers/fhir-server/config/default/fhir-server-config.json`, with tenant-specific configuration contained in `config/TENANT_ID/fhir-server-config.json`. [↩](#a1)\n\n- <b name=\"f2\">2</b>\n\n    When running database-related commands (e.g. createDB.sh, liquibase, etc.) you'll need to make sure that the Db2-related executables are in your PATH, and also that you are logged in as a user that has the necessary authority to create the database and/or create the schema.  Normally, if you log in as the Db2 administrative user (typically \"db2inst1\") then you should be fine. [↩](#a2)\n\n- <b id=\"f3\">3</b>\n\n    The names of these request headers are configurable within the FHIR server's fhir-server-config.json file.  For more information, see [Section 5.1 Configuration properties reference](#51-configuration-properties-reference). [↩](#a3)\n\n- <b id=\"f4\">4</b>\n\n    For more information on multi-tenant support, including multi-tenant configuration properties, jump to [Section 4.9 Multi-Tenancy](#49-multi-tenancy). [↩](#a4)\n\n- <b id=\"f5\">5</b>\n\n    An external reference is a reference to a resource which is meaningful outside a particular request bundle.  The value typically includes the resource type and the resource identifier, and could  be an absolute or relative URL. Examples:  `https://fhirserver1:9443/fhir-server/api/v4/Patient/12345`, `Patient/12345`, etc. [↩](#a5)\n\n- <b id=\"f6\">6</b>\n\n    A local reference is a reference used within a request bundle that refers to another resource within the same request bundle and is meaningful only within that request bundle. A local reference starts with `urn:`. [↩](#a6)\n\n- <b id=\"f7\">7</b>\n\n    Keystore and truststore files have the same basic structure. They both provide a secure means for storing certificates. Typically, we think of a keystore as a file that contains certificates that consist of a private/public key pair, whereas a truststore contains certificates that consist of a public key or trusted certificates. [↩](#a7)\n\n- <b id=\"f8\">8</b>\n\n    While the instructions here show examples of creating self-signed certificates, in reality the FHIR Server deployer will likely need to use certificates that have been signed by a Certificate Authority (CA) such as Verisign, etc. [↩](#a8)\n\n- <b id=\"f9\">9</b>\n\n    The _keytool_ command is provided as part of the Java 8 JRE.  The command can be found in $JAVA_HOME/jre/bin. [↩](#a9)\n\n- <b id=\"f10\">10</b> These instructions assume the use of a basic user registry in the server.xml file.  If you are instead using an LDAP registry, then the entire DN associated with the client certificate must match the DN of a user in the LDAP registry. [↩](#a10)\n\n- <b id=\"f11\">11</b>\n\n    For the JAX-RS 2.0 Client API, you would call the ClientBuilder.truststore() method. [↩](#a11)\n\n- <b id=\"f12\">12</b>\n\n    For the JAX-RS 2.0 Client API, you would call the ClientBuilder.keystore() method. [↩](#a12)\n\n[a]:https://www.ibm.com/support/knowledgecenter/en/SSD28V_9.0.0/com.ibm.websphere.wlp.core.doc/ae/cwlp_pwd_encrypt.html\n\n<hr/>\n\nFHIR&reg; is the registered trademark of HL7 and is used with the permission of HL7.\n","fileAbsolutePath":"/home/runner/work/FHIR/FHIR/fhir/docs/src/pages/guides/FHIRServerUsersGuide.md","fields":{"slug":"/guides/FHIRServerUsersGuide"}}}},"staticQueryHashes":["1364590287","2102389209","2102389209","227138135","227138135","2456312558","2746626797","2746626797","3018647132","3018647132","3906363820","3906363820","768070550"]}